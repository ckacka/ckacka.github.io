<!DOCTYPE html>
<html>
<head>
    <title>æ˜¯å¥³äººå°±æ‰‡ä»–ä¸€ç™¾è€³å…‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ä¼˜åŒ–åçš„CSS */
        /* ç¦æ­¢é•¿æŒ‰èœå•å’Œæ–‡æœ¬é€‰æ‹© */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden; /* é˜²æ­¢æ»šåŠ¨æ¡é—ªçƒ */
        }

        /* æ€§èƒ½ä¼˜åŒ–åŠ¨ç”» */
        .blink { 
            animation: blink 1s infinite;
            will-change: opacity;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            color: white;
            touch-action: manipulation; /* ä¼˜åŒ–ç§»åŠ¨ç«¯è§¦æ‘¸ */
        }

        .game-header {
            text-align: center;
            margin-bottom: 20px;
            will-change: transform;
        }

        #healthBar {
            width: 90%;
            max-width: 400px;
            height: 25px;
            background-color: #333;
            border-radius: 15px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
            backface-visibility: hidden;
        }

        #health {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            transform: translateZ(0); /* å¯ç”¨GPUåŠ é€Ÿ */
        }

        #targetImage {
            width: 90%;
            max-width: 400px;
            height: auto;
            aspect-ratio: 1/1;
            cursor: pointer;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            background: #444;
            transform: translateZ(0);
            image-rendering: -webkit-optimize-contrast;
        }

        .hit-effect {
            animation: hitShake 0.3s ease, redFlash 0.2s linear;
        }

        @keyframes hitShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-3px); }
        }

        @keyframes redFlash {
            50% { background-color: rgba(255,0,0,0.3); }
        }

        #restartBtn {
            margin-top: 25px;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: none;
            transition: 0.3s all;
            touch-action: manipulation;
        }

        #status {
            font-size: 1.2em;
            margin: 10px 0;
            color: #ffd700;
            will-change: contents;
        }

        .regenerate {
            animation: regenerateGlow 1s infinite;
        }

        @keyframes regenerateGlow {
            50% { box-shadow: 0 0 20px #00ff00; }
        }

        .damage-number {
            position: absolute;
            font-size: 1.5em;
            color: #ff4444;
            animation: floatUp 1s ease-out;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            will-change: transform, opacity;
        }

        @keyframes floatUp {
            100% { transform: translateY(-50px); opacity: 0; }
        }

        @media (max-width: 600px) {
            #healthBar { height: 20px; }
            #restartBtn { padding: 12px 25px; }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1>æ˜¯å¥³äººå°±æ‰‡ä»–ä¸€ç™¾è€³å…‰</h1>
        <div id="status">ç‚¹å‡»æ¸£ç”·å¼€å§‹æ¸¸æˆï¼</div>
    </div>
    <div id="healthBar">
        <div id="health"></div>
    </div>
    <img id="targetImage" src="https://ckacka.github.io/IMG_20250308_002400.png" alt="æ¸£ç”·">
    <button id="restartBtn">å†æ¥ä¸€å±€</button>

    <audio id="bgMusic" loop>
        <source src="https://ckacka.github.io/bgm.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSound">
        <source src="https://ckacka.github.io/shan.mp3" type="audio/mp3">
    </audio>
    <audio id="healSound">
        <source src="https://ckacka.github.io/heal.mp3" type="audio/mp3">
    </audio>

    <script>
        (function() {
            // æ€§èƒ½ä¼˜åŒ–å˜é‡
            let lastFrameTime = performance.now();
            const damageNumbers = new Set();
            const hitSoundPool = Array(5).fill().map(() => new Audio('https://ckacka.github.io/shan.mp3'));
            let currentHitSound = 0;
            
            // æ¸¸æˆçŠ¶æ€å˜é‡
            let gameTimer;
            let regenerateTimer;
            let currentHealth = 200;
            let timeLeft = 15;
            let score = 0;
            let combo = 0;
            let lastHitTime = 0;
            let isPlaying = false;
            let isRegenerating = false;
            let audioEnabled = false;

            // DOMç¼“å­˜
            const elements = {
                health: document.getElementById('health'),
                targetImage: document.getElementById('targetImage'),
                restartBtn: document.getElementById('restartBtn'),
                status: document.getElementById('status'),
                healthBar: document.getElementById('healthBar'),
                bgMusic: document.getElementById('bgMusic'),
                healSound: document.getElementById('healSound')
            };

            // éŸ³é¢‘åˆå§‹åŒ–
            function initAudio() {
                if (!audioEnabled) {
                    audioEnabled = true;
                    elements.bgMusic.volume = 0.5;
                    elements.healSound.volume = 0.7;
                }
            }

            // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–åŠ¨ç”»
            function updateGame(timestamp) {
                const deltaTime = timestamp - lastFrameTime;
                lastFrameTime = timestamp;

                // æ›´æ–°ä¼¤å®³æ•°å­—
                damageNumbers.forEach(num => {
                    num.element.style.top = `${num.y -= deltaTime * 0.05}px`;
                    num.element.style.opacity = num.opacity -= deltaTime * 0.002;
                });

                requestAnimationFrame(updateGame);
            }

            // ä¼˜åŒ–åçš„ä¼¤å®³æ•°å­—åˆ›å»º
            function createDamageNumber(x, y, damage) {
                const num = document.createElement('div');
                num.className = 'damage-number';
                num.textContent = `-${damage}`;
                Object.assign(num.style, {
                    left: `${x}px`,
                    top: `${y}px`,
                    opacity: 1
                });
                document.body.appendChild(num);
                
                damageNumbers.add({
                    element: num,
                    y: y,
                    opacity: 1
                });

                setTimeout(() => {
                    num.remove();
                    damageNumbers.delete(num);
                }, 1000);
            }

            // æ¸¸æˆåˆå§‹åŒ–
            function initGame() {
                cancelAnimationFrame(updateGame);
                clearInterval(gameTimer);
                clearInterval(regenerateTimer);
                
                currentHealth = 200;
                timeLeft = 15;
                score = 0;
                combo = 0;
                isPlaying = false;
                isRegenerating = false;
                
                elements.health.style.width = '100%';
                elements.health.style.background = 'linear-gradient(90deg, #4CAF50, #45a049)';
                elements.targetImage.classList.remove('regenerate', 'hit-effect');
                elements.targetImage.style.cursor = 'pointer';
                elements.restartBtn.style.display = 'none';
                elements.status.textContent = 'ç‚¹å‡»æ€ªç‰©å¼€å§‹æ¸¸æˆï¼';
                elements.healthBar.style.display = 'none';
                
                elements.bgMusic.pause();
                elements.bgMusic.currentTime = 0;
            }

            // æ¸¸æˆå¯åŠ¨
            function startGame() {
                if(isPlaying) return;
                
                isPlaying = true;
                elements.healthBar.style.display = 'block';
                elements.status.textContent = `å‰©ä½™æ—¶é—´: ${timeLeft}s | å¾—åˆ†: ${score}`;
                
                // å¤„ç†éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾
                initAudio();
                elements.bgMusic.play().catch(() => {});

                // ç²¾ç¡®çš„æ—¶é—´ç®¡ç†
                let lastUpdate = Date.now();
                gameTimer = setInterval(() => {
                    const now = Date.now();
                    timeLeft = Math.max(0, timeLeft - (now - lastUpdate)/1000);
                    lastUpdate = now;
                    elements.status.textContent = `å‰©ä½™æ—¶é—´: ${Math.round(timeLeft)}s | å¾—åˆ†: ${score}`;
                    if(timeLeft <= 0) endGame(false);
                }, 100);

                requestAnimationFrame(updateGame);
            }

            // ç‚¹å‡»å¤„ç†
            function handleClick(e) {
                if(!isPlaying) {
                    initGame();
                    startGame();
                    return;
                }

                const now = Date.now();
                if (now - lastHitTime < 50) return;

                // ä¼˜åŒ–éŸ³é¢‘æ’­æ”¾
                hitSoundPool[currentHitSound].play();
                currentHitSound = (currentHitSound + 1) % hitSoundPool.length;

                // ä¼˜åŒ–åŠ¨ç”»
                elements.targetImage.classList.add('hit-effect');
                setTimeout(() => elements.targetImage.classList.remove('hit-effect'), 300);

                // æ¸¸æˆé€»è¾‘
                currentHealth = Math.max(0, currentHealth - 5);
                elements.health.style.width = `${currentHealth / 2}%`;

                // è¿å‡»ç³»ç»Ÿ
                combo = (now - lastHitTime < 1000) ? combo + 1 : 1;
                lastHitTime = now;
                score += combo * 10;

                createDamageNumber(e.clientX, e.clientY, 5);

                // æŒ¯åŠ¨ä¼˜åŒ–
                navigator.vibrate?.(30);

                // è¡€é‡ç®¡ç†
                if (currentHealth <= 50 && !isRegenerating) {
                    startRegeneration();
                }

                if(currentHealth === 0) endGame(true);
            }

            // å†ç”Ÿç³»ç»Ÿ
            function startRegeneration() {
                isRegenerating = true;
                elements.targetImage.classList.add('regenerate');
                elements.healSound.play();

                regenerateTimer = setInterval(() => {
                    if(currentHealth >= 200 || !isPlaying) return stopRegeneration();
                    
                    currentHealth = Math.min(200, currentHealth + 4);
                    elements.health.style.width = `${currentHealth / 2}%`;
                }, 1000);
            }

            function stopRegeneration() {
                clearInterval(regenerateTimer);
                isRegenerating = false;
                elements.targetImage.classList.remove('regenerate');
            }

            // æ¸¸æˆç»“æŸ
            function endGame(isWin) {
                clearInterval(gameTimer);
                stopRegeneration();
                isPlaying = false;
                elements.targetImage.style.filter = 'grayscale(1) blur(2px)';
                elements.restartBtn.style.display = 'block';
                elements.bgMusic.pause();
                
                requestAnimationFrame(() => {
                    alert(`${isWin ? 'ğŸ‰ æ­å–œè·èƒœï¼' : 'ğŸ˜­ æ¸¸æˆç»“æŸï¼'}\nå‰©ä½™æ—¶é—´: ${Math.round(timeLeft)}s\næœ€ç»ˆå¾—åˆ†: ${score}`);
                });
            }

            // äº‹ä»¶ç›‘å¬
            elements.targetImage.addEventListener('click', handleClick, {passive: true});
            elements.restartBtn.addEventListener('click', initGame);

            // é¢„åŠ è½½èµ„æº
            window.addEventListener('load', () => {
                elements.bgMusic.load();
                elements.healSound.load();
            });

            initGame();
        })();
    </script>
</body>
</html>
