<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#6750A4">
    <link rel="manifest" href="manifest.json">
    <title>树洞工具箱</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- Material Design 3 Color Tokens (Light) --- */
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            
            --md-sys-color-secondary: #625B71;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;

            --md-sys-color-surface: #FDF8FD;
            --md-sys-color-surface-container-low: #F7F2FA;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #C4C7C5;

            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;

            /* --- 样式变量 --- */
            --radius-full: 9999px;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
            
            --transition-standard: 0.3s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        [data-theme="dark"] {
            /* --- Material Design 3 Color Tokens (Dark) --- */
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            
            --md-sys-color-secondary: #CCC2DC;
            --md-sys-color-secondary-container: #4A4458;
            --md-sys-color-on-secondary-container: #E8DEF8;

            --md-sys-color-surface: #141218;
            --md-sys-color-surface-container-low: #1D1B20;
            --md-sys-color-surface-container: #211F26;
            --md-sys-color-surface-container-high: #2B2930;
            
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #444746;
            
            --md-sys-color-error: #F2B8B5;
            --md-sys-color-on-error: #601410;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Roboto', 'PingFang SC', system-ui, sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-bottom: 100px; /* 为底部导航留空 */
            min-height: 100vh;
        }

        /* Material Symbols 设置 */
        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            display: inline-block;
            vertical-align: middle;
        }
        .material-symbols-rounded.filled { font-variation-settings: 'FILL' 1; }

        /* --- 通用容器 --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
            width: 100%;
        }

        /* --- 顶部栏 (App Bar) --- */
        .app-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: rgba(var(--md-sys-color-surface), 0.8); /* 若不支持rgba变量，JS会处理背景色 */
            background-color: var(--md-sys-color-surface); /* Fallback */
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            transition: box-shadow var(--transition-standard), background-color var(--transition-standard);
        }

        .app-bar.scrolled {
            background-color: var(--md-sys-color-surface-container);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .app-bar-title {
            font-size: 22px;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--md-sys-color-on-surface-variant);
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        /* 仅在支持悬停的设备上应用 Hover 效果，优化移动端体验 */
        @media (hover: hover) {
            .icon-btn:hover { background-color: rgba(128, 128, 128, 0.1); color: var(--md-sys-color-on-surface); }
            .chip:hover { background-color: rgba(128,128,128, 0.08); }
            .tool-card:hover { transform: translateY(-4px); background-color: var(--md-sys-color-surface-container); }
        }

        /* --- 搜索与筛选 --- */
        .filters-section {
            padding: 8px 0 16px;
            position: sticky;
            top: 64px;
            z-index: 900;
            background-color: var(--md-sys-color-surface);
            transition: background-color var(--transition-standard);
        }
        
        .app-bar.scrolled ~ .page-content .filters-section {
             background-color: var(--md-sys-color-surface-container);
        }

        .search-bar {
            display: flex; align-items: center;
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: var(--radius-full);
            padding: 0 16px;
            height: 56px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1; border: none; background: none;
            font-size: 16px; color: var(--md-sys-color-on-surface);
            height: 100%; outline: none; margin-left: 12px;
        }
        
        .search-icon { color: var(--md-sys-color-on-surface-variant); }

        .category-scroll {
            display: flex; gap: 8px;
            overflow-x: auto; padding-bottom: 4px;
            scrollbar-width: none;
        }
        .category-scroll::-webkit-scrollbar { display: none; }

        .chip {
            background-color: transparent;
            border: 1px solid var(--md-sys-color-outline);
            color: var(--md-sys-color-on-surface-variant);
            border-radius: 8px;
            padding: 6px 16px;
            font-size: 14px; font-weight: 500;
            cursor: pointer; white-space: nowrap;
            transition: all 0.2s;
        }

        .chip.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-color: transparent;
        }

        /* --- 工具卡片网格 --- */
        .section-title {
            font-size: 20px; font-weight: 500;
            margin: 24px 0 16px; padding: 0 4px;
            color: var(--md-sys-color-on-surface);
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        @media (min-width: 600px) {
            .tools-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 24px;
            }
        }

        .tool-card {
            position: relative;
            background-color: var(--md-sys-color-surface-container-low);
            border-radius: var(--radius-md);
            padding: 24px 16px;
            display: flex; flex-direction: column; align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            user-select: none;
        }

        .tool-card:active { transform: scale(0.98); }

        .tool-icon {
            font-size: 32px; margin-bottom: 12px;
            color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-primary-container);
            width: 56px; height: 56px;
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .tool-icon span { font-size: 28px; color: var(--md-sys-color-on-primary-container); }

        .tool-name { font-size: 16px; font-weight: 500; margin-bottom: 4px; color: var(--md-sys-color-on-surface); }
        .tool-desc { font-size: 12px; color: var(--md-sys-color-on-surface-variant); opacity: 0.8; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .favorite-btn {
            position: absolute; top: 8px; right: 8px;
            background: none; border: none;
            color: var(--md-sys-color-outline);
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 2; cursor: pointer;
        }
        
        .favorite-btn.favorited { color: var(--md-sys-color-error); }
        .favorite-btn.favorited span { font-variation-settings: 'FILL' 1; }

        /* --- 发现页卡片 --- */
        .discover-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }

        .collapse-card {
            background-color: var(--md-sys-color-surface-container-low);
            border-radius: var(--radius-md);
            overflow: hidden; margin-bottom: 16px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .collapse-card.expanded {
            background-color: var(--md-sys-color-surface-container);
            border-color: var(--md-sys-color-outline-variant);
        }

        .collapse-card-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 20px; cursor: pointer; user-select: none;
        }

        .collapse-card-title {
            font-size: 16px; font-weight: 500;
            display: flex; align-items: center; gap: 12px;
            color: var(--md-sys-color-on-surface);
            flex: 1;
        }
        
        .collapse-actions {
            display: flex; align-items: center; gap: 4px;
        }

        .collapse-card-content {
            display: none; padding: 0;
            position: relative;
            background-color: var(--md-sys-color-surface);
        }
        
        .collapse-card.expanded .collapse-card-content {
            display: block;
            animation: slideDown 0.3s ease;
            height: 500px; /* 固定高度确保体验一致 */
        }

        @keyframes slideDown {
            from { opacity: 0; height: 0; }
            to { opacity: 1; height: 500px; }
        }

        .webview-container {
            width: 100%; height: 100%;
            border: none;
            background-color: #fff;
        }
        
        .loading-spinner {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: var(--md-sys-color-primary);
            z-index: 0;
        }

        /* --- 个人中心 --- */
        .profile-header {
            display: flex; flex-direction: column; align-items: center;
            padding: 40px 0 32px;
            background-color: var(--md-sys-color-surface-container-low);
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            margin-bottom: 24px; margin-top: -64px; padding-top: 88px;
        }

        .profile-avatar {
            width: 96px; height: 96px;
            border-radius: 50%;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 16px;
        }

        .profile-menu { list-style: none; }
        .profile-menu-item {
            display: flex; align-items: center;
            padding: 16px; margin-bottom: 8px;
            background-color: var(--md-sys-color-surface-container-low);
            border-radius: 12px; cursor: pointer;
        }
        
        .switch {
            position: relative; display: inline-block; width: 52px; height: 32px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--md-sys-color-outline-variant);
            border: 2px solid var(--md-sys-color-outline);
            border-radius: 32px; transition: .3s;
        }
        .slider:before {
            position: absolute; content: "";
            height: 16px; width: 16px;
            left: 6px; bottom: 6px;
            background-color: var(--md-sys-color-outline);
            border-radius: 50%; transition: .3s;
        }
        input:checked + .slider {
            background-color: var(--md-sys-color-primary);
            border-color: var(--md-sys-color-primary);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: var(--md-sys-color-on-primary);
            width: 20px; height: 20px; left: 4px; bottom: 4px;
        }

        /* --- 底部导航 --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 80px;
            background-color: var(--md-sys-color-surface-container);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        @media (min-width: 800px) {
            .bottom-nav {
                max-width: 400px; left: 50%; transform: translateX(-50%);
                bottom: 24px; border-radius: var(--radius-full);
                height: 72px; padding-bottom: 0;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            }
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; text-decoration: none;
            color: var(--md-sys-color-on-surface-variant);
            flex: 1; height: 100%; cursor: pointer;
        }

        .nav-icon-container {
            width: 64px; height: 32px;
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 4px;
            transition: background-color 0.2s;
        }

        .nav-item.active .nav-icon-container { background-color: var(--md-sys-color-secondary-container); }
        .nav-item.active .nav-icon-container span {
            color: var(--md-sys-color-on-secondary-container);
            font-variation-settings: 'FILL' 1;
        }
        .nav-item.active .nav-label { color: var(--md-sys-color-on-surface); font-weight: 700; }
        .nav-label { font-size: 12px; font-weight: 500; }

        /* --- 页面切换动画 --- */
        .page-content { display: none; animation: fadeIn 0.25s ease-out; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 模态框 --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 2000;
            align-items: center; justify-content: center; padding: 16px;
            backdrop-filter: blur(4px);
        }
        .modal.show { display: flex; animation: fadeModal 0.2s; }
        @keyframes fadeModal { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background-color: var(--md-sys-color-surface-container);
            border-radius: 28px; width: 100%; max-width: 400px;
            max-height: 85vh; display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .modal-header { padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 0 24px 24px; overflow-y: auto; }
        
        .form-input {
            width: 100%; padding: 14px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 8px; background: transparent;
            color: var(--md-sys-color-on-surface);
            margin-bottom: 16px; font-family: inherit;
        }
        .form-input:focus { border-color: var(--md-sys-color-primary); outline: none; border-width: 2px; padding: 13px 15px; }

        .btn {
            height: 40px; padding: 0 24px; border-radius: 20px;
            font-weight: 500; border: none; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-family: inherit; font-size: 14px;
        }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-text { background: none; color: var(--md-sys-color-primary); }
        .btn-outline { background: transparent; border: 1px solid var(--md-sys-color-outline); color: var(--md-sys-color-primary); }

        /* --- 列表管理样式 --- */
        .card-item {
            display: flex; align-items: center; padding: 12px;
            background-color: var(--md-sys-color-surface);
            margin-bottom: 8px; border-radius: 12px;
        }
        .card-item-content { flex: 1; padding: 0 12px; overflow: hidden; }
        .card-item-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-item-url { font-size: 11px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .order-actions { display: flex; flex-direction: column; }
        .mini-btn { background: none; border: none; color: var(--md-sys-color-on-surface-variant); padding: 2px; }

        /* --- PWA 安装提示样式 --- */
        .pwa-install-prompt {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1100;
            max-width: 90%;
            width: 400px;
            display: none;
        }
        
        .pwa-install-prompt.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .pwa-install-prompt .prompt-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .pwa-install-prompt .prompt-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .pwa-install-prompt .prompt-icon {
            color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-primary-container);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pwa-install-prompt .prompt-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .pwa-install-prompt .btn {
            flex: 1;
        }
    </style>
</head>
<body>

    <header class="app-bar" id="appBar">
        <h1 class="app-bar-title">树洞工具箱</h1>
        <button class="icon-btn" id="themeToggle" aria-label="切换主题">
            <span class="material-symbols-rounded" id="themeIcon">dark_mode</span>
        </button>
    </header>

    <div class="page-content active" id="homePage">
        <div class="filters-section">
            <div class="container">
                <div class="search-bar">
                    <span class="material-symbols-rounded search-icon">search</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="搜索工具...">
                </div>
                <div class="category-scroll" id="categoryFilters"></div>
            </div>
        </div>

        <div class="container">
            <h2 class="section-title" id="homeTitle">常用工具</h2>
            <div class="tools-grid" id="toolsGrid"></div>
        </div>
    </div>

    <div class="page-content" id="discoverPage">
        <div class="container" style="padding-top: 16px;">
            <div class="discover-header">
                <h2 class="section-title" style="margin: 0;">发现</h2>
                <button class="btn btn-outline" id="discoverSettingsBtn">
                    <span class="material-symbols-rounded">tune</span>
                    管理
                </button>
            </div>
            <div id="discoverCards"></div>
        </div>
    </div>

    <div class="page-content" id="profilePage">
        <div class="profile-header">
            <div class="profile-avatar">
                <span class="material-symbols-rounded" style="font-size: 48px;">person</span>
            </div>
            <div class="profile-info">
                <h2>欢迎使用</h2>
                <center>版本号：v3.0</center>
            </div>
        </div>
        
        <div class="container">
            <h2 class="section-title">我的收藏</h2>
            <div class="tools-grid" id="favoritesGrid"></div>
            
            <h2 class="section-title">设置</h2>
            <ul class="profile-menu">
                <li class="profile-menu-item" id="themeSettingRow">
                    <span class="material-symbols-rounded" style="color: var(--md-sys-color-primary); margin-right: 16px;">palette</span>
                    <div style="flex: 1;">
                        <h3>深色模式</h3>
                        <p style="font-size: 12px; opacity: 0.7;">跟随系统或手动切换</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="themeSwitch">
                        <span class="slider"></span>
                    </label>
                </li>
                <li class="profile-menu-item" id="pwaInstallOption">
                    <span class="material-symbols-rounded" style="color: var(--md-sys-color-primary); margin-right: 16px;">install_desktop</span>
                    <div style="flex: 1;">
                        <h3>安装应用</h3>
                        <p style="font-size: 12px; opacity: 0.7;" id="pwaStatusText">将应用安装到设备</p>
                    </div>
                    <button class="btn btn-outline" id="installPwaBtn" style="padding: 6px 12px; font-size: 12px;">安装</button>
                </li>
                <li class="profile-menu-item" id="aboutOption">
                    <span class="material-symbols-rounded" style="color: var(--md-sys-color-primary); margin-right: 16px;">info</span>
                    <div style="flex: 1;">
                        <h3>关于应用</h3>
                        <p style="font-size: 12px; opacity: 0.7;">查看版本信息</p>
                    </div>
                    <span class="material-symbols-rounded" style="color: var(--md-sys-color-outline)">chevron_right</span>
                </li>
            </ul>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-page="homePage">
            <div class="nav-icon-container"><span class="material-symbols-rounded">home</span></div>
            <span class="nav-label">首页</span>
        </a>
        <a href="#" class="nav-item" data-page="discoverPage">
            <div class="nav-icon-container"><span class="material-symbols-rounded">explore</span></div>
            <span class="nav-label">发现</span>
        </a>
        <a href="#" class="nav-item" data-page="profilePage">
            <div class="nav-icon-container"><span class="material-symbols-rounded">person</span></div>
            <span class="nav-label">我的</span>
        </a>
    </nav>

    <div class="pwa-install-prompt" id="pwaInstallPrompt">
        <div class="prompt-content">
            <div class="prompt-header">
                <div class="prompt-icon">
                    <span class="material-symbols-rounded">install_desktop</span>
                </div>
                <div>
                    <h3 style="margin: 0;">安装应用</h3>
                    <p style="margin: 4px 0 0; font-size: 14px; opacity: 0.7;">将树洞工具箱安装到您的设备</p>
                </div>
            </div>
            <div class="prompt-actions">
                <button class="btn btn-text" id="pwaPromptCancel">取消</button>
                <button class="btn btn-primary" id="pwaPromptInstall">安装</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">卡片管理</h3>
                <button class="icon-btn" id="closeSettings"><span class="material-symbols-rounded">close</span></button>
            </div>
            <div class="modal-body">
                <div style="display:flex; border-bottom: 1px solid var(--md-sys-color-outline-variant); margin-bottom: 20px;">
                    <button class="btn btn-text" id="tabAdd" style="flex:1; border-bottom: 2px solid var(--md-sys-color-primary); border-radius: 0;">新增</button>
                    <button class="btn btn-text" id="tabManage" style="flex:1; color: var(--md-sys-color-on-surface-variant); border-radius: 0;">列表</button>
                </div>

                <div id="viewAdd">
                    <input type="hidden" id="editCardId">
                    <label style="display:block; margin-bottom:8px; font-weight:500">标题</label>
                    <input type="text" class="form-input" id="cardTitle" placeholder="例如：每日新闻">
                    
                    <label style="display:block; margin-bottom:8px; font-weight:500">链接 URL</label>
                    <input type="url" class="form-input" id="cardUrl" placeholder="https://...">
                    
                    <label style="display:block; margin-bottom:8px; font-weight:500">图标 (Material Symbol)</label>
                    <input type="text" class="form-input" id="cardIcon" placeholder="选填，默认显示地球图标 (public)">
                    
                    <button class="btn btn-primary" id="saveCardBtn" style="width:100%">保存卡片</button>
                    <button class="btn btn-text" id="cancelEditBtn" style="width:100%; display:none; margin-top:8px;">取消编辑</button>
                </div>

                <div id="viewManage" style="display:none;">
                    <div id="cardsManagerList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="aboutModal">
        <div class="modal-content" style="max-width: 320px;">
            <div class="modal-header">
                <h3 class="modal-title">关于</h3>
            </div>
            <div class="modal-body">
                <p>树洞工具箱 v3.0</p>
                <p style="margin-top: 10px; opacity: 0.7; font-size: 14px;">基于 Material Design 3 设计规范构建。</p>
            </div>
            <div style="padding: 16px 24px; text-align: right;">
                <button class="btn btn-text" id="closeAbout">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // --- 数据源 ---
        // 首页工具列表 (已根据用户需求修改)
        const toolsData = [
            { id: 1, name: "妙笔生花", desc: "AI 辅助的文本创作工具", icon: "edit_note", category: "AI", url: "https://ckacka.github.io/tools/mbsh.html" },
            { id: 2, name: "菜谱助手", desc: "智能菜谱生成与查询", icon: "restaurant_menu", category: "AI", url: "https://ckacka.github.io/tools/aifood.html" },
            { id: 3, name: "是女人就扇他一百耳光", desc: "休闲小游戏", icon: "sports_esports", category: "游戏", url: "https://ckacka.github.io/games/guaiwu.html" },
            { id: 4, name: "二维码生成器", desc: "快速生成二维码", icon: "qr_code", category: "二维码", url: "https://ckacka.github.io/tools/qrcode.html" },
            { id: 5, name: "商务候车区查询", desc: "查询铁路商务候车区", icon: "train", category: "铁路", url: "https://ckacka.github.io/tools/railwayswz.html" },
            { id: 6, name: "铁路温馨服务", desc: "铁路相关服务查询", icon: "luggage", category: "铁路", url: "https://ckacka.github.io/tools/railwaywxfw.html" },
            { id: 7, name: "树洞便签", desc: "清爽的记事便签", icon: "note", category: "文字", url: "https://ckacka.github.io/tools/sdnote.html" },
            { id: 8, name: "随机生词", desc: "随机生成词汇", icon: "sort_by_alpha", category: "文字", url: "https://ckacka.github.io/tools/sjsc.html" },
            { id: 9, name: "南苑台配", desc: "音视频播放与服务", icon: "live_tv", category: "音视频", url: "https://ckacka.github.io/tools/southparktw.html" },
            { id: 10, name: "数字电视", desc: "在线数字电视与广播", icon: "tv", category: "音视频", url: "https://ckacka.github.io/tools/tvradio.html" },
            { id: 11, name: "视频播放器", desc: "在线视频播放", icon: "movie", category: "音视频", url: "https://ckacka.github.io/tools/videoplayer.html" },
            { id: 12, name: "域名检测", desc: "检测网站域名", icon: "assessment", category: "网站", url: "https://ckacka.github.io/tools/ymtest.html" }

        ];

        // 发现页默认卡片列表
        const defaultCards = [
            { id: 101, title: "计算器", url: "https://tool.browser.qq.com/calculator?addressbar=hide&callfrom=gongjuxiang", icon: "calculate", expanded: false },
            { id: 102, title: "新闻资讯", url: "https://hot.browser.miui.com/v7/#status=open&cate=%E6%8E%A8%E8%8D%90", icon: "newspaper", expanded: false },
            { id: 103, title: "每天认识一种文物", url: "https://ysxwyzl.4dage.com/4dwall/index.html", icon: "museum", expanded: false }
        ];

        // --- 状态与缓存 ---
        const state = {
            favorites: JSON.parse(localStorage.getItem('favs') || '[]'),
            discoverCards: JSON.parse(localStorage.getItem('cards') || JSON.stringify(defaultCards)),
            filterCategory: '全部',
            searchText: '',
            pwaInstallPromptShown: false,
            deferredPrompt: null,
            isPwaInstalled: false
        };

        const dom = {
            appBar: document.getElementById('appBar'),
            homeTitle: document.getElementById('homeTitle'),
            toolsGrid: document.getElementById('toolsGrid'),
            catFilters: document.getElementById('categoryFilters'),
            discoverCards: document.getElementById('discoverCards'),
            cardsManagerList: document.getElementById('cardsManagerList'),
            favoritesGrid: document.getElementById('favoritesGrid'),
            pwaInstallPrompt: document.getElementById('pwaInstallPrompt'),
            pwaStatusText: document.getElementById('pwaStatusText'),
            installPwaBtn: document.getElementById('installPwaBtn'),
            pwaPromptInstall: document.getElementById('pwaPromptInstall'),
            pwaPromptCancel: document.getElementById('pwaPromptCancel'),
            inputs: {
                title: document.getElementById('cardTitle'),
                url: document.getElementById('cardUrl'),
                icon: document.getElementById('cardIcon'),
                id: document.getElementById('editCardId')
            }
        };

        // --- PWA 功能 ---
        function initPwa() {
            // 检测是否已安装
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                state.isPwaInstalled = true;
                updatePwaStatus();
                return;
            }
            
            // 监听 beforeinstallprompt 事件
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.deferredPrompt = e;
                updatePwaStatus();
            });
            
            // 检测是否已安装（其他方法）
            window.addEventListener('appinstalled', () => {
                state.isPwaInstalled = true;
                state.deferredPrompt = null;
                updatePwaStatus();
            });
            
            // 初始化安装按钮
            dom.installPwaBtn.addEventListener('click', handlePwaInstall);
            dom.pwaPromptInstall.addEventListener('click', handlePwaInstall);
            dom.pwaPromptCancel.addEventListener('click', () => {
                dom.pwaInstallPrompt.classList.remove('show');
            });
            
            // 更新PWA状态显示
            updatePwaStatus();
        }
        
        function updatePwaStatus() {
            if (state.isPwaInstalled) {
                dom.pwaStatusText.textContent = '应用已安装';
                dom.installPwaBtn.textContent = '已安装';
                dom.installPwaBtn.disabled = true;
                dom.installPwaBtn.style.opacity = '0.5';
                dom.installPwaBtn.onclick = null;
                dom.pwaInstallPrompt.classList.remove('show');
            } else if (state.deferredPrompt) {
                dom.pwaStatusText.textContent = '可安装到设备';
                dom.installPwaBtn.textContent = '安装';
                dom.installPwaBtn.disabled = false;
                dom.installPwaBtn.style.opacity = '1';
                
                // 自动显示安装提示（仅在首次）
                if (!state.pwaInstallPromptShown) {
                    setTimeout(() => {
                        dom.pwaInstallPrompt.classList.add('show');
                        state.pwaInstallPromptShown = true;
                    }, 3000);
                }
            } else {
                dom.pwaStatusText.textContent = '浏览器不支持安装';
                dom.installPwaBtn.textContent = '不支持';
                dom.installPwaBtn.disabled = true;
                dom.installPwaBtn.style.opacity = '0.5';
            }
        }
        
        function handlePwaInstall() {
            if (state.deferredPrompt) {
                // 隐藏任何可见的安装提示，以免重复点击
                dom.pwaInstallPrompt.classList.remove('show');

                state.deferredPrompt.prompt();
                
                state.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        state.isPwaInstalled = true;
                    }
                    state.deferredPrompt = null;
                    updatePwaStatus();
                });
            } else {
                alert('您的浏览器不支持PWA安装功能，或应用已安装。');
            }
        }

        // --- 核心逻辑 ---

        function saveState() {
            localStorage.setItem('favs', JSON.stringify(state.favorites));
            localStorage.setItem('cards', JSON.stringify(state.discoverCards));
        }

        // 首页渲染
        function renderHome() {
            // 1. 更新标题文字：实现"切换分类时改变文字"的需求
            dom.homeTitle.textContent = state.filterCategory === '全部' 
                ? '所有工具' 
                : `${state.filterCategory} 工具`;

            // 2. 渲染 Chips
            const cats = ['全部', ...new Set(toolsData.map(t => t.category))];
            dom.catFilters.innerHTML = cats.map(c => 
                `<button class="chip ${state.filterCategory === c ? 'active' : ''}" onclick="setCategory('${c}')">${c}</button>`
            ).join('');

            // 3. 渲染工具网格
            renderTools(dom.toolsGrid, toolsData);
        }

        function renderTools(targetGrid, sourceData, isFavMode = false) {
            targetGrid.innerHTML = '';
            const filtered = sourceData.filter(t => {
                if (isFavMode) return true;
                const matchCat = state.filterCategory === '全部' || t.category === state.filterCategory;
                const matchText = t.name.toLowerCase().includes(state.searchText) || t.desc.toLowerCase().includes(state.searchText);
                return matchCat && matchText;
            });

            if (filtered.length === 0) {
                targetGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--md-sys-color-outline);">未找到相关内容</div>`;
                return;
            }

            filtered.forEach(tool => {
                const isFav = state.favorites.includes(tool.id);
                const el = document.createElement('div');
                el.className = 'tool-card';
                el.innerHTML = `
                    <button class="favorite-btn ${isFav ? 'favorited' : ''}" onclick="toggleFav(event, ${tool.id})">
                        <span class="material-symbols-rounded">${isFav ? 'favorite' : 'favorite'}</span>
                    </button>
                    <div class="tool-icon"><span class="material-symbols-rounded">${tool.icon}</span></div>
                    <div class="tool-name">${tool.name}</div>
                    <div class="tool-desc">${tool.desc}</div>
                `;
                // 点击工具卡片在新窗口打开链接
                el.onclick = (e) => { 
                    if(!e.target.closest('.favorite-btn')) {
                        if (tool.url) {
                            window.open(tool.url, '_blank');
                        } else {
                            alert(`工具 ${tool.name} 缺少链接信息。`);
                        }
                    }
                };
                targetGrid.appendChild(el);
            });
        }

        // 发现页渲染
        function renderDiscover() {
            dom.discoverCards.innerHTML = '';
            // 如果用户清空了发现卡片，使用默认卡片列表重新初始化
            if(state.discoverCards.length === 0) {
                // 仅在本地存储为空时使用 defaultCards，否则显示无卡片提示
                if (localStorage.getItem('cards') === null) {
                    state.discoverCards = defaultCards;
                    saveState();
                } else {
                    dom.discoverCards.innerHTML = '<div style="text-align:center; padding:40px; color:var(--md-sys-color-outline);">暂无卡片，请点击右上角管理</div>';
                    return;
                }
            }

            state.discoverCards.forEach(card => {
                const el = document.createElement('div');
                el.className = `collapse-card ${card.expanded ? 'expanded' : ''}`;
                
                // 解决Iframe无法加载问题：在Header添加一个外部跳转按钮
                el.innerHTML = `
                    <div class="collapse-card-header">
                        <div class="collapse-card-title">
                            <span class="material-symbols-rounded collapse-card-icon" style="color:var(--md-sys-color-primary)">${card.icon}</span>
                            ${card.title}
                        </div>
                        <div class="collapse-actions">
                            <button class="icon-btn" onclick="openExternal(event, '${card.url}')" title="在浏览器打开">
                                <span class="material-symbols-rounded" style="font-size:20px;">open_in_new</span>
                            </button>
                            <span class="material-symbols-rounded" style="transition:transform 0.3s; transform: rotate(${card.expanded ? 180 : 0}deg)">expand_more</span>
                        </div>
                    </div>
                    <div class="collapse-card-content">
                        ${card.expanded ? `
                            <div class="loading-spinner"><span class="material-symbols-rounded" style="animation:spin 1s linear infinite">progress_activity</span></div>
                            <iframe class="webview-container" src="${card.url}" onload="this.previousElementSibling.style.display='none'"></iframe>
                        ` : ''}
                    </div>
                `;
                
                el.querySelector('.collapse-card-header').onclick = (e) => {
                    if(e.target.closest('.icon-btn')) return; // 防止点击按钮触发折叠
                    card.expanded = !card.expanded;
                    saveState();
                    renderDiscover();
                };
                dom.discoverCards.appendChild(el);
            });
        }

        // --- 全局交互函数 ---

        window.setCategory = (cat) => {
            state.filterCategory = cat;
            renderHome();
        };

        window.toggleFav = (e, id) => {
            e.stopPropagation();
            if (state.favorites.includes(id)) {
                state.favorites = state.favorites.filter(fid => fid !== id);
            } else {
                state.favorites.push(id);
            }
            saveState();
            renderHome();
            renderFavorites();
        };

        window.openExternal = (e, url) => {
            e.stopPropagation();
            window.open(url, '_blank');
        };

        function renderFavorites() {
            renderTools(dom.favoritesGrid, toolsData.filter(t => state.favorites.includes(t.id)), true);
        }

        // --- 管理列表与设置逻辑 ---

        function renderManagerList() {
            dom.cardsManagerList.innerHTML = '';
            state.discoverCards.forEach((card, index) => {
                const item = document.createElement('div');
                item.className = 'card-item';
                item.innerHTML = `
                    <div class="order-actions">
                        <button class="mini-btn" onclick="moveCard(${index}, -1)" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}>
                            <span class="material-symbols-rounded">keyboard_arrow_up</span>
                        </button>
                        <button class="mini-btn" onclick="moveCard(${index}, 1)" ${index === state.discoverCards.length - 1 ? 'disabled style="opacity:0.3"' : ''}>
                            <span class="material-symbols-rounded">keyboard_arrow_down</span>
                        </button>
                    </div>
                    <div class="card-item-content">
                        <div class="card-item-title">${card.title}</div>
                        <div class="card-item-url">${card.url}</div>
                    </div>
                    <div>
                        <button class="icon-btn" onclick="editCard(${card.id})" style="width:32px; height:32px;"><span class="material-symbols-rounded" style="font-size:18px">edit</span></button>
                        <button class="icon-btn" onclick="deleteCard(${card.id})" style="width:32px; height:32px; color:var(--md-sys-color-error)"><span class="material-symbols-rounded" style="font-size:18px">delete</span></button>
                    </div>
                `;
                dom.cardsManagerList.appendChild(item);
            });
        }

        window.moveCard = (index, dir) => {
            const temp = state.discoverCards[index];
            state.discoverCards[index] = state.discoverCards[index + dir];
            state.discoverCards[index + dir] = temp;
            saveState(); renderManagerList(); renderDiscover();
        };

        window.deleteCard = (id) => {
            if(confirm('确定删除此卡片吗？')) {
                state.discoverCards = state.discoverCards.filter(c => c.id !== id);
                saveState(); renderManagerList(); renderDiscover();
            }
        };

        window.editCard = (id) => {
            const card = state.discoverCards.find(c => c.id === id);
            if(card) {
                dom.inputs.title.value = card.title;
                dom.inputs.url.value = card.url;
                dom.inputs.icon.value = card.icon;
                dom.inputs.id.value = card.id;
                switchTab('add');
                document.getElementById('saveCardBtn').innerText = "更新卡片";
                document.getElementById('cancelEditBtn').style.display = 'inline-flex';
            }
        };

        // --- 初始化与事件监听 ---

        function init() {
            // 初始化PWA功能
            initPwa();

            // PWA Service Worker 注册 (新增)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js')
                        .then(registration => {
                            console.log('SW registered: ', registration);
                        })
                        .catch(registrationError => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
            
            // 主题处理
            const themeToggle = () => {
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                document.body.setAttribute('data-theme', isDark ? '' : 'dark');
                document.getElementById('themeIcon').innerText = isDark ? 'dark_mode' : 'light_mode';
                document.getElementById('themeSwitch').checked = !isDark;
                localStorage.setItem('theme', isDark ? 'light' : 'dark');
            };
            
            if(localStorage.getItem('theme') === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').innerText = 'light_mode';
                document.getElementById('themeSwitch').checked = true;
            }

            document.getElementById('themeToggle').onclick = themeToggle;
            document.getElementById('themeSwitch').onchange = themeToggle;

            // 搜索
            document.getElementById('searchInput').oninput = (e) => {
                state.searchText = e.target.value.toLowerCase().trim();
                renderHome();
            };

            // 导航切换
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.onclick = (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    nav.classList.add('active');
                    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
                    document.getElementById(nav.dataset.page).classList.add('active');
                    window.scrollTo(0,0);
                    if(nav.dataset.page === 'profilePage') renderFavorites();
                };
            });

            // 滚动监听
            window.addEventListener('scroll', () => {
                dom.appBar.classList.toggle('scrolled', window.scrollY > 10);
            });

            // 模态框逻辑
            const toggleModal = (id, show) => document.getElementById(id).classList.toggle('show', show);
            
            document.getElementById('discoverSettingsBtn').onclick = () => {
                toggleModal('settingsModal', true);
                switchTab('add'); resetForm();
            };
            document.getElementById('closeSettings').onclick = () => toggleModal('settingsModal', false);
            document.getElementById('aboutOption').onclick = () => toggleModal('aboutModal', true);
            document.getElementById('closeAbout').onclick = () => toggleModal('aboutModal', false);
            
            // 点击遮罩关闭
            window.onclick = (e) => {
                if(e.target.classList.contains('modal')) e.target.classList.remove('show');
            };

            // Tab 切换
            document.getElementById('tabAdd').onclick = () => switchTab('add');
            document.getElementById('tabManage').onclick = () => switchTab('manage');
            
            // 保存卡片逻辑（包含非必填图标处理）
            document.getElementById('saveCardBtn').onclick = () => {
                const title = dom.inputs.title.value.trim();
                const url = dom.inputs.url.value.trim();
                // 需求实现：图标不是必填项，默认使用 public
                const icon = dom.inputs.icon.value.trim() || 'public';
                const id = dom.inputs.id.value;

                if(!title || !url) { alert('请输入标题和链接'); return; }

                if(id) {
                    const idx = state.discoverCards.findIndex(c => c.id == id);
                    if(idx > -1) state.discoverCards[idx] = { ...state.discoverCards[idx], title, url, icon };
                } else {
                    state.discoverCards.push({ id: Date.now(), title, url, icon, expanded: false });
                }
                
                saveState(); renderDiscover(); resetForm();
                switchTab('manage');
            };
            
            document.getElementById('cancelEditBtn').onclick = resetForm;

            // 初始渲染
            renderHome();
            renderDiscover();
        }

        function switchTab(tab) {
            const isAdd = tab === 'add';
            document.getElementById('viewAdd').style.display = isAdd ? 'block' : 'none';
            document.getElementById('viewManage').style.display = isAdd ? 'none' : 'block';
            
            const activeStyle = 'border-bottom: 2px solid var(--md-sys-color-primary); color: var(--md-sys-color-primary);';
            const inactiveStyle = 'border-bottom: none; color: var(--md-sys-color-on-surface-variant);';
            
            document.getElementById('tabAdd').style.cssText = `flex:1; border-radius:0; ${isAdd ? activeStyle : inactiveStyle}`;
            document.getElementById('tabManage').style.cssText = `flex:1; border-radius:0; ${!isAdd ? activeStyle : inactiveStyle}`;
            
            if(!isAdd) renderManagerList();
        }

        function resetForm() {
            dom.inputs.title.value = ''; dom.inputs.url.value = ''; dom.inputs.icon.value = ''; dom.inputs.id.value = '';
            document.getElementById('saveCardBtn').innerText = "保存卡片";
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        // 旋转动画css
        const styleSheet = document.createElement("style");
        styleSheet.innerText = "@keyframes spin { 100% { transform:rotate(360deg); } }";
        document.head.appendChild(styleSheet);

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
