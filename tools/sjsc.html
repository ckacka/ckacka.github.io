<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <meta name="color-scheme" content="light dark">
    <title>随机生词</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/t/wx_fed/weui-source/res/2.6.25/weui.min.css"/>
    
    <style>
        /* --- 基础布局修正 --- */
        :root {
            --weui-BG-0: #ededed;
            --weui-BG-1: #ffffff;
            --weui-BG-2: #ffffff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --weui-BG-0: #111111;
                --weui-BG-1: #1e1e1e;
                --weui-BG-2: #1e1e1e;
            }
        }

        body {
            background-color: var(--weui-BG-0);
            color: var(--weui-FG-0);
            font-family: -apple-system-font, Helvetica Neue, sans-serif;
            transition: background-color 0.3s ease;
        }

        .page {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }

        /* --- 顶部导航栏 --- */
        .weui-navigation-bar {
            background-color: var(--weui-BG-2);
            position: sticky;
            top: 0;
            z-index: 500;
            padding-top: env(safe-area-inset-top);
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 0 0 var(--weui-FG-3); /* 分割线 */
        }
        
        .weui-navigation-bar__center {
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }

        .weui-navigation-bar__left {
            position: absolute;
            left: 16px;
            font-size: 14px;
            color: var(--weui-FG-1);
        }

        /* --- 图片卡片区域 --- */
        .image-card {
            background-color: var(--weui-BG-2);
            margin-bottom: 8px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        .captcha-wrapper {
            width: 100%;
            height: 180px; /* 固定高度防止抖动 */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--weui-BG-2);
            position: relative;
            overflow: hidden;
        }

        .captcha-image {
            width: 100%;
            height: 100%;
            object-fit: contain; /* 保持比例撑满容器 */
            transition: opacity 0.3s;
        }

        /* 倒计时角标 */
        .timer-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            color: #fff;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-variant-numeric: tabular-nums; /* 防止数字跳动 */
        }

        /* 进度条 */
        .progress-line {
            height: 3px;
            background: var(--weui-BG-0);
            width: 100%;
        }
        .progress-inner {
            height: 100%;
            background: var(--weui-BRAND);
            width: 0%;
            transition: width 0.1s linear;
        }

        /* --- 列表与输入框 --- */
        .weui-cells {
            margin-top: 0 !important; /* 去除默认上间距 */
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        .input-icon {
            width: 24px;
            height: 24px;
            display: block;
            margin-right: 16px;
            /* 使用蒙版变色，适配暗黑模式 */
            background-color: var(--weui-FG-1);
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7'%3E%3C/path%3E%3Cpath d='M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z'%3E%3C/path%3E%3C/svg%3E") no-repeat center;
            -webkit-mask-size: contain;
        }

        .settings-icon {
            width: 24px;
            height: 24px;
            display: block;
            margin-right: 16px;
            background-color: var(--weui-FG-1);
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cpolyline points='12 6 12 12 16 14'%3E%3C/polyline%3E%3C/svg%3E") no-repeat center;
            -webkit-mask-size: contain;
        }

        /* --- 底部操作栏 --- */
        .action-area {
            padding: 32px 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .footer-copyright {
            margin-top: auto;
            text-align: center;
            color: var(--weui-FG-2);
            font-size: 12px;
            padding-bottom: 20px;
        }

    </style>
</head>
<body data-weui-theme="light">

    <div class="page">
        <div class="weui-navigation-bar">
            <div class="weui-navigation-bar__center">
                <span>随机生词</span>
            </div>
            <div class="weui-navigation-bar__right">
                <i class="weui-loading" id="topLoading" style="display: none;"></i>
            </div>
        </div>

        <div class="image-card">
            <div class="captcha-wrapper" onclick="refreshCaptcha()">
                <img id="captchaImage" class="captcha-image" src="" alt="点击刷新">
                <div class="timer-badge">
                    <span id="intervalDisplay">10</span>s 后刷新
                </div>
            </div>
            <div class="progress-line">
                <div id="progressFill" class="progress-inner"></div>
            </div>
        </div>

        <div class="weui-cells">
            <div class="weui-cell">
                <div class="weui-cell__hd">
                    <i class="input-icon"></i>
                </div>
                <div class="weui-cell__bd">
                    <input id="captchaInput" class="weui-input" type="text" placeholder="输入看到的生词">
                </div>
                <div class="weui-cell__ft">
                    <a href="javascript:" class="weui-btn weui-btn_mini weui-btn_primary" style="padding: 4px 12px; font-size: 13px;" onclick="copyText()">复制</a>
                </div>
            </div>

            <div class="weui-cell weui-cell_access" onclick="toggleActionSheet(true)">
                <div class="weui-cell__hd">
                    <i class="settings-icon"></i>
                </div>
                <div class="weui-cell__bd">
                    <p>自动刷新频率</p>
                </div>
                <div class="weui-cell__ft" id="currentIntervalText">10秒</div>
            </div>
        </div>

        <div class="action-area">
             <a href="javascript:" class="weui-btn weui-btn_default" onclick="refreshCaptcha()">手动刷新</a>
             
             <div class="footer-copyright">
                 随机生词<br>版本 2.0.01
             </div>
        </div>
    </div>

    <div class="weui-mask" id="iosMask" style="display: none"></div>
    <div class="weui-actionsheet" id="iosActionsheet">
        <div class="weui-actionsheet__title">
            <p class="weui-actionsheet__title-text">设置刷新间隔</p>
        </div>
        <div class="weui-actionsheet__menu">
            <div class="weui-actionsheet__cell" onclick="setRefreshInterval(10)">10秒</div>
            <div class="weui-actionsheet__cell" onclick="setRefreshInterval(30)">30秒</div>
            <div class="weui-actionsheet__cell" onclick="setRefreshInterval(60)">60秒</div>
            <div class="weui-actionsheet__cell" style="color: var(--weui-RED)" onclick="setRefreshInterval(999999)">暂停自动刷新</div>
        </div>
        <div class="weui-actionsheet__action">
            <div class="weui-actionsheet__cell" onclick="toggleActionSheet(false)">取消</div>
        </div>
    </div>

    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-success-no-circle weui-icon_toast"></i>
            <p class="weui-toast__content">已复制</p>
        </div>
    </div>

    <script>
        // --- 核心配置 ---
        const config = {
            imageUrl: 'https://fankui.sogou.com/index.php/web/uc/vcode?tag=',
            refreshInterval: parseInt(localStorage.getItem('refreshInterval')) || 10000
        };

        let timer = null;
        let animationFrame = null;
        let startTime = 0;

        // --- DOM 元素 ---
        const el = {
            html: document.documentElement,
            img: document.getElementById('captchaImage'),
            progress: document.getElementById('progressFill'),
            timerText: document.getElementById('intervalDisplay'),
            input: document.getElementById('captchaInput'),
            intervalText: document.getElementById('currentIntervalText'),
            toast: document.getElementById('toast'),
            loading: document.getElementById('topLoading'),
            // ActionSheet
            mask: document.getElementById('iosMask'),
            sheet: document.getElementById('iosActionsheet')
        };

        // --- 初始化 ---
        function init() {
            initTheme(); // 立即执行主题检测
            updateIntervalText(config.refreshInterval);
            refreshCaptcha();
            
            // 监听系统主题变化
            window.matchMedia('(prefers-color-scheme: dark)').addListener(initTheme);
        }

        // --- 修复暗黑模式 ---
        function initTheme() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            // 关键：同时设置 HTML 标签和 Body 标签，确保兼容性
            const theme = isDark ? 'dark' : 'light';
            el.html.setAttribute('data-weui-theme', theme);
            document.body.setAttribute('data-weui-theme', theme);
        }

        // --- 计时器逻辑 ---
        function startTimer() {
            if (config.refreshInterval > 900000) return; 

            startTime = Date.now();
            
            function tick() {
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, config.refreshInterval - elapsed);
                
                // 进度条
                const percent = (elapsed / config.refreshInterval) * 100;
                el.progress.style.width = `${Math.min(percent, 100)}%`;
                
                // 倒计时文字
                el.timerText.textContent = Math.ceil(remaining / 1000);

                if (elapsed >= config.refreshInterval) {
                    refreshCaptcha();
                } else {
                    animationFrame = requestAnimationFrame(tick);
                }
            }
            
            cancelAnimationFrame(animationFrame);
            animationFrame = requestAnimationFrame(tick);
        }

        function refreshCaptcha() {
            // UI 状态
            el.loading.style.display = 'block'; // 顶部显示loading
            el.img.style.opacity = '0.5';
            
            // 加载新图
            const newSrc = `${config.imageUrl}${Math.random()}`;
            // 预加载对象
            const tempImg = new Image();
            tempImg.onload = () => {
                el.img.src = newSrc;
                el.img.style.opacity = '1';
                el.loading.style.display = 'none';
            };
            tempImg.src = newSrc;

            // 重置输入
            el.input.value = '';

            // 重置计时
            cancelAnimationFrame(animationFrame);
            el.progress.style.width = '0%';
            
            if (config.refreshInterval < 900000) {
                startTimer();
            } else {
                el.timerText.textContent = '∞';
            }
        }

        // --- 菜单交互 ---
        function toggleActionSheet(show) {
            const display = show ? 'block' : 'none';
            const opacity = show ? '1' : '0';
            const method = show ? 'add' : 'remove';

            if(show) {
                el.mask.style.display = 'block';
                el.sheet.style.display = 'block'; // 确保display block后添加class
                // 强制重绘
                el.sheet.offsetHeight; 
                el.sheet.classList.add('weui-actionsheet_toggle');
                el.mask.style.opacity = '1';
            } else {
                el.sheet.classList.remove('weui-actionsheet_toggle');
                el.mask.style.opacity = '0';
                setTimeout(() => {
                    el.mask.style.display = 'none';
                    el.sheet.style.display = 'none';
                }, 300);
            }
        }

        function setRefreshInterval(seconds) {
            const ms = seconds === 999999 ? 999999000 : seconds * 1000;
            config.refreshInterval = ms;
            localStorage.setItem('refreshInterval', ms);
            updateIntervalText(ms);
            toggleActionSheet(false);
            refreshCaptcha(); 
        }

        function updateIntervalText(ms) {
            if (ms > 900000) {
                el.intervalText.textContent = '已暂停';
                el.intervalText.style.color = 'var(--weui-RED)';
                el.timerText.textContent = '∞';
            } else {
                el.intervalText.textContent = `${ms / 1000}秒`;
                el.intervalText.style.color = 'var(--weui-FG-1)';
            }
        }

        // --- 复制功能 ---
        function copyText() {
            el.input.select();
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(el.input.value || '').then(showToast);
            } else {
                document.execCommand('copy');
                showToast();
            }
        }

        function showToast() {
            el.toast.style.display = 'block';
            setTimeout(() => {
                el.toast.classList.add('weui-animate-fade-out');
                setTimeout(() => {
                    el.toast.style.display = 'none';
                    el.toast.classList.remove('weui-animate-fade-out');
                }, 200);
            }, 1000);
        }

        // 启动
        window.onload = init;

    </script>
</body>
</html>
