<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>视频播放器</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/t/wx_fed/weui-source/res/2.6.25/weui.min.css"/>
    <style>
        /* --- 全局样式 --- */
        body, html {
            height: 100%;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 这里的背景色和文字颜色已经使用了 WeUI 变量，会自动适配 */
        body {
            background-color: var(--weui-BG-0);
            color: var(--weui-FG-0);
        }

        /* --- 视频容器 (16:9) --- */
        .video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000; /* 视频背景始终由黑色保持沉浸感 */
        }
        .video-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* --- 诊断组件优化 (关键修改) --- */
        .diagnostic-dialog {
            max-height: 85vh !important;
            height: 85vh !important;
            display: flex;
            flex-direction: column;
            /* 弹窗整体背景也跟随主题 */
            background-color: var(--weui-BG-2); 
        }

        .diagnostic-body {
            padding: 0 !important;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* [修改点]：之前是 #fff，现在改为跟随主题的背景色 */
            background-color: var(--weui-BG-2); 
        }

        iframe.full-frame {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
            /* 防止 iframe 加载前闪白 */
            background-color: transparent; 
        }

        /* 错误提示条 */
        .weui-toptips { display: none; }
    </style>
</head>
<body data-weui-theme="light">

    <div class="weui-toptips weui-toptips_warn" id="topTips">错误提示</div>

    <div class="page">
        <div class="weui-panel weui-panel_access">
            <div class="weui-panel__hd">视频播放器</div>
            <div class="weui-panel__bd">
                <div class="weui-media-box weui-media-box_text" style="padding: 0;">
                    <div class="video-wrapper">
                        <video id="myVideo" class="video-content" controls playsinline webkit-playsinline x5-video-player-type="h5-page">
                            <source src="https://ckacka.github.io/djs.mp4" type="video/mp4">
                        </video>
                    </div>
                </div>
            </div>
        </div>

        <div class="weui-cells__title">视频源设置</div>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell weui-cell_active">
                <div class="weui-cell__hd"><label class="weui-label">视频地址</label></div>
                <div class="weui-cell__bd">
                    <input id="urlInput" class="weui-input" type="url" placeholder="输入 mp4/m3u8 地址"/>
                </div>
                <div class="weui-cell__ft">
                    <button class="weui-btn_reset weui-btn_icon" id="clearBtn">
                        <i class="weui-icon-clear"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="weui-btn-area">
            <a href="javascript:" class="weui-btn weui-btn_primary" id="btnLoad">加载播放</a>
            <a href="javascript:" class="weui-btn weui-btn_default" id="btnMore">更多选项</a>
        </div>
    </div>

    <div id="loadingToast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-loading weui-icon_toast"></i>
            <p class="weui-toast__content">加载中</p>
        </div>
    </div>

    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-success-no-circle weui-icon_toast"></i>
            <p class="weui-toast__content" id="toastMsg">已完成</p>
        </div>
    </div>

    <div class="js_dialog" id="iosDialog" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title" id="dialogTitle">标题</strong></div>
            <div class="weui-dialog__bd" id="dialogContent">内容</div>
            <div class="weui-dialog__ft">
                <a href="javascript:" class="weui-dialog__btn weui-dialog__btn_default" id="dialogCancel">取消</a>
                <a href="javascript:" class="weui-dialog__btn weui-dialog__btn_primary" id="dialogConfirm">确定</a>
            </div>
        </div>
    </div>

    <div class="weui-mask" id="asMask" style="display: none; opacity: 0; transition: opacity .3s;"></div>
    <div class="weui-actionsheet" id="asMenu">
        <div class="weui-actionsheet__title">
            <p class="weui-actionsheet__title-text">更多选项</p>
        </div>
        <div class="weui-actionsheet__menu">
            <div class="weui-actionsheet__cell" id="menuDiag">疑难诊断工具</div>
            <div class="weui-actionsheet__cell weui-actionsheet__cell_warn" id="menuReset">重置播放器</div>
        </div>
        <div class="weui-actionsheet__action">
            <div class="weui-actionsheet__cell" id="menuCancel">取消</div>
        </div>
    </div>

    <div class="js_dialog" id="diagnosticDialog" style="display: none;">
        <div class="weui-mask" id="diagMask"></div>
        <div class="weui-half-screen-dialog diagnostic-dialog" style="transition: transform .3s; transform: translateY(100%);">
            <div class="weui-half-screen-dialog__hd">
                <div class="weui-half-screen-dialog__hd__side" id="diagCloseBtn">
                    <button class="weui-icon-btn">关闭<i class="weui-icon-close-thin"></i></button>
                </div>
                <div class="weui-half-screen-dialog__hd__main">
                    <strong class="weui-half-screen-dialog__title">播放器诊断工具</strong>
                </div>
            </div>
            <div class="weui-half-screen-dialog__bd diagnostic-body">
                <iframe id="diagFrame" class="full-frame" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // 1. 初始化 DOM 查询简写
        const $ = (sel) => document.querySelector(sel);
        
        // 2. 核心：深色模式适配逻辑
        // 监听系统的颜色偏好
        const themeMedia = window.matchMedia("(prefers-color-scheme: dark)");
        
        // 设置主题函数：切换 body 上的 data-weui-theme 属性
        const setTheme = (isDark) => {
            document.body.setAttribute('data-weui-theme', isDark ? 'dark' : 'light');
        };

        // 初始化时执行一次
        setTheme(themeMedia.matches);

        // 监听变化（当用户在系统设置里切换模式时自动响应）
        themeMedia.addEventListener('change', e => setTheme(e.matches));

        // --- 以下为业务逻辑 (保持不变) ---
        const DEFAULT_VIDEO = "https://ckacka.github.io/djs.mp4";
        const DIAG_URL = "https://video.aliyuncs.com/player-detection/index.html?";

        const els = {
            video: $('#myVideo'),
            input: $('#urlInput'),
            topTips: $('#topTips'),
            loading: $('#loadingToast'),
            toast: $('#toast'),
            dialog: $('#iosDialog'),
            asMask: $('#asMask'),
            asMenu: $('#asMenu'),
            diagDialog: $('#diagnosticDialog'),
            diagInner: $('.weui-half-screen-dialog'),
            diagFrame: $('#diagFrame')
        };

        function loadVideo() {
            const url = els.input.value.trim();
            if (!url) { showTopTips('请输入视频地址'); return; }
            if (!/^https?:\/\/.+/.test(url)) { showTopTips('请输入以 http｜https 开头的有效地址'); return; }

            toggleLoading(true);
            setTimeout(() => {
                els.video.src = url;
                els.video.load();
                const playPromise = els.video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        toggleLoading(false);
                        showToast('开始播放');
                    }).catch(error => {
                        toggleLoading(false);
                        console.error(error);
                        showDialog('加载失败', '无法播放，请检查地址有效性或跨域限制。');
                    });
                }
            }, 500);
        }

        function resetPlayer() {
            hideActionSheet();
            showDialog('重置确认', '确定恢复到默认演示视频？', true, () => {
                els.video.src = DEFAULT_VIDEO;
                els.video.load();
                els.input.value = '';
                showToast('已重置');
            });
        }

        function openDiagnostic() {
            hideActionSheet();
            if (els.diagFrame.src === 'about:blank') {
                toggleLoading(true);
                els.diagFrame.src = DIAG_URL;
                els.diagFrame.onload = () => toggleLoading(false);
            }
            els.diagDialog.style.display = 'block';
            els.diagInner.offsetHeight; 
            els.diagInner.style.transform = 'translateY(0)';
        }

        function closeDiagnostic() {
            els.diagInner.style.transform = 'translateY(100%)';
            setTimeout(() => els.diagDialog.style.display = 'none', 300);
        }

        function showTopTips(msg) {
            els.topTips.innerText = msg;
            els.topTips.style.display = 'block';
            setTimeout(() => els.topTips.style.display = 'none', 2000);
        }

        function toggleLoading(show) { els.loading.style.display = show ? 'block' : 'none'; }
        
        function showToast(msg) {
            $('#toastMsg').innerText = msg;
            els.toast.style.display = 'block';
            setTimeout(() => els.toast.style.display = 'none', 1500);
        }

        function showDialog(title, content, showCancel, onConfirm) {
            $('#dialogTitle').innerText = title;
            $('#dialogContent').innerText = content;
            const $cancel = $('#dialogCancel');
            const $confirm = $('#dialogConfirm');
            $cancel.style.display = showCancel ? 'block' : 'none';
            
            const newConfirm = $confirm.cloneNode(true);
            $confirm.parentNode.replaceChild(newConfirm, $confirm);
            const newCancel = $cancel.cloneNode(true);
            $cancel.parentNode.replaceChild(newCancel, $cancel);

            newCancel.addEventListener('click', () => els.dialog.style.display = 'none');
            newConfirm.addEventListener('click', () => {
                els.dialog.style.display = 'none';
                if(onConfirm) onConfirm();
            });
            els.dialog.style.display = 'block';
        }

        function showActionSheet() {
            els.asMask.style.display = 'block';
            requestAnimationFrame(() => {
                els.asMask.style.opacity = 1;
                els.asMenu.classList.add('weui-actionsheet_toggle');
            });
        }

        function hideActionSheet() {
            els.asMask.style.opacity = 0;
            els.asMenu.classList.remove('weui-actionsheet_toggle');
            setTimeout(() => els.asMask.style.display = 'none', 300);
        }

        $('#btnLoad').addEventListener('click', loadVideo);
        $('#clearBtn').addEventListener('click', () => els.input.value = '');
        $('#btnMore').addEventListener('click', showActionSheet);
        els.asMask.addEventListener('click', hideActionSheet);
        $('#menuCancel').addEventListener('click', hideActionSheet);
        $('#menuDiag').addEventListener('click', openDiagnostic);
        $('#menuReset').addEventListener('click', resetPlayer);
        $('#diagMask').addEventListener('click', closeDiagnostic);
        $('#diagCloseBtn').addEventListener('click', closeDiagnostic);
    </script>
</body>
</html>
