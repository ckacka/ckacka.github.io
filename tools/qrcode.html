<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>二维码生成器</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.3.0/weui.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --weui-BG-0: #ededed;
            --weui-BG-2: #fff;
            --weui-FG-0: rgba(0, 0, 0, 0.9);
            --weui-FG-1: rgba(0, 0, 0, 0.5);
            --weui-BRAND: #07c160;
        }

        body {
            background-color: var(--weui-BG-0);
            overscroll-behavior-y: none;
            margin: 0; padding: 0;
            min-height: 100vh;
            font-family: -apple-system-font, Helvetica Neue, sans-serif;
        }

        /* 优化：移除 min-height: 100vh，让容器高度随内容变化 */
        .weui-form {
            padding: 32px 0;
            background-color: transparent;
            box-sizing: border-box;
            display: block; /* 覆盖 WeUI 默认的 flex 布局，使按钮随流移动 */
        }

        .custom-card {
            margin: 12px 16px;
            background: var(--weui-BG-2);
            border-radius: 8px;
            overflow: hidden;
        }

        .chevron-icon {
            display: inline-block;
            width: 10px; height: 10px;
            border-style: solid;
            border-width: 1.5px 1.5px 0 0;
            border-color: #b2b2b2;
            transform: rotate(135deg);
            transition: transform 0.3s ease;
            margin-right: 4px;
        }

        .expanded .chevron-icon { transform: rotate(-45deg); border-color: var(--weui-BRAND); }

        .settings-title {
            padding: 16px; font-size: 15px; font-weight: 600;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; -webkit-tap-highlight-color: transparent;
        }

        .settings-content {
            padding: 0 16px; max-height: 0; overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s;
        }

        .settings-content.expanded { max-height: 500px; padding-bottom: 16px; }

        .history-header {
            padding: 14px 16px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }

        .history-list { max-height: 240px; overflow-y: auto; }

        .history-item {
            padding: 14px 16px; display: flex; justify-content: space-between; align-items: center;
            position: relative;
        }

        .history-item:active { background-color: rgba(0,0,0,0.05); }

        .history-item:not(:last-child)::after {
            content: " "; position: absolute; left: 16px; bottom: 0; right: 0;
            height: 1px; border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }

        .custom-slider { -webkit-appearance: none; width: 100%; height: 4px; border-radius: 2px; background: #e5e5e5; outline: none; }
        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--weui-BRAND); border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .custom-half-screen-dialog {
            position: fixed; left: 0; right: 0; bottom: 0;
            background-color: var(--weui-BG-2); 
            border-radius: 16px 16px 0 0;
            z-index: 5000; 
            transform: translateY(100%); 
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
            max-height: 85vh;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
        }
        
        .custom-half-screen-dialog.show { transform: translateY(0); }
        
        .dialog-header {
            padding: 20px 16px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        .dialog-title { font-size: 17px; font-weight: 600; color: var(--weui-FG-0); }
        .dialog-close-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: var(--weui-FG-1); background: none; border: none; cursor: pointer;
        }
        
        .dialog-body { flex: 1; overflow-y: auto; padding: 32px 16px; display: flex; flex-direction: column; align-items: center; }
        .dialog-footer {
            padding: 16px; padding-bottom: calc(16px + env(safe-area-inset-bottom));
            border-top: 0.5px solid rgba(0,0,0,0.05); display: flex; gap: 12px; flex-shrink: 0; align-items: center;
        }
        
        .dialog-footer .weui-btn { flex: 1; margin: 0 !important; height: 48px; line-height: 48px; border-radius: 8px; font-size: 16px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; }

        .qrcode-wrapper { padding: 16px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; }
        #qrcode-container img { display: block; max-width: 100%; height: auto; }
        
        /* --- 修复后的确认对话框：收紧间距 --- */
        .weui-dialog { background-color: var(--weui-BG-2); border-radius: 12px; }
        
        .weui-dialog__hd {
            padding: 24px 24px 12px; /* 减小标题上下间距 */
        }
        
        .weui-dialog__title { font-size: 17px; font-weight: 600; }
        
        .weui-dialog__bd {
            padding: 0 24px 20px; /* 减小正文底部与按钮的间距 */
            color: var(--weui-FG-1);
            font-size: 15px; 
            line-height: 1.5;
            min-height: auto; /* 移除最小高度限制 */
        }
        
        .weui-dialog__ft { min-height: 52px; line-height: 52px; }
        .weui-dialog__btn { font-size: 16px; font-weight: 600; }

        /* 优化：操作按钮区域间距 */
        .weui-form__opr-area {
            margin: 24px 16px 8px; /* 调整页边距，让它跟随上方卡片 */
        }

        @media (prefers-color-scheme: dark) {
            :root { 
                --weui-BG-0: #111; 
                --weui-BG-2: #1c1c1e; 
                --weui-FG-0: rgba(255, 255, 255, 0.8); 
                --weui-FG-1: rgba(255, 255, 255, 0.5); 
            }
            .weui-textarea { background: #2c2c2e; color: var(--weui-FG-0); }
            .custom-slider { background: #444; }
            .history-item:active { background-color: rgba(255,255,255,0.05); }
        }
    </style>
</head>
<body>
    <div class="weui-page">
        <div class="weui-toptips weui-toptips_warn" id="topTips" style="display: none;">提示信息</div>

        <div class="weui-form">
            <div class="weui-form__text-area">
                <h2 class="weui-form__title">二维码生成器</h2>
                <div class="weui-form__desc">本地即时生成，保护隐私</div>
            </div>

            <div class="weui-form__control-area">
                <div class="weui-cells__group weui-cells__group_form">
                    <div class="weui-cells weui-cells_form">
                        <div class="weui-cell">
                            <div class="weui-cell__bd">
                                <textarea id="urlInput" class="weui-textarea" placeholder="在此输入网址或文字内容..." rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="custom-card">
                    <div class="settings-title" id="settingsTitle">
                        <span>生成选项</span>
                        <i class="chevron-icon"></i>
                    </div>
                    <div class="settings-content" id="settingsContent">
                        <div class="weui-cells weui-cells_after-title" style="font-size: 14px;">
                            <div class="weui-cell weui-cell_switch">
                                <div class="weui-cell__bd">自动纠错/格式化</div>
                                <div class="weui-cell__ft"><input class="weui-switch" type="checkbox" id="formatSwitch" checked></div>
                            </div>
                            <div class="weui-cell weui-cell_switch">
                                <div class="weui-cell__bd">保存生成历史</div>
                                <div class="weui-cell__ft"><input class="weui-switch" type="checkbox" id="historySwitch" checked></div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__bd">
                                    <p>中央 Logo</p>
                                    <img id="logoPreview" style="width: 40px; height: 40px; margin-top: 8px; display: none; border-radius: 4px; object-fit: cover;">
                                </div>
                                <div class="weui-cell__ft">
                                    <button class="weui-btn weui-btn_mini weui-btn_default" id="selectLogoBtn">选择</button>
                                    <button class="weui-btn weui-btn_mini weui-btn_warn" id="removeLogoBtn" style="display: none;">删除</button>
                                    <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                                </div>
                            </div>
                        </div>
                        <div class="weui-cell" style="padding: 16px;">
                            <div class="weui-cell__bd">
                                <div style="display:flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                                    <span>二维码大小</span><span id="sizeValue" style="color:var(--weui-FG-1)">200px</span>
                                </div>
                                <input type="range" min="200" max="400" step="100" value="200" class="custom-slider" id="sizeSlider">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="custom-card" id="historyPanel" style="display: none;">
                    <div class="history-header">
                        <span style="font-size: 15px; font-weight: 600;">历史记录 <small style="font-weight: normal; color: var(--weui-FG-1); font-size: 12px;">(仅存10条)</small></span>
                        <a href="javascript:" class="weui-link" id="clearHistoryBtn" style="font-size: 13px;">清空</a>
                    </div>
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>

            <div class="weui-form__opr-area">
                <button class="weui-btn weui-btn_primary" id="generateBtn">生成二维码</button>
            </div>
        </div>
        
        <div class="weui-mask" id="mask" style="display: none;"></div>
        
        <div class="custom-half-screen-dialog" id="dialog">
            <div class="dialog-header">
                <div class="dialog-title">生成成功</div>
                <button class="dialog-close-btn" id="closeDialogBtn">×</button>
            </div>
            <div class="dialog-body">
                <div class="qrcode-wrapper">
                    <div id="qrcode-container"></div>
                </div>
                <p style="margin-top: 20px; color: var(--weui-FG-1); font-size: 14px;">长按图片保存或分享</p>
            </div>
            <div class="dialog-footer">
                <button class="weui-btn weui-btn_default" id="backToEditBtn">返回修改</button>
                <button class="weui-btn weui-btn_primary" id="saveImageBtn">保存图片</button>
            </div>
        </div>

        <div id="confirmDialog" style="display: none;">
            <div class="weui-mask"></div>
            <div class="weui-dialog">
                <div class="weui-dialog__hd"><strong class="weui-dialog__title">确认清空</strong></div>
                <div class="weui-dialog__bd">确定要删除所有历史记录吗？</div>
                <div class="weui-dialog__ft">
                    <a href="javascript:" class="weui-dialog__btn weui-dialog__btn_default" id="cancelClearBtn">取消</a>
                    <a href="javascript:" class="weui-dialog__btn weui-dialog__btn_primary" id="confirmClearBtn">确定清空</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const els = {
                input: document.getElementById('urlInput'),
                container: document.getElementById('qrcode-container'),
                mask: document.getElementById('mask'),
                dialog: document.getElementById('dialog'),
                confirmDialog: document.getElementById('confirmDialog'),
                historyList: document.getElementById('historyList'),
                historyPanel: document.getElementById('historyPanel'),
                logoPreview: document.getElementById('logoPreview'),
                removeLogoBtn: document.getElementById('removeLogoBtn'),
                logoUpload: document.getElementById('logoUpload'),
                sizeSlider: document.getElementById('sizeSlider'),
                sizeValue: document.getElementById('sizeValue'),
                topTips: document.getElementById('topTips')
            };

            let settings = { autoFormat: true, saveHistory: true, logo: null, qrSize: 200 };
            let historyRecords = [];

            function init() {
                loadStoredData();
                bindEvents();
            }

            function bindEvents() {
                document.getElementById('generateBtn').addEventListener('click', generateQR);
                document.getElementById('closeDialogBtn').addEventListener('click', hideDialog);
                document.getElementById('backToEditBtn').addEventListener('click', hideDialog);
                document.getElementById('saveImageBtn').addEventListener('click', () => {
                    const img = els.container.querySelector('img');
                    if(img) { 
                        const a = document.createElement('a'); 
                        a.href = img.src; 
                        a.download = 'qrcode_' + Date.now() + '.png'; 
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                });

                document.getElementById('settingsTitle').addEventListener('click', () => {
                    document.getElementById('settingsContent').classList.toggle('expanded');
                    document.getElementById('settingsTitle').classList.toggle('expanded');
                });

                document.getElementById('selectLogoBtn').addEventListener('click', () => els.logoUpload.click());
                document.getElementById('removeLogoBtn').addEventListener('click', () => {
                    settings.logo = null; 
                    els.logoPreview.style.display = 'none'; 
                    els.removeLogoBtn.style.display = 'none'; 
                    saveSettings();
                });
                els.logoUpload.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        settings.logo = ev.target.result; 
                        els.logoPreview.src = settings.logo;
                        els.logoPreview.style.display = 'block'; 
                        els.removeLogoBtn.style.display = 'inline-block'; 
                        saveSettings();
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                });

                els.sizeSlider.addEventListener('input', e => {
                    settings.qrSize = parseInt(e.target.value); 
                    els.sizeValue.textContent = settings.qrSize + 'px'; 
                    saveSettings();
                });

                els.historyList.addEventListener('click', e => {
                    const item = e.target.closest('.history-item');
                    if(item) { 
                        els.input.value = item.dataset.text; 
                        generateQR(); 
                    }
                });

                document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                    els.confirmDialog.style.display = 'block';
                });

                document.getElementById('cancelClearBtn').addEventListener('click', () => {
                    els.confirmDialog.style.display = 'none';
                });

                document.getElementById('confirmClearBtn').addEventListener('click', () => {
                    historyRecords = [];
                    localStorage.removeItem('qrHistory');
                    renderHistory();
                    els.confirmDialog.style.display = 'none';
                });

                els.mask.addEventListener('click', hideDialog);
                
                document.getElementById('formatSwitch').addEventListener('change', function() {
                    settings.autoFormat = this.checked;
                    saveSettings();
                });
                
                document.getElementById('historySwitch').addEventListener('change', function() {
                    settings.saveHistory = this.checked;
                    saveSettings();
                    if(!settings.saveHistory) {
                        els.historyPanel.style.display = 'none';
                    } else if(historyRecords.length > 0) {
                        els.historyPanel.style.display = 'block';
                    }
                });
            }

            function generateQR() {
                let text = els.input.value.trim();
                if(!text) { 
                    showTopTips('请输入内容'); 
                    return; 
                }
                
                if(settings.autoFormat) {
                    if(text.includes('.') && !text.startsWith('http')) {
                        text = 'https://' + text;
                    }
                }
                
                els.container.innerHTML = '';
                
                const qrcode = new QRCode(els.container, {
                    text: text, 
                    width: settings.qrSize, 
                    height: settings.qrSize,
                    colorDark: "#000000", 
                    colorLight: "#ffffff", 
                    correctLevel: QRCode.CorrectLevel.H
                });

                setTimeout(() => {
                    const canvas = els.container.querySelector('canvas');
                    if(canvas) {
                        if(settings.logo) {
                            const ctx = canvas.getContext('2d');
                            const img = new Image();
                            img.onload = () => {
                                const s = settings.qrSize * 0.22; 
                                const p = (canvas.width - s) / 2;
                                ctx.fillStyle = '#fff'; 
                                ctx.fillRect(p-3, p-3, s+6, s+6);
                                ctx.drawImage(img, p, p, s, s);
                                finalizeQR();
                            };
                            img.src = settings.logo;
                        } else {
                            finalizeQR();
                        }
                    }
                }, 200);

                function finalizeQR() {
                    const canvas = els.container.querySelector('canvas');
                    if(!canvas) return;
                    
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL("image/png");
                    img.alt = "生成的二维码";
                    
                    els.container.innerHTML = ''; 
                    els.container.appendChild(img);
                    
                    if(settings.saveHistory) {
                        saveToHistory(text); 
                    }
                    showDialog();
                }
            }

            function showDialog() {
                els.mask.style.display = 'block';
                void els.dialog.offsetWidth;
                els.dialog.classList.add('show');
            }

            function hideDialog() {
                els.dialog.classList.remove('show');
                setTimeout(() => {
                    els.mask.style.display = 'none';
                }, 300);
            }

            function saveToHistory(text) {
                const idx = historyRecords.findIndex(r => r.text === text);
                if(idx !== -1) {
                    const [existing] = historyRecords.splice(idx, 1);
                    existing.time = Date.now();
                    historyRecords.unshift(existing);
                } else {
                    const displayText = text.length > 30 ? text.substring(0, 27) + '...' : text;
                    historyRecords.unshift({ 
                        text, 
                        time: Date.now(), 
                        display: displayText 
                    });
                }
                historyRecords = historyRecords.slice(0, 10);
                localStorage.setItem('qrHistory', JSON.stringify(historyRecords));
                renderHistory();
            }

            function renderHistory() {
                if(historyRecords.length === 0) { 
                    els.historyPanel.style.display = 'none'; 
                    return; 
                }
                els.historyPanel.style.display = 'block';
                els.historyList.innerHTML = historyRecords.map(item => `
                    <div class="history-item" data-text="${item.text.replace(/"/g, '&quot;')}">
                        <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:14px;">
                            ${item.display.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                        </div>
                        <div style="font-size:12px; color:var(--weui-FG-1); margin-left:12px;">
                            ${new Date(item.time).getHours().toString().padStart(2,'0')}:${new Date(item.time).getMinutes().toString().padStart(2,'0')}
                        </div>
                    </div>
                `).join('');
            }

            function showTopTips(msg) {
                els.topTips.textContent = msg; 
                els.topTips.style.display = 'block';
                setTimeout(() => els.topTips.style.display = 'none', 2000);
            }

            function loadStoredData() {
                const savedSettings = localStorage.getItem('qrSettings');
                if(savedSettings) {
                    try { Object.assign(settings, JSON.parse(savedSettings)); } catch(e) {}
                }
                const savedHistory = localStorage.getItem('qrHistory');
                if(savedHistory) {
                    try {
                        historyRecords = JSON.parse(savedHistory);
                        renderHistory();
                    } catch(e) {}
                }
                const savedLogo = localStorage.getItem('qrLogo');
                if(savedLogo) { 
                    settings.logo = savedLogo; 
                    els.logoPreview.src = savedLogo; 
                    els.logoPreview.style.display = 'block'; 
                    els.removeLogoBtn.style.display = 'inline-block'; 
                }
                document.getElementById('formatSwitch').checked = settings.autoFormat;
                document.getElementById('historySwitch').checked = settings.saveHistory;
                els.sizeSlider.value = settings.qrSize; 
                els.sizeValue.textContent = settings.qrSize + 'px';
            }

            function saveSettings() {
                localStorage.setItem('qrSettings', JSON.stringify(settings));
                if(settings.logo) localStorage.setItem('qrLogo', settings.logo);
                else localStorage.removeItem('qrLogo');
            }

            init();
        });
    </script>
</body>
</html>
