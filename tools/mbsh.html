<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>妙笔生花 - 智能写作助手</title>
    
    <link rel="stylesheet" href="https://res.wx.qq.com/t/wx_fed/weui-source/res/2.6.25/weui.min.css"/>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* --- 全局样式 & 变量 --- */
        :root {
            --header-height: 50px;
            --tabbar-height: 56px;
            --api-card-bg: #f7f7f7;
            --card-bg: #ffffff;
        }

        [data-weui-theme="dark"] {
            --api-card-bg: #2c2c2c;
            --card-bg: #2c2c2c;
        }

        body, html {
            height: 100%;
            width: 100%;
            background-color: var(--weui-BG-0);
            color: var(--weui-FG-0);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* --- 顶栏 --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background-color: var(--weui-BG-2);
            border-bottom: 1px solid var(--weui-FG-3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-sizing: border-box;
            z-index: 5000;
            font-weight: 500;
            font-size: 17px;
        }
        
        .app-header .title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .app-header .action-btn {
            font-size: 18px;
            color: var(--weui-FG-0);
            padding: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .app-header .action-btn:active { opacity: 0.6; }

        /* --- 页面容器 --- */
        .page-container {
            position: absolute;
            top: var(--header-height);
            bottom: var(--tabbar-height);
            left: 0;
            width: 100%;
            overflow-y: hidden;
            background-color: var(--weui-BG-0);
            z-index: 1;
            transition: bottom 0.3s;
        }
        
        .page-container.full-height { bottom: 0; }

        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* --- 创作区 Step 容器 --- */
        .step-container {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        .step-container.active-step { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 编辑器样式 --- */
        .editor-layout { display: flex; flex-direction: column; height: 100%; }

        .editor-toolbar-scroll {
            white-space: nowrap; overflow-x: auto; padding: 10px 16px;
            background-color: var(--weui-BG-2); border-bottom: 1px solid var(--weui-FG-3); flex-shrink: 0;
        }
        .editor-toolbar-scroll::-webkit-scrollbar { display: none; }
        
        .toolbar-btn {
            display: inline-block; margin-right: 8px; font-size: 13px;
            padding: 6px 12px; border-radius: 4px;
        }

        .ql-toolbar.ql-snow { border: none !important; border-bottom: 1px solid var(--weui-FG-3) !important; background-color: var(--weui-BG-2); }
        .ql-container.ql-snow { border: none !important; flex: 1; background-color: var(--weui-BG-2); font-size: 16px; overflow-y: auto; }
        .ql-editor { padding: 16px; min-height: 100%; }
        [data-weui-theme="dark"] .ql-stroke { stroke: #b2b2b2 !important; }
        [data-weui-theme="dark"] .ql-fill { fill: #b2b2b2 !important; }
        [data-weui-theme="dark"] .ql-picker { color: #b2b2b2 !important; }

        /* 底部统计栏 */
        .stats-bar {
            padding: 8px 16px; font-size: 12px; color: var(--weui-FG-1);
            background-color: var(--weui-BG-1); border-top: 1px solid var(--weui-FG-3);
            display: flex; justify-content: space-between; flex-shrink: 0;
        }

        /* --- 底栏 Tabbar --- */
        .weui-tabbar {
            position: fixed !important; bottom: 0 !important; left: 0; width: 100%; height: var(--tabbar-height);
            background-color: var(--weui-BG-2); z-index: 5000; display: flex; align-items: center; transition: transform 0.3s;
        }
        .weui-tabbar.hidden { transform: translateY(100%); }
        .weui-tabbar__item { padding-top: 4px; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0); }
        .weui-tabbar__icon i { font-size: 20px; color: var(--weui-FG-1); }
        .weui-tabbar__item.weui-bar__item_on .weui-tabbar__icon i { color: var(--weui-BRAND); }
        .weui-tabbar__label { font-size: 10px; color: var(--weui-FG-1); margin-top: 2px;}
        .weui-tabbar__item.weui-bar__item_on .weui-tabbar__label { color: var(--weui-BRAND); }

        /* ========================================= */
        /* 文库 UI 优化样式 (修复对齐问题) */
        /* ========================================= */

        .library-toolbar {
            padding: 8px 16px; background-color: var(--weui-BG-0); display: flex;
            justify-content: space-between; align-items: center; font-size: 14px;
            color: var(--weui-FG-1); border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        [data-weui-theme="dark"] .library-toolbar { border-bottom-color: rgba(255,255,255,0.05); }

        .mode-switch-btn { color: var(--weui-BLUE); font-weight: 500; cursor: pointer; padding: 4px 8px; }

        .library-list-container { padding: 12px; padding-bottom: 100px; }

        /* 卡片整体布局 - 关键对齐修正 */
        .lib-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid transparent;
            
            /* Flex 布局，垂直居中 */
            display: flex;
            align-items: center; /* 关键：子元素垂直居中 */
            justify-content: space-between;
        }

        [data-weui-theme="dark"] .lib-card { box-shadow: none; background: var(--api-card-bg); }
        .lib-card:active { background: var(--weui-BG-1); }
        .lib-card.selected { border-color: var(--weui-BRAND); background-color: rgba(7, 193, 96, 0.04); }
        [data-weui-theme="dark"] .lib-card.selected { background-color: rgba(7, 193, 96, 0.1); }

        /* 左侧复选框区 */
        .lib-check-visual {
            width: 0; overflow: hidden; opacity: 0; transition: all 0.3s ease;
            display: flex; align-items: center; flex-shrink: 0; 
        }
        .lib-card.edit-mode .lib-check-visual { width: 36px; opacity: 1; margin-right: 8px; }

        .custom-checkbox {
            width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--weui-FG-2);
            box-sizing: border-box; position: relative; transition: all 0.2s;
        }
        .lib-card.selected .custom-checkbox { border-color: var(--weui-BRAND); background-color: var(--weui-BRAND); }
        .lib-card.selected .custom-checkbox::after {
            content: ''; position: absolute; top: 4px; left: 7px; width: 5px; height: 9px;
            border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }

        /* 中间文字内容区 - 对齐优化 */
        .lib-content {
            flex: 1; 
            min-width: 0; 
            display: flex;
            flex-direction: column;
            justify-content: center; /* 内容垂直居中 */
            padding-right: 12px; 
        }

        .lib-title {
            font-size: 17px; font-weight: 600; color: var(--weui-FG-0);
            margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            line-height: 1.2; /* 紧凑行高 */
        }

        .lib-preview {
            font-size: 13px; color: var(--weui-FG-1);
            display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2;
            overflow: hidden; line-height: 1.5; margin-bottom: 6px;
            /* 移除固定高度，允许内容自适应居中 */
        }

        .lib-meta { font-size: 12px; color: var(--weui-FG-2); line-height: 1; }

        /* 右侧操作按钮区 */
        .lib-right-actions {
            display: flex; align-items: center; gap: 12px; 
            flex-shrink: 0; opacity: 1; transition: all 0.2s;
        }
        .lib-card.edit-mode .lib-right-actions { display: none; }

        /* 按钮样式：大号圆形 */
        .lib-act-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background-color: var(--weui-BG-1); color: var(--weui-FG-0);
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: background-color 0.2s; cursor: pointer;
        }
        .lib-act-btn:active { background-color: var(--weui-FG-2); }
        .lib-act-btn.delete-btn { color: var(--weui-RED); background-color: rgba(250, 81, 81, 0.08); }
        .lib-act-btn.export-btn { color: var(--weui-BLUE); background-color: rgba(16, 174, 255, 0.08); }

        /* 底部浮动批量操作栏 */
        .batch-bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: var(--weui-BG-2); padding: 0 24px;
            box-shadow: 0 -4px 16px rgba(0,0,0,0.06); display: flex;
            justify-content: space-between; align-items: center;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 5001; box-sizing: border-box; border-top: 1px solid var(--weui-FG-3);
        }
        .batch-bottom-bar.active { transform: translateY(0); }
        .batch-info { font-size: 14px; font-weight: 500; }
        .batch-btns { display: flex; gap: 12px; }

        /* ========================================= */
        /* Picker 模拟样式 */
        /* ========================================= */
        .picker-trigger {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-height: 24px;
        }
        .picker-value {
            color: var(--weui-FG-0);
            margin-right: 8px;
        }
        .picker-arrow {
            color: var(--weui-FG-2);
            font-size: 12px;
        }
        
        /* 自定义 ActionSheet 样式用于 Picker */
        .custom-picker-menu {
            max-height: 50vh;
            overflow-y: auto;
            background-color: var(--weui-BG-2);
        }
        .custom-picker-item {
            padding: 16px;
            text-align: center;
            font-size: 17px;
            border-bottom: 1px solid var(--weui-BG-0);
            background-color: var(--weui-BG-2);
            color: var(--weui-FG-0);
        }
        .custom-picker-item:active { background-color: var(--weui-BG-1); }

        /* ========================================= */
        /* 通用与弹窗样式 */
        /* ========================================= */
        .custom-dialog-wrapper .weui-dialog { border-radius: 12px; overflow: hidden; background-color: var(--weui-BG-2); }
        .api-input-visual {
            background-color: var(--api-card-bg); border-radius: 8px; padding: 4px 12px;
            border: 1px solid transparent; transition: all 0.3s; display: flex; align-items: center; margin-top: 8px;
        }
        .api-input-visual.focused {
            background-color: var(--weui-BG-2); border-color: var(--weui-BRAND); box-shadow: 0 0 0 2px rgba(7, 193, 96, 0.1);
        }
        .api-input-visual input {
            width: 100%; border: none; background: transparent; font-size: 16px;
            height: 40px; color: var(--weui-FG-0); outline: none; font-family: monospace;
        }
        .api-status-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--weui-FG-3);
        }
        .weui-search-bar { background-color: var(--weui-BG-2); }
        .weui-half-screen-dialog { max-height: 70%; }
        .weui-cells__group_form .weui-cells { margin-top: 0; }
    </style>
</head>

<body data-weui-theme="light">

    <header class="app-header">
        <div class="action-btn" style="width: 24px;"></div> 
        <div class="title">
            <i class="fas fa-feather-alt" style="color:var(--weui-BRAND)"></i> 妙笔生花
        </div>
        <div class="action-btn" onclick="openApiModal()">
            <i class="fas fa-cog"></i>
        </div>
    </header>

    <div class="page-container" id="mainContainer">
        
        <div id="view-workspace" class="view-section active">
            
            <div id="step-config" class="step-container active-step">
                <div class="weui-form">
                    <div class="weui-form__text-area">
                        <h2 class="weui-form__title">开始创作</h2>
                        <div class="weui-form__desc">第一步：配置参数，AI 生成初稿</div>
                    </div>
                    <div class="weui-form__control-area">
                        <div class="weui-cells__group weui-cells__group_form">
                            <div class="weui-cells">
                                <div class="weui-cell weui-cell_active">
                                    <div class="weui-cell__hd"><label class="weui-label">主题</label></div>
                                    <div class="weui-cell__bd">
                                        <input id="gen-topic" class="weui-input" placeholder="例如：我的校园生活" type="text"/>
                                    </div>
                                </div>
                                <div class="weui-cell weui-cell_active">
                                    <div class="weui-cell__hd"><label class="weui-label">关键词</label></div>
                                    <div class="weui-cell__bd">
                                        <input id="gen-keywords" class="weui-input" placeholder="选填，用逗号分隔" type="text"/>
                                    </div>
                                </div>
                                
                                <div class="weui-cell weui-cell_active weui-cell_access" onclick="openPicker('type')">
                                    <div class="weui-cell__hd"><label class="weui-label">体裁</label></div>
                                    <div class="weui-cell__bd"></div>
                                    <div class="weui-cell__ft">
                                        <span class="picker-value" id="display-type">议论文</span>
                                        <input type="hidden" id="val-type" value="议论文">
                                    </div>
                                </div>

                                <div class="weui-cell weui-cell_active weui-cell_access" onclick="openPicker('length')">
                                    <div class="weui-cell__hd"><label class="weui-label">字数</label></div>
                                    <div class="weui-cell__bd"></div>
                                    <div class="weui-cell__ft">
                                        <span class="picker-value" id="display-length">500字 (标准)</span>
                                        <input type="hidden" id="val-length" value="500">
                                    </div>
                                </div>

                                <div class="weui-cell weui-cell_active weui-cell_access" onclick="openPicker('style')">
                                    <div class="weui-cell__hd"><label class="weui-label">风格</label></div>
                                    <div class="weui-cell__bd"></div>
                                    <div class="weui-cell__ft">
                                        <span class="picker-value" id="display-style">简洁明了</span>
                                        <input type="hidden" id="val-style" value="简洁明了">
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div class="weui-form__opr-area">
                        <a class="weui-btn weui-btn_primary" href="javascript:" onclick="generateEssay()">AI 生成初稿</a>
                        <a class="weui-btn weui-btn_default" href="javascript:" onclick="startManualWrite()">跳过，直接写作</a>
                    </div>
                </div>
            </div>

            <div id="step-editor-ui" class="step-container">
                <div class="editor-layout">
                    <div class="weui-cells" style="margin-top:0; border-bottom:1px solid var(--weui-FG-3);">
                        <div class="weui-cell">
                            <div class="weui-cell__bd">
                                <input class="weui-input" id="doc-title" type="text" placeholder="文章标题" style="font-weight:bold; font-size:18px;">
                            </div>
                            <div class="weui-cell__ft" id="autosave-indicator" style="font-size:12px; opacity:0; transition:opacity 0.5s; color:var(--weui-BRAND)">
                                <i class="weui-icon-success-no-circle"></i> 已保存
                            </div>
                        </div>
                    </div>

                    <div class="editor-toolbar-scroll">
                        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default toolbar-btn" onclick="backToConfig()" style="color:var(--weui-FG-0); border-color:var(--weui-FG-3)"><i class="fas fa-undo"></i> 重写/新建</a>
                        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary toolbar-btn" onclick="callAI('polish')"><i class="fas fa-magic"></i> 润色</a>
                        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default toolbar-btn" onclick="callAI('expand')"><i class="fas fa-expand-alt"></i> 扩写</a>
                        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default toolbar-btn" onclick="callAI('check')"><i class="fas fa-spell-check"></i> 纠错</a>
                        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default toolbar-btn" onclick="callAI('summarize')"><i class="fas fa-compress-alt"></i> 摘要</a>
                        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_warn toolbar-btn" onclick="clearEditor()"><i class="fas fa-trash"></i> 清空</a>
                        <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default toolbar-btn" onclick="saveToLibrary(true)"><i class="fas fa-save"></i> 存文库</a>
                    </div>

                    <div id="editor"></div>

                    <div class="stats-bar">
                        <span>字数: <span id="word-count">0</span></span>
                        <span>预计阅读: <span id="read-time">0</span> 分钟</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-library" class="view-section">
            <div class="weui-search-bar" id="searchBar">
                <form class="weui-search-bar__form">
                    <div class="weui-search-bar__box">
                        <i class="weui-icon-search"></i>
                        <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索本地草稿" required oninput="handleSearch(this.value)">
                        <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                    </div>
                    <label class="weui-search-bar__label" id="searchText">
                        <i class="weui-icon-search"></i>
                        <span>搜索</span>
                    </label>
                </form>
                <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
            </div>
            
            <div class="library-toolbar">
                <span id="lib-total-count">共 0 篇</span>
                <div class="mode-switch-btn" onclick="toggleEditMode()" id="edit-mode-btn">
                    管理
                </div>
            </div>
            
            <div class="weui-panel weui-panel_access" style="flex:1; overflow-y:auto; background-color: var(--weui-BG-0);">
                <div class="library-list-container" id="library-list">
                    </div>
            </div>

            <div class="batch-bottom-bar" id="batchBottomBar">
                <div class="batch-actions-left" style="display:flex; align-items:center;" onclick="toggleSelectAllManual()">
                     <div class="custom-checkbox" id="selectAllBtn" style="margin-right:8px; width:20px; height:20px; border-color:var(--weui-FG-1)"></div>
                     <span class="batch-info" id="batch-select-count">已选 0</span>
                </div>
                <div class="batch-btns">
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default" onclick="batchExport()">导出</a>
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_warn" onclick="batchDelete()">删除</a>
                </div>
            </div>
        </div>

    </div>

    <div class="weui-tabbar" id="mainTabbar">
        <div class="weui-tabbar__item weui-bar__item_on" onclick="switchMainView('workspace', this)">
            <div class="weui-tabbar__icon">
                <i class="fas fa-pen-nib"></i>
            </div>
            <p class="weui-tabbar__label">创作</p>
        </div>
        <div class="weui-tabbar__item" onclick="switchMainView('library', this)">
            <div class="weui-tabbar__icon">
                <i class="fas fa-book"></i>
            </div>
            <p class="weui-tabbar__label">文库</p>
        </div>
    </div>

    <div class="js_dialog" id="aiDialog" style="display: none;">
        <div class="weui-mask" onclick="closeAiDialog()"></div>
        <div class="weui-half-screen-dialog">
            <div class="weui-half-screen-dialog__hd">
                <div class="weui-half-screen-dialog__hd__side" onclick="closeAiDialog()">
                    <a class="weui-icon-btn">关闭<i class="weui-icon-close-thin"></i></a>
                </div>
                <div class="weui-half-screen-dialog__hd__main">
                    <strong class="weui-half-screen-dialog__title" id="ai-dialog-title">AI 助手</strong>
                </div>
            </div>
            <div class="weui-half-screen-dialog__bd">
                <div class="weui-article" id="ai-response-content" style="padding:0; white-space: pre-wrap;"></div>
            </div>
            <div class="weui-half-screen-dialog__ft">
                <div class="weui-half-screen-dialog__btn-area">
                    <a href="javascript:;" class="weui-btn weui-btn_primary" onclick="applyAiText('replace')">替换选中</a>
                    <a href="javascript:;" class="weui-btn weui-btn_default" onclick="applyAiText('append')">追加到末尾</a>
                </div>
            </div>
        </div>
    </div>

    <div class="js_dialog" id="apiDialog" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog custom-dialog-wrapper">
            <div class="weui-dialog__hd">
                <strong class="weui-dialog__title">配置 AI 模型</strong>
            </div>
            <div class="weui-dialog__bd" style="padding-top:0;">
                <p style="font-size:13px; color:var(--weui-FG-1); text-align:left; margin-bottom:8px;">请输入 DeepSeek API Key：</p>
                <div class="api-input-visual" id="api-input-box">
                    <i class="fas fa-key" style="color:var(--weui-FG-2); margin-right:8px; font-size:14px;"></i>
                    <input type="password" id="api-key-input" placeholder="sk-...">
                </div>
                <div class="api-status-row">
                    <div id="api-status" class="api-status-text">
                        <i class="fas fa-circle" style="font-size:8px; color:#ccc"></i> 未配置
                    </div>
                    <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_primary" 
                       style="margin:0; padding: 4px 12px; font-size:12px; line-height:1.6;" 
                       onclick="testConnection()">测试</a>
                </div>
            </div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default" onclick="closeApiModal()">取消</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" onclick="saveApiKey()">保存</a>
            </div>
        </div>
    </div>

    <div id="custom-picker-mask" class="weui-mask" style="display: none; z-index: 6000;" onclick="closePicker()"></div>
    <div id="custom-picker-sheet" class="weui-actionsheet" style="z-index: 6001;">
        <div class="weui-actionsheet__title">
            <p class="weui-actionsheet__title-text" id="picker-title">请选择</p>
        </div>
        <div class="weui-actionsheet__menu custom-picker-menu" id="picker-menu">
            </div>
        <div class="weui-actionsheet__action">
            <div class="weui-actionsheet__cell" onclick="closePicker()">取消</div>
        </div>
    </div>

    <div class="js_dialog" id="globalConfirmDialog" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog custom-dialog-wrapper">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title" id="confirm-title">标题</strong></div>
            <div class="weui-dialog__bd" id="confirm-content">内容</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default" id="confirm-btn-cancel">取消</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="confirm-btn-ok">确定</a>
            </div>
        </div>
    </div>

    <div id="loadingToast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-loading weui-icon_toast"></i>
            <p class="weui-toast__content">思考中...</p>
        </div>
    </div>

    <div id="textToast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast weui-toast_text">
            <p class="weui-toast__content" id="toastMsg">操作成功</p>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // --- 全局变量 ---
        let currentAiText = null;
        let saveTimeout;
        let currentStep = 'config'; 
        let selectedItems = new Set();
        let isEditMode = false;
        let currentDraftsCache = []; 
        let currentPickerKey = null; // 当前正在操作哪个 Picker (type/length/style)

        // --- Picker 数据配置 ---
        const pickerData = {
            type: ['议论文', '记叙文', '说明文', '散文', '读（观）后感'],
            length: [
                { label: '300字 (短篇)', value: '300' },
                { label: '500字 (标准)', value: '500' },
                { label: '800字 (中长文)', value: '800' },
                { label: '1500字 (长文)', value: '1500' }
            ],
            style: ['简洁明了', '正式严谨', '文学优美', '幽默风趣', '情感丰富']
        };

        // --- 1. 初始化 ---
        function detectTheme() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.body.setAttribute('data-weui-theme', isDark ? 'dark' : 'light');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', detectTheme);
        detectTheme();

        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: '在此输入内容...',
            modules: {
                toolbar: [
                    [{ 'header': [2, 3, false] }],
                    ['bold', 'italic', 'underline', 'blockquote'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        window.addEventListener('load', () => {
            loadApiKey(false); 
            loadLibrary(true); // 初始加载文库数据
            bindSearchBar();

            // 恢复上次未保存的草稿
            const draft = localStorage.getItem('current_draft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    if (data.content && data.content.trim().length > 0) {
                        quill.root.innerHTML = data.content; 
                        document.getElementById('doc-title').value = data.title || '';
                        switchStep('editor'); 
                    } else {
                        switchStep('config');
                    }
                } catch (e) { switchStep('config'); }
            } else {
                switchStep('config');
            }
            updateStats();
        });

        // 自动保存草稿（非文库）
        quill.on('text-change', () => triggerAutoSave());
        document.getElementById('doc-title').addEventListener('input', () => triggerAutoSave());

        function triggerAutoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const content = quill.root.innerHTML;
                const title = document.getElementById('doc-title').value;
                if (currentStep === 'editor') {
                    localStorage.setItem('current_draft', JSON.stringify({ title, content }));
                    updateStats();
                    const indicator = document.getElementById('autosave-indicator');
                    indicator.style.opacity = 1;
                    setTimeout(() => indicator.style.opacity = 0, 1500);
                }
            }, 2000);
        }

        // --- 2. 视图与导航 ---
        function switchMainView(viewId, tabItem) {
            document.querySelectorAll('.weui-tabbar__item').forEach(el => el.classList.remove('weui-bar__item_on'));
            tabItem.classList.add('weui-bar__item_on');

            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');

            if(viewId === 'library') {
                toggleEditMode(false); // 重置为普通模式
                loadLibrary(true);
            }
        }

        function switchStep(stepName) {
            currentStep = stepName;
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active-step'));
            
            if (stepName === 'config') {
                document.getElementById('step-config').classList.add('active-step');
            } else if (stepName === 'editor') {
                document.getElementById('step-editor-ui').classList.add('active-step');
                setTimeout(() => quill.update(), 100); 
            }
        }

        async function backToConfig() {
            if (quill.getText().trim().length > 1) {
                const confirmed = await showConfirm("确认重写？", "当前内容若未保存到文库将会丢失。\n建议先点击工具栏的\"存文库\"。");
                if (!confirmed) return;
            }
            localStorage.removeItem('current_draft');
            document.getElementById('doc-title').value = '';
            quill.setText('');
            switchStep('config');
        }

        function startManualWrite() {
            document.getElementById('doc-title').value = '';
            quill.setText('');
            switchStep('editor');
        }

        // --- 3. Picker 逻辑 ---
        function openPicker(key) {
            currentPickerKey = key;
            const menu = document.getElementById('picker-menu');
            const data = pickerData[key];
            let html = '';
            
            let title = '';
            if(key === 'type') title = '选择体裁';
            if(key === 'length') title = '选择字数';
            if(key === 'style') title = '选择风格';
            document.getElementById('picker-title').innerText = title;

            data.forEach(item => {
                let label, value;
                if (typeof item === 'object') {
                    label = item.label;
                    value = item.value;
                } else {
                    label = item;
                    value = item;
                }
                html += `<div class="custom-picker-item" onclick="selectPickerItem('${label}', '${value}')">${label}</div>`;
            });
            
            menu.innerHTML = html;
            
            const mask = document.getElementById('custom-picker-mask');
            const sheet = document.getElementById('custom-picker-sheet');
            
            mask.style.display = 'block';
            sheet.classList.add('weui-actionsheet_toggle');
        }

        function closePicker() {
            const mask = document.getElementById('custom-picker-mask');
            const sheet = document.getElementById('custom-picker-sheet');
            
            sheet.classList.remove('weui-actionsheet_toggle');
            setTimeout(() => {
                mask.style.display = 'none';
            }, 200);
            currentPickerKey = null;
        }

        function selectPickerItem(label, value) {
            if (currentPickerKey) {
                // 更新显示文本
                document.getElementById(`display-${currentPickerKey}`).innerText = label;
                // 更新隐藏值
                document.getElementById(`val-${currentPickerKey}`).value = value;
            }
            closePicker();
        }

        // --- 4. AI 调用逻辑 ---
        async function callDeepSeek(prompt, systemMsg) {
            const apiKey = localStorage.getItem('deepseek_api_key');
            if (!apiKey) {
                openApiModal();
                throw new Error("请先设置 API Key");
            }
            const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        { role: "system", content: systemMsg || "你是中文写作助手。" },
                        { role: "user", content: prompt }
                    ],
                    stream: false
                })
            });
            if (!response.ok) throw new Error("API 请求失败，请检查 Key");
            const data = await response.json();
            return data.choices[0].message.content;
        }

        async function generateEssay() {
            const topic = document.getElementById('gen-topic').value;
            if (!topic) return showToast("请输入主题");
            
            // 使用隐藏 Input 的值
            const type = document.getElementById('val-type').value;
            const len = document.getElementById('val-length').value;
            const style = document.getElementById('val-style').value;
            const kws = document.getElementById('gen-keywords').value;

            const prompt = `写一篇关于"${topic}"的${type}。要求：1.字数约${len}字。2.风格：${style}。3.${kws ? '关键词：'+kws : ''}。请直接输出正文HTML格式（分段用<p>，标题用<h3>），不包含markdown标记。`;
            
            showLoading(true);
            try {
                const content = await callDeepSeek(prompt, "你是一个专业的中文写作AI。请直接返回HTML格式。");
                let cleanContent = content.replace(/```html/g, '').replace(/```/g, '');
                document.getElementById('doc-title').value = topic;
                quill.clipboard.dangerouslyPasteHTML(cleanContent);
                switchStep('editor');
                showToast("生成完毕");
            } catch (e) {
                showToast(e.message);
            } finally {
                showLoading(false);
            }
        }

        async function callAI(mode) {
            const selection = quill.getSelection();
            let text = "";
            if (selection && selection.length > 0) {
                text = quill.getText(selection.index, selection.length).trim();
            } else {
                text = quill.getText().trim();
                if (text.length === 0) return showToast("内容为空");
            }
            
            const prompts = {
                polish: `请润色以下文字，使其文笔更优美：\n${text}`,
                expand: `请扩写以下文字，丰富细节：\n${text}`,
                check: `请纠正以下文字的逻辑错误和语病：\n${text}`,
                summarize: `请总结核心内容（200字以内）：\n${text}`
            };
            const titles = { polish: "润色建议", expand: "扩写建议", check: "诊断建议", summarize: "内容摘要" };

            showLoading(true);
            try {
                const res = await callDeepSeek(prompts[mode]);
                renderAiResponse(res, titles[mode], selection);
            } catch (e) {
                showToast(e.message);
            } finally {
                showLoading(false);
            }
        }

        function renderAiResponse(text, title, selection) {
            currentAiText = text;
            window.lastSelection = selection;
            document.getElementById('ai-dialog-title').innerText = title;
            document.getElementById('ai-response-content').innerText = text;
            const dialog = document.getElementById('aiDialog');
            dialog.style.display = 'block';
            dialog.classList.add('weui-animate-fade-in');
            dialog.querySelector('.weui-half-screen-dialog').classList.add('weui-animate-slide-up');
        }

        function closeAiDialog() { document.getElementById('aiDialog').style.display = 'none'; }

        function applyAiText(mode) {
            if(!currentAiText) return;
            if (mode === 'replace' && window.lastSelection && window.lastSelection.length > 0) {
                quill.deleteText(window.lastSelection.index, window.lastSelection.length);
                quill.insertText(window.lastSelection.index, currentAiText);
            } else {
                quill.insertText(quill.getLength(), "\n\n--- AI 生成内容 ---\n" + currentAiText);
            }
            closeAiDialog();
            showToast("已应用");
        }

        // --- 5. 文库逻辑 (核心优化部分) ---

        // 保存到文库
        function saveToLibrary(showMsg) {
            const title = document.getElementById('doc-title').value || "未命名";
            const content = quill.root.innerHTML;
            const plainText = quill.getText().trim(); 
            const wordCount = plainText.length;
            
            if (plainText.length < 1) return showToast("内容为空");

            const drafts = JSON.parse(localStorage.getItem('saved_library') || '[]');
            drafts.unshift({ 
                id: Date.now(), 
                title, 
                content, 
                preview: plainText.substring(0, 60), 
                wordCount: wordCount,
                date: new Date().toLocaleString() 
            });
            
            localStorage.setItem('saved_library', JSON.stringify(drafts));
            if(showMsg) showToast("已保存到文库");
            
            if(document.getElementById('view-library').classList.contains('active')) {
                loadLibrary(true);
            }
        }

        // 加载/刷新文库列表
        function loadLibrary(refreshData = true) {
            let drafts;
            if(refreshData) {
                drafts = JSON.parse(localStorage.getItem('saved_library') || '[]');
                currentDraftsCache = drafts; 
            } else {
                drafts = currentDraftsCache;
            }
            
            const searchVal = document.getElementById('searchInput').value;
            if (searchVal) {
                drafts = drafts.filter(d => d.title.includes(searchVal) || d.content.includes(searchVal));
            }
            
            renderDraftList(drafts);
        }

        function handleSearch(val) { loadLibrary(true); }

        // 渲染列表 (卡片视图 - 按钮在右侧)
        function renderDraftList(drafts) {
            const list = document.getElementById('library-list');
            document.getElementById('lib-total-count').innerText = `共 ${drafts.length} 篇`;
            const editBtn = document.getElementById('edit-mode-btn');

            if (drafts.length === 0) {
                list.innerHTML = '<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无内容</span></div>';
                toggleEditMode(false); 
                editBtn.style.display = 'none';
                return;
            }
            
            editBtn.style.display = 'block';

            list.innerHTML = drafts.map(d => {
                const isSelected = selectedItems.has(d.id);
                // 兼容旧数据
                const previewText = d.preview || stripHtmlTags(d.content).substring(0, 60); 
                const count = d.wordCount || stripHtmlTags(d.content).length; 

                return `
                <div class="lib-card ${isEditMode ? 'edit-mode' : ''} ${isSelected ? 'selected' : ''}" 
                     onclick="handleCardClick(${d.id})">
                    
                    <div class="lib-check-visual">
                        <div class="custom-checkbox"></div>
                    </div>

                    <div class="lib-content">
                        <div class="lib-title">${d.title}</div>
                        <div class="lib-preview">${previewText}</div>
                        <div class="lib-meta">
                            <span>${d.date.split(' ')[0]} · ${count} 字</span>
                        </div>
                    </div>

                    <div class="lib-right-actions">
                        <div class="lib-act-btn" onclick="event.stopPropagation(); loadDraft(${d.id})">
                            <i class="fas fa-pen"></i>
                        </div>
                        <div class="lib-act-btn export-btn" onclick="event.stopPropagation(); exportSingle(${d.id})">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="lib-act-btn delete-btn" onclick="event.stopPropagation(); deleteDraft(${d.id})">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            updateBatchUI();
        }

        // 切换编辑模式
        function toggleEditMode(forceState) {
            if (typeof forceState !== 'undefined') {
                isEditMode = forceState;
            } else {
                isEditMode = !isEditMode;
            }

            const btn = document.getElementById('edit-mode-btn');
            const bar = document.getElementById('batchBottomBar');
            const tabbar = document.getElementById('mainTabbar');
            const container = document.getElementById('mainContainer');
            
            if (isEditMode) {
                btn.innerText = '完成';
                btn.style.color = 'var(--weui-BRAND)';
                bar.classList.add('active');
                tabbar.classList.add('hidden'); // 隐藏Tabbar
                container.classList.add('full-height');
            } else {
                btn.innerText = '管理';
                btn.style.color = 'var(--weui-BLUE)';
                bar.classList.remove('active');
                tabbar.classList.remove('hidden');
                container.classList.remove('full-height');
                selectedItems.clear(); // 退出清空
            }

            // 更新 DOM 类名
            const cards = document.querySelectorAll('.lib-card');
            cards.forEach(card => {
                if(isEditMode) card.classList.add('edit-mode');
                else {
                    card.classList.remove('edit-mode');
                    card.classList.remove('selected');
                }
            });
            updateBatchUI();
        }

        function handleCardClick(id) {
            if (isEditMode) {
                if (selectedItems.has(id)) selectedItems.delete(id);
                else selectedItems.add(id);
                loadLibrary(false); // 仅重新渲染 UI
            } else {
                loadDraft(id);
            }
        }

        function toggleSelectAllManual() {
            const allDrafts = currentDraftsCache || [];
            const isAllSelected = selectedItems.size === allDrafts.length && allDrafts.length > 0;
            
            if (isAllSelected) selectedItems.clear();
            else allDrafts.forEach(d => selectedItems.add(d.id));
            loadLibrary(false);
        }

        function updateBatchUI() {
            const count = selectedItems.size;
            document.getElementById('batch-select-count').innerText = count > 0 ? `已选 ${count} 项` : '未选择';
            
            // 全选按钮样式
            const allBtn = document.getElementById('selectAllBtn');
            const allDrafts = currentDraftsCache || [];
            
            if (count > 0 && count === allDrafts.length) {
                allBtn.style.backgroundColor = 'var(--weui-BRAND)';
                allBtn.style.borderColor = 'var(--weui-BRAND)';
                allBtn.innerHTML = ''; 
            } else {
                allBtn.style.backgroundColor = 'transparent';
                allBtn.style.borderColor = 'var(--weui-FG-2)';
            }
            
            // 按钮启用状态
            const actionBtns = document.querySelectorAll('.batch-btns .weui-btn');
            actionBtns.forEach(btn => {
                if(count === 0) btn.classList.add('weui-btn_disabled');
                else btn.classList.remove('weui-btn_disabled');
            });
        }

        // --- 6. 文库操作 ---
        async function loadDraft(id) {
            const d = currentDraftsCache.find(x => x.id === id);
            if(d) {
                if (quill.getText().trim().length > 0) {
                    if (!await showConfirm("覆盖提醒", "当前编辑器内容将被覆盖，确定吗？")) return;
                }
                document.getElementById('doc-title').value = d.title;
                quill.root.innerHTML = d.content;
                switchMainView('workspace', document.querySelectorAll('.weui-tabbar__item')[0]);
                switchStep('editor');
            }
        }

        async function deleteDraft(id) {
            if (await showConfirm("确认删除", "删除后无法恢复，确定吗？")) {
                let drafts = JSON.parse(localStorage.getItem('saved_library') || '[]');
                drafts = drafts.filter(x => x.id !== id);
                localStorage.setItem('saved_library', JSON.stringify(drafts));
                loadLibrary(true);
                showToast("已删除");
            }
        }

        function exportSingle(id) {
            const doc = currentDraftsCache.find(x => x.id === id);
            if (!doc) return;
            downloadTxt(doc.title, doc.content);
        }

        function downloadTxt(title, contentHtml) {
            const blob = new Blob([`标题：${title}\n\n${stripHtmlTags(contentHtml)}\n\n导出时间：${new Date().toLocaleString()}`], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^\w\u4e00-\u9fa5]/g, '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function batchDelete() {
            if (selectedItems.size === 0) return;
            if (!await showConfirm("批量删除", `确定删除选中的 ${selectedItems.size} 篇文档吗？`)) return;
            
            let drafts = JSON.parse(localStorage.getItem('saved_library') || '[]');
            drafts = drafts.filter(x => !selectedItems.has(x.id));
            localStorage.setItem('saved_library', JSON.stringify(drafts));
            selectedItems.clear();
            loadLibrary(true);
            showToast("删除成功");
        }

        async function batchExport() {
            if (selectedItems.size === 0) return;
            const selectedDocs = currentDraftsCache.filter(d => selectedItems.has(d.id));
            
            if (selectedDocs.length === 1) {
                exportSingle(selectedDocs[0].id);
                return;
            }

            showLoading(true);
            try {
                const zip = new JSZip();
                selectedDocs.forEach(doc => {
                    const content = `标题：${doc.title}\n\n${stripHtmlTags(doc.content)}`;
                    zip.file(`${doc.title.replace(/[^\w\u4e00-\u9fa5]/g, '_')}.txt`, content);
                });
                const content = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `批量导出_${new Date().toISOString().slice(0,10)}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToast("导出成功");
            } catch (e) {
                showToast("导出失败");
            } finally {
                showLoading(false);
            }
        }

        // --- 7. 工具函数 ---
        function stripHtmlTags(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        function showLoading(show) { document.getElementById('loadingToast').style.display = show ? 'block' : 'none'; }
        function showToast(msg) {
            const el = document.getElementById('textToast');
            document.getElementById('toastMsg').innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        }
        async function clearEditor() {
            if(await showConfirm("清空", "确定清空内容？")) {
                quill.setText('');
                document.getElementById('doc-title').value = '';
            }
        }
        function updateStats() {
            const text = quill.getText().trim();
            const count = text.length > 0 ? text.replace(/\s/g, '').length : 0;
            document.getElementById('word-count').innerText = count;
            document.getElementById('read-time').innerText = Math.ceil(count / 400); 
        }

        // Promise化的 Confirm
        function showConfirm(title, content) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('globalConfirmDialog');
                document.getElementById('confirm-title').innerText = title;
                document.getElementById('confirm-content').innerText = content;
                const cancelBtn = document.getElementById('confirm-btn-cancel');
                const okBtn = document.getElementById('confirm-btn-ok');

                const newCancel = cancelBtn.cloneNode(true);
                const newOk = okBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);
                okBtn.parentNode.replaceChild(newOk, okBtn);

                newCancel.addEventListener('click', () => { dialog.style.display = 'none'; resolve(false); });
                newOk.addEventListener('click', () => { dialog.style.display = 'none'; resolve(true); });
                dialog.style.display = 'block';
            });
        }

        // API 弹窗相关
        function openApiModal() { document.getElementById('apiDialog').style.display = 'block'; loadApiKey(true); }
        function closeApiModal() { document.getElementById('apiDialog').style.display = 'none'; }
        function loadApiKey(updateUi = false) {
            const key = localStorage.getItem('deepseek_api_key');
            if (updateUi) {
                document.getElementById('api-key-input').value = key || '';
                updateApiStatus(!!key);
            }
        }
        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if(!key) return showToast("不能为空");
            localStorage.setItem('deepseek_api_key', key);
            closeApiModal();
            showToast("已保存");
        }
        function updateApiStatus(hasKey, isVerified = false) {
            const el = document.getElementById('api-status');
            if (isVerified) el.innerHTML = '<i class="fas fa-check-circle" style="color:#07c160"></i> 已验证';
            else if (hasKey) el.innerHTML = '<i class="fas fa-exclamation-circle" style="color:#fa9d3b"></i> 待验证';
            else el.innerHTML = '<i class="fas fa-circle" style="font-size:8px; color:#ccc"></i> 未配置';
        }
        async function testConnection() {
            const key = document.getElementById('api-key-input').value.trim();
            const statusEl = document.getElementById('api-status');
            statusEl.innerHTML = '<i class="weui-loading"></i> 测试中...';
            try {
                const res = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json'},
                    body: JSON.stringify({model:"deepseek-chat", messages:[{role:"user",content:"hi"}]})
                });
                if(res.ok) { updateApiStatus(true, true); showToast("连接成功"); } 
                else throw new Error();
            } catch(e) { statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#fa5151"></i> 连接失败'; }
        }
        function bindSearchBar() {
            const bar = document.getElementById('searchBar');
            const input = document.getElementById('searchInput');
            document.getElementById('searchText').addEventListener('click', () => { bar.classList.add('weui-search-bar_focusing'); input.focus(); });
            document.getElementById('searchCancel').addEventListener('click', () => { 
                bar.classList.remove('weui-search-bar_focusing'); 
                input.value = ''; 
                handleSearch(''); 
            });
            document.getElementById('searchClear').addEventListener('click', () => { 
                input.value = ''; 
                input.focus(); 
                handleSearch(''); 
            });
        }
    </script>
</body>
</html>
