<!DOCTYPE html>
<html lang="zh-CN" data-weui-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>树洞便签</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/t/wx_fed/weui-source/res/2.6.25/weui.min.css"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* --- 全局与基础 --- */
        :root {
            --weui-BRAND: #07c160;
            --card-gap: 12px;
        }

        body {
            background-color: var(--weui-BG-0);
            color: var(--weui-FG-0);
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
            margin: 0;
        }

        /* --- 顶部导航 --- */
        .app-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--weui-BG-2);
            position: sticky; top: 0; z-index: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .icon-btn {
            width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            color: var(--weui-BRAND); border-radius: 50%;
            background: rgba(7, 193, 96, 0.1); transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(7, 193, 96, 0.2); }

        /* --- 搜索与过滤 --- */
        .weui-search-bar { background-color: var(--weui-BG-0); padding: 8px 16px; }
        .weui-search-bar:before, .weui-search-bar:after { display: none; }

        .tag-filter-container {
            padding: 10px 16px; overflow-x: auto; white-space: nowrap;
            background-color: var(--weui-BG-0); position: sticky; top: 62px;
            z-index: 400; border-bottom: 1px solid var(--weui-FG-3);
            scrollbar-width: none;
        }
        .tag-filter-container::-webkit-scrollbar { display: none; }
        
        .filter-tag {
            display: inline-block; padding: 6px 14px; border-radius: 20px;
            background-color: var(--weui-BG-2); color: var(--weui-FG-1);
            font-size: 13px; margin-right: 8px; border: 1px solid transparent;
        }
        .filter-tag.active {
            background-color: rgba(7, 193, 96, 0.1); color: var(--weui-BRAND);
            border-color: var(--weui-BRAND); font-weight: 600;
        }

        /* --- 瀑布流布局 --- */
        .memo-grid {
            column-count: 2; column-gap: var(--card-gap); padding: 16px; min-height: 200px;
        }
        @media (min-width: 600px) { .memo-grid { column-count: 3; } }

        .memo-card {
            break-inside: avoid; margin-bottom: var(--card-gap);
            background-color: var(--weui-BG-2); border-radius: 12px;
            padding: 14px; position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid transparent;
        }
        [data-weui-theme='dark'] .memo-card { border: 1px solid rgba(255,255,255,0.08); box-shadow: none; }
        .memo-card.pinned { border: 1.5px solid var(--weui-BRAND); }

        .memo-content {
            font-size: 15px; line-height: 1.6; margin-bottom: 10px;
            word-break: break-all; white-space: pre-wrap;
        }
        .memo-content.done { text-decoration: line-through; color: var(--weui-FG-2); opacity: 0.6; }

        .tag-mini {
            display: inline-block; font-size: 10px; padding: 1px 6px;
            border-radius: 4px; margin-right: 4px; margin-bottom: 4px; font-weight: 500;
        }
        .tag-work { color: #6750A4; background-color: rgba(103, 80, 164, 0.12); }
        .tag-study { color: #2196F3; background-color: rgba(33, 150, 243, 0.12); }
        .tag-life { color: #FF9800; background-color: rgba(255, 152, 0, 0.12); }
        .tag-inspire { color: #E91E63; background-color: rgba(233, 30, 99, 0.12); }

        .memo-footer {
            display: flex; justify-content: space-between; align-items: center;
            padding-top: 10px; border-top: 1px solid var(--weui-FG-3); margin-top: 6px;
        }
        .memo-time { font-size: 10px; color: var(--weui-FG-2); }
        .memo-actions { display: flex; gap: 10px; }
        .action-icon { font-size: 18px; color: var(--weui-FG-1); cursor: pointer; }

        /* --- 空状态修复 --- */
        .empty-state {
            column-span: all; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 80px 0; color: var(--weui-FG-2); text-align: center; width: 100%;
        }
        .empty-state .material-icons { font-size: 56px; opacity: 0.2; margin-bottom: 12px; }

        /* --- 对话框 --- */
        .dialog-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            display: none; opacity: 0; transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }
        .dialog-overlay.show { display: flex; opacity: 1; }

        .half-screen-dialog {
            position: absolute; bottom: 0; width: 100%; max-height: 85vh;
            background: var(--weui-BG-2); border-radius: 20px 20px 0 0;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
            display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom);
        }
        .dialog-overlay.show .half-screen-dialog { transform: translateY(0); }

        .dialog-textarea {
            width: 100%; min-height: 150px; padding: 14px; box-sizing: border-box;
            border: none; background: var(--weui-BG-1); color: var(--weui-FG-0);
            font-size: 16px; resize: none; border-radius: 12px; font-family: inherit;
        }

        .custom-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px;
            border-radius: 24px; font-size: 14px; display: none; align-items: center; gap: 8px; z-index: 2000;
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div style="font-size: 20px; font-weight: 700;">树洞便签</div>
        <div class="icon-btn" onclick="openCreateDialog()">
            <span class="material-icons">add</span>
        </div>
    </header>

    <div class="weui-search-bar" id="searchBar">
        <form class="weui-search-bar__form">
            <div class="weui-search-bar__box">
                <i class="weui-icon-search"></i>
                <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索内容..."/>
                <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
            </div>
            <label class="weui-search-bar__label" id="searchText"><i class="weui-icon-search"></i><span>搜索</span></label>
        </form>
        <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
    </div>

    <div class="tag-filter-container" id="tagFilterBar">
        <div class="filter-tag active" data-tag="all" onclick="filterByTag('all')">全部</div>
        <div class="filter-tag" data-tag="工作" onclick="filterByTag('工作')">工作</div>
        <div class="filter-tag" data-tag="学习" onclick="filterByTag('学习')">学习</div>
        <div class="filter-tag" data-tag="生活" onclick="filterByTag('生活')">生活</div>
        <div class="filter-tag" data-tag="灵感" onclick="filterByTag('灵感')">灵感</div>
    </div>

    <div class="memo-grid" id="postList"></div>

    <div id="createDialog" class="dialog-overlay" onclick="closeDialogOnOverlay(event, 'createDialog')">
        <div class="half-screen-dialog" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; align-items:center; padding:16px; border-bottom:1px solid var(--weui-FG-3)">
                <span class="material-icons" onclick="closeDialog('createDialog')" style="color:var(--weui-FG-1); cursor:pointer">close</span>
                <div id="dialogTitle" style="font-weight:700">新便签</div>
                <div onclick="postMessage()" style="color:var(--weui-BRAND); font-weight:700; cursor:pointer">保存</div>
            </div>
            
            <div style="padding:16px; overflow-y:auto">
                <textarea id="content" class="dialog-textarea" placeholder="记录这一刻的想法..." maxlength="200"></textarea>
                <div style="text-align:right; font-size:11px; color:var(--weui-FG-2); margin: 8px 0;">
                    <span id="wordCount">0</span>/200
                </div>

                <div style="font-size:13px; color:var(--weui-FG-1); margin-bottom:12px; font-weight:500">选择分类</div>
                <div id="dialogTagSelect" style="display:flex; flex-wrap:wrap; gap:8px">
                    <div class="filter-tag" onclick="toggleDialogTag(this, '工作')">工作</div>
                    <div class="filter-tag" onclick="toggleDialogTag(this, '学习')">学习</div>
                    <div class="filter-tag" onclick="toggleDialogTag(this, '生活')">生活</div>
                    <div class="filter-tag" onclick="toggleDialogTag(this, '灵感')">灵感</div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmDialog" class="dialog-overlay" onclick="closeDialogOnOverlay(event, 'confirmDialog')">
        <div style="margin:auto; width:280px; background:var(--weui-BG-2); border-radius:16px; overflow:hidden;">
            <div style="padding:32px 20px; text-align:center; font-size:16px;">确定删除这条便签吗？</div>
            <div style="display:flex; border-top:1px solid var(--weui-FG-3)">
                <div style="flex:1; padding:14px; text-align:center; color:var(--weui-FG-1); cursor:pointer" onclick="closeDialog('confirmDialog')">取消</div>
                <div style="flex:1; padding:14px; text-align:center; color:#FA5151; font-weight:700; border-left:1px solid var(--weui-FG-3); cursor:pointer" onclick="handleDeleteConfirm()">删除</div>
            </div>
        </div>
    </div>

    <div id="customToast" class="custom-toast">
        <span class="material-icons" id="toastIcon" style="font-size:18px">check_circle</span>
        <span id="toastText">已保存</span>
    </div>

    <script>
        let posts = JSON.parse(localStorage.getItem('memoPosts')) || [];
        let selectedTags = new Set();
        let currentSearch = '';
        let activeTagFilter = 'all';
        let deleteTargetId = null;
        let editingId = null;

        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            renderPosts();
            setupSearch();
            setupTextarea();
        });

        function initTheme() {
            const setTheme = () => {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-weui-theme', isDark ? 'dark' : 'light');
            };
            setTheme();
            window.matchMedia('(prefers-color-scheme: dark)').addListener(setTheme);
        }

        function setupSearch() {
            const $bar = document.getElementById('searchBar');
            const $input = document.getElementById('searchInput');
            document.getElementById('searchText').onclick = () => $bar.classList.add('weui-search-bar_focusing');
            document.getElementById('searchCancel').onclick = () => {
                $bar.classList.remove('weui-search-bar_focusing');
                $input.value = ''; currentSearch = ''; renderPosts();
            };
            document.getElementById('searchClear').onclick = () => {
                $input.value = ''; currentSearch = ''; renderPosts();
            };
            $input.oninput = (e) => { currentSearch = e.target.value.toLowerCase(); renderPosts(); };
        }

        // --- 核心修复：文字限制逻辑 ---
        function setupTextarea() {
            const el = document.getElementById('content');
            const counter = document.getElementById('wordCount');
            
            el.addEventListener('input', function() {
                // 1. 强制截断：如果因为粘贴或 IME 导致超标，立即截断
                if (this.value.length > 200) {
                    this.value = this.value.substring(0, 200);
                }
                
                // 2. 更新计数器
                counter.innerText = this.value.length;
                
                // 3. 高度自适应
                this.style.height = 'auto'; 
                this.style.height = this.scrollHeight + 'px';
            });
        }

        function openCreateDialog(isEdit = false, postData = null) {
            const dialog = document.getElementById('createDialog');
            const textarea = document.getElementById('content');
            const title = document.getElementById('dialogTitle');
            
            editingId = isEdit ? postData.id : null;
            title.innerText = isEdit ? '编辑便签' : '新便签';
            
            // 脚本赋值时也进行截断处理
            let rawContent = isEdit ? postData.content : '';
            textarea.value = rawContent.substring(0, 200);
            
            textarea.style.height = '150px';
            document.getElementById('wordCount').innerText = textarea.value.length;
            
            selectedTags.clear();
            const tagEls = document.querySelectorAll('#dialogTagSelect .filter-tag');
            tagEls.forEach(el => {
                const tag = el.innerText;
                if (isEdit && postData.tags.includes(tag)) {
                    el.classList.add('active');
                    selectedTags.add(tag);
                } else {
                    el.classList.remove('active');
                }
            });

            dialog.style.display = 'flex';
            dialog.offsetHeight;
            dialog.classList.add('show');
            setTimeout(() => textarea.focus(), 300);
        }

        function closeDialog(id) {
            document.getElementById(id).classList.remove('show');
            setTimeout(() => { document.getElementById(id).style.display = 'none'; }, 300);
        }

        function closeDialogOnOverlay(e, id) { if (e.target.id === id) closeDialog(id); }

        function toggleDialogTag(el, tag) {
            el.classList.toggle('active');
            selectedTags.has(tag) ? selectedTags.delete(tag) : selectedTags.add(tag);
        }

        function postMessage() {
            let content = document.getElementById('content').value.trim();
            if (!content) return showToast('内容不能为空哦', 'info');

            // 最后关卡：确保存入的内容绝对不超标
            content = content.substring(0, 200);

            if (editingId) {
                const index = posts.findIndex(p => p.id === editingId);
                posts[index] = { ...posts[index], content, tags: Array.from(selectedTags) };
                showToast('修改成功');
            } else {
                const newPost = {
                    id: Date.now(),
                    content,
                    tags: Array.from(selectedTags),
                    timestamp: Date.now(),
                    done: false,
                    pinned: false
                };
                posts.unshift(newPost);
                showToast('已保存');
            }
            
            saveAndRender();
            closeDialog('createDialog');
        }

        function editPost(id) {
            const post = posts.find(p => p.id === id);
            openCreateDialog(true, post);
        }

        function togglePin(id) {
            const post = posts.find(p => p.id === id);
            post.pinned = !post.pinned;
            saveAndRender();
        }

        function toggleDone(id) {
            const post = posts.find(p => p.id === id);
            post.done = !post.done;
            saveAndRender();
        }

        function confirmDelete(id) {
            deleteTargetId = id;
            const d = document.getElementById('confirmDialog');
            d.style.display = 'flex'; d.offsetHeight; d.classList.add('show');
        }

        function handleDeleteConfirm() {
            posts = posts.filter(p => p.id !== deleteTargetId);
            saveAndRender();
            closeDialog('confirmDialog');
            showToast('已删除', 'info');
        }

        function filterByTag(tag) {
            activeTagFilter = tag;
            document.querySelectorAll('#tagFilterBar .filter-tag').forEach(el => {
                el.classList.toggle('active', el.dataset.tag === tag);
            });
            renderPosts();
        }

        function saveAndRender() {
            localStorage.setItem('memoPosts', JSON.stringify(posts));
            renderPosts();
        }

        function renderPosts() {
            const container = document.getElementById('postList');
            const filtered = posts.filter(post => {
                const matchTag = activeTagFilter === 'all' || (post.tags && post.tags.includes(activeTagFilter));
                const matchSearch = !currentSearch || post.content.toLowerCase().includes(currentSearch);
                return matchTag && matchSearch;
            }).sort((a, b) => (b.pinned - a.pinned) || (b.timestamp - a.timestamp));

            if (filtered.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">inventory_2</span>
                    <p>${currentSearch ? '没找到相关内容' : '空空如也，记点什么吧'}</p>
                </div>`;
                return;
            }

            container.innerHTML = filtered.map(post => {
                const tagsHtml = (post.tags || []).map(tag => {
                    const cls = tag === '工作' ? 'tag-work' : tag === '学习' ? 'tag-study' : tag === '生活' ? 'tag-life' : 'tag-inspire';
                    return `<span class="tag-mini ${cls}">${tag}</span>`;
                }).join('');

                return `
                <div class="memo-card ${post.pinned ? 'pinned' : ''}">
                    <div class="memo-content ${post.done ? 'done' : ''}">${escapeHtml(post.content)}</div>
                    <div>${tagsHtml}</div>
                    <div class="memo-footer">
                        <div class="memo-time">${formatTime(post.timestamp)}</div>
                        <div class="memo-actions">
                            <span class="material-icons action-icon" onclick="togglePin(${post.id})" style="color:${post.pinned ? 'var(--weui-BRAND)' : ''}">push_pin</span>
                            <span class="material-icons action-icon" onclick="editPost(${post.id})">edit_note</span>
                            <span class="material-icons action-icon" onclick="toggleDone(${post.id})" style="color:${post.done ? 'var(--weui-BRAND)' : ''}">${post.done ? 'check_circle' : 'radio_button_unchecked'}</span>
                            <span class="material-icons action-icon" onclick="confirmDelete(${post.id})" style="color:#FA5151; font-size:17px">delete_outline</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('customToast');
            const text = document.getElementById('toastText');
            const icon = document.getElementById('toastIcon');
            text.innerText = msg;
            icon.innerText = type === 'success' ? 'check_circle' : 'info';
            t.style.display = 'flex';
            setTimeout(() => { t.style.display = 'none'; }, 1800);
        }

        function formatTime(ts) {
            const d = new Date(ts);
            const now = new Date();
            const time = `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
            return d.toDateString() === now.toDateString() ? time : `${d.getMonth()+1}/${d.getDate()} ${time}`;
        }

        function escapeHtml(str) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return str.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
