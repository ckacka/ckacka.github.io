<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>AI 灵感厨房</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/open/libs/weui/2.4.4/weui.min.css"/>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f7;
            --card-bg: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #888888;
            --border-color: #eeeeee;
            --primary-color: #07c160;
            --danger-color: #fa5151;
            --fav-color: #ff9500;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #111111;
                --card-bg: #1c1c1e;
                --text-main: #e1e1e1;
                --text-sub: #777777;
                --border-color: #2c2c2e;
            }
        }

        body, html { height: 100%; width: 100%; background-color: var(--bg-color); color: var(--text-main); margin: 0; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        
        .page { height: 100%; display: flex; flex-direction: column; }
        .app-header { background: var(--card-bg); padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 0.5px solid var(--border-color); z-index: 100; }
        .app-title { font-size: 20px; font-weight: 700; }

        .app-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative; z-index: 10; }

        .empty-state { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: var(--text-sub); opacity: 0.6;
        }

        /* 列表项 */
        .swiped-cell { position: relative; overflow: hidden; margin: 12px 16px; border-radius: 16px; background-color: var(--danger-color); }
        .swiped-content { 
            position: relative; z-index: 2; background: var(--card-bg); 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 18px; 
        }
        .swiped-actions { position: absolute; top: 0; right: 0; bottom: 0; display: flex; z-index: 1; }
        .action-btn { display: flex; align-items: center; justify-content: center; width: 70px; color: white; font-size: 22px; cursor: pointer; }

        /* 底栏 */
        .weui-tabbar { background: var(--card-bg); height: 64px; display: flex; align-items: stretch; padding-bottom: env(safe-area-inset-bottom); z-index: 500; }
        .tabbar__item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; cursor: pointer; }
        .tabbar__item ion-icon { font-size: 24px; margin-bottom: 2px; color: var(--text-sub); }
        .tabbar__item.active ion-icon, .tabbar__item.active .weui-tabbar__label { color: var(--primary-color); }
        .weui-tabbar__label { font-size: 10px; margin: 0; line-height: 1; }

        .gen-trigger { flex: 0 0 80px; position: relative; display: flex; justify-content: center; }
        .gen-btn-circle { 
            position: absolute; top: -20px; width: 56px; height: 56px; 
            background: var(--primary-color); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(7,193,96,0.4);
            border: 4px solid var(--card-bg); color: white; transition: all 0.2s;
        }

        /* 详情页重构：纯净图标 */
        .detail-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 2000; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); overflow-y: auto; }
        .detail-page.active { transform: translateY(0); }
        .detail-header-img { height: 160px; background: linear-gradient(135deg, #07c160, #10ad7a); display: flex; align-items: flex-end; padding: 24px; color: white; }
        
        #detailDelBtn, #detailFavAction, #closeDetail { 
            background: transparent; border: none; font-size: 26px; display: flex; align-items: center; justify-content: center; padding: 8px;
        }
        #detailDelBtn { color: var(--danger-color); }
        #detailFavAction { color: var(--fav-color); }
        #closeDetail { color: white; font-size: 30px; }

        /* 紧凑版弹窗 */
        .gen-input-wrapper { background: var(--bg-color); border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; margin-bottom: 12px; }
        .gen-input-wrapper ion-icon { margin-right: 10px; color: var(--text-sub); font-size: 20px; }
        
        .loading-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
    </style>
</head>
<body>

<div class="page">
    <header class="app-header">
        <div class="app-title">AI 灵感厨房</div>
        <div id="settingsBtn" style="font-size: 24px; color: var(--primary-color);"><ion-icon name="key-outline"></ion-icon></div>
    </header>

    <div class="weui-search-bar" id="searchBar">
        <form class="weui-search-bar__form">
            <div class="weui-search-bar__box">
                <i class="weui-icon-search"></i>
                <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索我的菜谱..."/>
            </div>
        </form>
    </div>

    <div class="app-content" id="recipeContainer"></div>

    <nav class="weui-tabbar">
        <div class="tabbar__item active" id="tabExplore">
            <ion-icon name="compass-outline"></ion-icon>
            <p class="weui-tabbar__label">探索</p>
        </div>
        <div class="gen-trigger" id="openGenerateBtn">
            <div class="gen-btn-circle"><ion-icon name="sparkles" style="font-size: 28px;"></ion-icon></div>
            <p class="weui-tabbar__label" style="position: absolute; bottom: 10px; color: var(--primary-color); font-weight: bold;">点火</p>
        </div>
        <div class="tabbar__item" id="tabFav">
            <ion-icon name="heart-outline"></ion-icon>
            <p class="weui-tabbar__label">收藏</p>
        </div>
    </nav>
</div>

<div id="keyDialog" style="display: none; z-index: 5000; position: relative;">
    <div class="weui-mask"></div>
    <div class="weui-dialog" style="border-radius: 20px;">
        <div class="weui-dialog__hd"><strong class="weui-dialog__title">API 密钥设置</strong></div>
        <div class="weui-dialog__bd">
            <div style="background: var(--bg-color); border-radius: 12px; padding: 12px;">
                <input id="keyInput" class="weui-input" type="password" placeholder="粘贴 DeepSeek API Key" style="text-align: center;">
            </div>
        </div>
        <div class="weui-dialog__ft">
            <a href="javascript:" class="weui-dialog__btn weui-dialog__btn_default" id="closeKeyBtn">取消</a>
            <a href="javascript:" class="weui-dialog__btn weui-dialog__btn_primary" id="saveKeyBtn">确定</a>
        </div>
    </div>
</div>

<div class="weui-mask" id="dialogMask" style="display:none; z-index: 3000;"></div>
<div class="weui-half-screen-dialog" id="generateDialog" style="display:none; z-index: 4000; border-radius: 24px 24px 0 0;">
    <div class="weui-half-screen-dialog__hd">
        <div class="weui-half-screen-dialog__hd__side"><button id="closeDialogBtn" class="weui-icon-btn"><ion-icon name="close-outline" style="font-size: 24px;"></ion-icon></button></div>
        <div class="weui-half-screen-dialog__hd__main"><strong class="weui-half-screen-dialog__title">AI 魔法烹饪</strong></div>
    </div>
    <div class="weui-half-screen-dialog__bd" style="padding: 10px 20px 30px;">
        <div class="gen-input-wrapper">
            <ion-icon name="restaurant-outline"></ion-icon>
            <input class="weui-input" id="ingredientsInput" placeholder="有哪些食材？(如：番茄、蛋)">
        </div>
        <div class="gen-input-wrapper" style="margin-bottom: 24px;">
            <ion-icon name="color-palette-outline"></ion-icon>
            <input class="weui-input" id="styleInput" placeholder="想吃什么口味？(如：酸甜、减脂)">
        </div>
        <button class="weui-btn weui-btn_primary" id="startGenBtn" style="border-radius: 14px; height: 50px; font-weight: bold;">
            开始点火生成
        </button>
    </div>
</div>

<div class="detail-page" id="detailPage">
    <div style="position: sticky; top: 0; padding: 12px; z-index: 100; display: flex; justify-content: space-between; align-items: center;">
        <button id="closeDetail"><ion-icon name="chevron-down-outline"></ion-icon></button>
        <div style="display: flex; gap: 4px;">
            <button id="detailFavAction"></button>
            <button id="detailDelBtn"><ion-icon name="trash-outline"></ion-icon></button>
        </div>
    </div>
    <div id="detailContent"></div>
</div>

<div class="loading-mask" id="loadingMask">
    <div style="background: white; padding: 30px; border-radius: 20px; display: flex; flex-direction: column; align-items: center;">
        <div class="weui-loading" style="width:40px; height:40px;"></div>
        <p style="margin-top: 15px; color: #333; font-weight: bold;">大厨正在备菜...</p>
    </div>
</div>

<div id="toast" style="display: none; z-index: 9999;"><div class="weui-mask_transparent"></div><div class="weui-toast" style="min-height: auto; padding: 16px;"><p class="weui-toast__content" id="toastMsg"></p></div></div>

<script>
    let recipes = JSON.parse(localStorage.getItem('ai_recipes_data')) || [];
    let favorites = JSON.parse(localStorage.getItem('ai_favs')) || [];
    let apiKey = localStorage.getItem('ai_api_key') || '';
    let currentTab = 'explore';
    let searchKeyword = '';

    const UI = {
        toast: (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1500);
        },
        toggleLoading: (show) => {
            document.getElementById('loadingMask').style.display = show ? 'flex' : 'none';
        }
    };

    function renderList() {
        const container = document.getElementById('recipeContainer');
        container.innerHTML = '';
        let list = currentTab === 'explore' ? recipes : recipes.filter(r => favorites.includes(r.id));
        if (searchKeyword) list = list.filter(r => r.title.includes(searchKeyword));

        if (list.length === 0) {
            container.innerHTML = `<div class="empty-state"><ion-icon name="pizza-outline" style="font-size:60px;"></ion-icon><p>没有发现灵感</p></div>`;
            return;
        }

        list.forEach(recipe => {
            const isFav = favorites.includes(recipe.id);
            const cell = document.createElement('div');
            cell.className = 'swiped-cell';
            cell.innerHTML = `
                <div class="swiped-actions">
                    <div class="action-btn" style="background:var(--fav-color)" onclick="handleFav(${recipe.id}, event)"><ion-icon name="${isFav?'heart':'heart-outline'}"></ion-icon></div>
                    <div class="action-btn" style="background:var(--danger-color)" onclick="handleDel(${recipe.id}, event)"><ion-icon name="trash-outline"></ion-icon></div>
                </div>
                <div class="swiped-content">
                    <div style="font-size:17px; font-weight:600;">${recipe.title}</div>
                    <div style="font-size:13px; color:var(--text-sub); margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${recipe.desc}</div>
                </div>
            `;
            const content = cell.querySelector('.swiped-content');
            content.onclick = () => openDetail(recipe);
            addSwipeListener(content);
            container.appendChild(cell);
        });
    }

    document.getElementById('startGenBtn').onclick = async () => {
        const ingredients = document.getElementById('ingredientsInput').value;
        const style = document.getElementById('styleInput').value;
        if (!apiKey) return UI.toast('请点击左上角设置 Key');
        if (!ingredients) return UI.toast('请输入食材');

        UI.toggleLoading(true);
        try {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        { role: "system", content: "你是一位精通全球美食的专业厨师。请根据食材给出菜谱。必须返回且仅返回JSON：{title, desc, ingredients:[], steps:[]}" },
                        { role: "user", content: `食材：${ingredients}，风格：${style}` }
                    ],
                    response_format: { type: "json_object" }
                })
            });
            const result = await response.json();
            const recipe = JSON.parse(result.choices[0].message.content);
            recipe.id = Date.now();
            recipes.unshift(recipe);
            localStorage.setItem('ai_recipes_data', JSON.stringify(recipes));
            document.getElementById('dialogMask').click();
            renderList();
            UI.toast('灵感已捕获！');
        } catch (err) { UI.toast('生成失败，请检查网络'); }
        UI.toggleLoading(false);
    };

    function openDetail(recipe) {
        const detailFav = document.getElementById('detailFavAction');
        const updateFavBtn = () => {
            const isFav = favorites.includes(recipe.id);
            detailFav.innerHTML = `<ion-icon name="${isFav?'heart':'heart-outline'}"></ion-icon>`;
        };
        updateFavBtn();
        detailFav.onclick = () => { handleFav(recipe.id); updateFavBtn(); };
        document.getElementById('detailDelBtn').onclick = () => { handleDel(recipe.id); document.getElementById('closeDetail').click(); };

        document.getElementById('detailContent').innerHTML = `
            <div class="detail-header-img"><h2>${recipe.title}</h2></div>
            <div style="background:var(--card-bg); margin-top:-24px; border-radius:24px 24px 0 0; padding:24px; min-height:60vh;">
                <p style="color:var(--text-sub); line-height:1.6; font-size:15px;">${recipe.desc}</p>
                <h3 style="margin:24px 0 12px; font-size:16px; color:var(--primary-color);">准备食材</h3>
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                    ${recipe.ingredients.map(i => `<span style="background:var(--bg-color); padding:6px 14px; border-radius:10px; font-size:14px;">${i}</span>`).join('')}
                </div>
                <h3 style="margin:28px 0 12px; font-size:16px; color:var(--primary-color);">烹饪步骤</h3>
                ${recipe.steps.map((s, idx) => `
                    <div style="display:flex; gap:12px; margin-bottom:18px;">
                        <span style="color:var(--primary-color); font-weight:700; font-size:16px;">${idx+1}</span>
                        <span style="font-size:15px; line-height:1.6; color:var(--text-main);">${s}</span>
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('detailPage').classList.add('active');
    }

    let startX = 0; let currentOpenCell = null;
    function addSwipeListener(el) {
        el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; if (currentOpenCell && currentOpenCell !== el) currentOpenCell.style.transform = 'translateX(0)'; });
        el.addEventListener('touchmove', e => { 
            let moveX = e.touches[0].clientX - startX; 
            if (moveX < 0 && moveX > -140) el.style.transform = `translateX(${moveX}px)`; 
        });
        el.addEventListener('touchend', e => { 
            let moveX = e.changedTouches[0].clientX - startX;
            if (moveX < -70) { el.style.transform = 'translateX(-140px)'; currentOpenCell = el; } 
            else { el.style.transform = 'translateX(0)'; currentOpenCell = null; }
        });
    }

    document.getElementById('settingsBtn').onclick = () => { 
        document.getElementById('keyInput').value = apiKey;
        document.getElementById('keyDialog').style.display = 'block'; 
    };
    document.getElementById('closeKeyBtn').onclick = () => { document.getElementById('keyDialog').style.display = 'none'; };
    document.getElementById('saveKeyBtn').onclick = () => { 
        apiKey = document.getElementById('keyInput').value; 
        localStorage.setItem('ai_api_key', apiKey); 
        document.getElementById('keyDialog').style.display = 'none'; 
        UI.toast('配置已保存');
    };

    document.getElementById('openGenerateBtn').onclick = () => { 
        document.getElementById('dialogMask').style.display = 'block'; 
        document.getElementById('generateDialog').style.display = 'block'; 
    };
    document.getElementById('dialogMask').onclick = document.getElementById('closeDialogBtn').onclick = () => { 
        document.getElementById('dialogMask').style.display = 'none'; 
        document.getElementById('generateDialog').style.display = 'none'; 
    };
    document.getElementById('closeDetail').onclick = () => document.getElementById('detailPage').classList.remove('active');

    window.handleFav = (id, e) => {
        if(e) e.stopPropagation();
        const idx = favorites.indexOf(id);
        idx > -1 ? favorites.splice(idx, 1) : favorites.push(id);
        localStorage.setItem('ai_favs', JSON.stringify(favorites));
        renderList();
    };
    window.handleDel = (id, e) => {
        if(e) e.stopPropagation();
        recipes = recipes.filter(r => r.id !== id);
        localStorage.setItem('ai_favs', JSON.stringify(favorites.filter(fid => fid !== id)));
        localStorage.setItem('ai_recipes_data', JSON.stringify(recipes));
        renderList();
    };

    document.getElementById('tabExplore').onclick = function() { currentTab = 'explore'; switchTab(this); };
    document.getElementById('tabFav').onclick = function() { currentTab = 'fav'; switchTab(this); };
    function switchTab(el) {
        document.querySelectorAll('.tabbar__item').forEach(t => {
            t.classList.remove('active');
            t.querySelector('ion-icon').setAttribute('name', t.querySelector('ion-icon').getAttribute('name').replace('-outline', '') + '-outline');
        });
        el.classList.add('active');
        const icon = el.querySelector('ion-icon');
        icon.setAttribute('name', icon.getAttribute('name').replace('-outline', ''));
        renderList();
    }

    document.getElementById('searchInput').oninput = (e) => { searchKeyword = e.target.value; renderList(); };

    renderList();
</script>
</body>
</html>
