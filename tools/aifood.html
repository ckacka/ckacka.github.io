<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>AI çµæ„Ÿå¨æˆ¿ Pro</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/t/wx_fed/weui-source/res/2.6.25/weui.min.css"/>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        :root {
            --bg-body: #f7f8fa;
            --bg-card: #ffffff;
            --text-main: #1f1f1f;
            --text-sub: #888888;
            --primary: #07c160;
            --danger: #fa5151;
            --warn: #ffbe00;
            --fav: #fa5151;
            --fav-inactive: #cccccc;
            --share: #5ac8fa;
            --input-bg: #eff0f2;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --time-color: #5ac8fa;
            --difficulty-easy: #07c160;
            --difficulty-medium: #ff9500;
            --difficulty-hard: #fa5151;
            --tag-bg: #f2f2f7;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #111111;
                --bg-card: #1c1c1e;
                --text-main: #e1e1e1;
                --text-sub: #777777;
                --input-bg: #2c2c2e;
                --primary: #07c160;
                --danger: #fa5151;
                --warn: #ffbe00;
                --fav: #fa5151;
                --fav-inactive: #666666;
                --share: #5ac8fa;
                --time-color: #5ac8fa;
                --difficulty-easy: #07c160;
                --difficulty-medium: #ff9500;
                --difficulty-hard: #fa5151;
                --tag-bg: #2c2c2e;
            }
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body, html { 
            height: 100%; 
            background: var(--bg-body); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; 
            overflow: hidden; 
            margin: 0;
        }
        
        .page { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .app-header {
            background: var(--bg-card);
            padding: calc(var(--safe-top) + 16px) 20px 16px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: relative;
            z-index: 10;
        }
        .app-title { 
            font-size: 24px; 
            font-weight: 800; 
            letter-spacing: -0.5px; 
        }

        /* æœç´¢æ  */
        .search-container { 
            background: var(--bg-card); 
            padding: 0 20px 16px 20px; 
            position: relative;
            z-index: 10;
        }
        .search-box {
            background: var(--input-bg); 
            border-radius: 12px; 
            height: 44px;
            display: flex; 
            align-items: center; 
            padding: 0 16px;
        }
        .search-box ion-icon { 
            font-size: 20px; 
            color: var(--text-sub); 
            margin-right: 8px; 
            min-width: 20px;
        }
        .search-input { 
            border: none; 
            background: transparent; 
            flex: 1; 
            height: 100%; 
            font-size: 16px; 
            color: var(--text-main); 
            outline: none; 
            font-family: inherit;
        }

        /* å†…å®¹åŒº */
        .app-content { 
            flex: 1; 
            overflow-y: auto; 
            padding-top: 12px; 
            padding-bottom: 100px; 
            -webkit-overflow-scrolling: touch; 
            scrollbar-width: none; 
        }
        .app-content::-webkit-scrollbar {
            display: none; 
        }

        /* èœè°±å¡ç‰‡ */
        .recipe-card-wrapper { 
            position: relative; 
            overflow: hidden; 
            margin: 0 16px 12px; 
            border-radius: 18px; 
            background: transparent;
        }
        .recipe-card {
            position: relative; 
            z-index: 2; 
            background: var(--bg-card); 
            padding: 20px;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: flex; 
            align-items: center;
            border-radius: 18px;
            cursor: pointer;
            user-select: none;
            touch-action: pan-y;
            will-change: transform;
        }
        .recipe-info { 
            flex: 1; 
            min-width: 0; 
            margin-right: 12px;
        }
        .recipe-title { 
            font-size: 18px; 
            font-weight: 700; 
            margin-bottom: 4px; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .recipe-desc { 
            font-size: 14px; 
            color: var(--text-sub); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* æ»‘åŠ¨æ“ä½œæŒ‰é’® */
        .swipe-actions { 
            position: absolute; 
            top: 0; 
            right: 0; 
            bottom: 0; 
            display: flex; 
            align-items: center;
            padding-right: 16px;
            gap: 8px;
            z-index: 1; 
        }
        .swipe-btn { 
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .swipe-btn.share { background: #5ac8fa; }
        .swipe-btn.fav { background: #fa5151; }
        .swipe-btn.fav-inactive { background: #cccccc; }
        .swipe-btn.delete { background: #fa5151; }
        
        @media (prefers-color-scheme: dark) {
            .swipe-btn.fav-inactive { background: #444; }
        }

        .swipe-btn:active { transform: scale(0.9); }

        /* åº•éƒ¨å¯¼èˆª */
        .tab-bar {
            background: var(--bg-card); 
            height: 70px; 
            display: flex; 
            align-items: center;
            border-top: 0.5px solid rgba(0,0,0,0.08); 
            padding-bottom: var(--safe-bottom);
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            z-index: 100;
        }
        .tab-item { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-sub); 
            font-size: 11px; 
            gap: 4px; 
            transition: 0.2s; 
            cursor: pointer;
            padding: 8px 0;
        }
        .tab-item.active { color: var(--primary); }
        .tab-item ion-icon { font-size: 26px; }

        /* ä¸­é—´ç”ŸæˆæŒ‰é’® */
        .gen-trigger {
            position: absolute; 
            left: 50%; 
            top: -25px; 
            transform: translateX(-50%);
            width: 64px; 
            height: 64px; 
            background: var(--primary); 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 8px 24px rgba(7, 193, 96, 0.35);
            color: white; 
            font-size: 32px; 
            border: 5px solid var(--bg-card);
            cursor: pointer;
            z-index: 101;
        }
        .gen-trigger:active { transform: translateX(-50%) scale(0.95); }

        /* å¯¹è¯æ¡† */
        .dialog-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .dialog-overlay.active { opacity: 1; }

        .custom-dialog {
            position: fixed; left: 50%; top: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 85%; max-width: 320px;
            background: var(--bg-card);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 2001;
            display: none;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .custom-dialog.active { transform: translate(-50%, -50%) scale(1); }

        /* åŠå±å¼¹çª— */
        .half-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            padding-bottom: calc(24px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 2001;
        }
        .half-sheet.active { transform: translateY(0); }

        /* è¯¦æƒ…é¡µ - æ”¹è¿›ç‰ˆ */
        .detail-modal {
            position: fixed; inset: 0;
            background: var(--bg-body); 
            z-index: 2000;
            transform: translateY(100%); 
            transition: transform 0.35s cubic-bezier(0.3, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .detail-modal.active { transform: translateY(0); }
        
        .nav-glass { 
            position: absolute; top: 0; left: 0; right: 0; 
            padding: calc(var(--safe-top) + 10px) 16px 10px; 
            display: flex; justify-content: space-between; 
            z-index: 10; 
        }
        .glass-btn {
            width: 40px; height: 40px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px); 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            color: #333; font-size: 22px; 
            border: none; cursor: pointer;
        }
        
        .detail-scroll { 
            flex: 1; overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }
        .detail-cover { 
            height: 300px; 
            background: linear-gradient(135deg, #07c160 0%, #05a050 100%); 
            display: flex; align-items: flex-end; 
            padding: 40px 24px; color: white; 
            position: relative;
        }
        .detail-header {
            width: 100%;
        }
        .detail-content { 
            background: var(--bg-card); 
            margin-top: -30px; 
            border-radius: 32px 32px 0 0; 
            padding: 30px 24px 100px; 
            min-height: 60vh; 
        }

        /* è¯¦æƒ…é¡µå…ƒä¿¡æ¯å¡ç‰‡ */
        .meta-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0 30px;
        }
        .meta-card {
            background: var(--tag-bg);
            border-radius: 12px;
            padding: 14px 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .meta-icon {
            font-size: 20px;
            margin-bottom: 6px;
        }
        .meta-label {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 4px;
        }
        .meta-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .tag {
            display: inline-flex;
            align-items: center;
            background: var(--tag-bg);
            border-radius: 16px;
            padding: 6px 12px;
            font-size: 13px;
            margin: 0 8px 8px 0;
            gap: 4px;
        }
        .tag.time { color: var(--time-color); }
        .tag.difficulty-easy { color: var(--difficulty-easy); }
        .tag.difficulty-medium { color: var(--difficulty-medium); }
        .tag.difficulty-hard { color: var(--difficulty-hard); }
        
        /* åŠ è½½ä¸­ */
        .loading-mask {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        .loading-box {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        /* Toast */
        #toast {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 15px;
            z-index: 3001;
            display: none;
            backdrop-filter: blur(4px);
        }

        /* æš—é»‘æ¨¡å¼ä¿®æ­£ */
        @media (prefers-color-scheme: dark) {
            .glass-btn { background: rgba(40,40,40,0.8); color: white; }
            .tab-bar { border-top-color: rgba(255,255,255,0.1); }
            .swipe-btn { border-color: rgba(255,255,255,0.1); }
        }
        
        /* è¾…åŠ©æ ·å¼ */
        .input-wrap {
            background: var(--input-bg);
            border-radius: 12px;
            padding: 4px 16px;
            margin-bottom: 16px;
            display: flex; align-items: center;
            height: 52px;
        }
        .input-wrap ion-icon { font-size: 20px; color: var(--text-sub); margin-right: 12px; }
        .input-wrap input {
            border: none; background: transparent; flex: 1;
            font-size: 16px; color: var(--text-main); height: 100%; outline: none;
        }
        .btn-block {
            width: 100%; height: 50px;
            border-radius: 14px;
            border: none; font-size: 16px; font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--input-bg); color: var(--text-main); }
        .btn-danger { background: var(--danger); color: white; }
        
        /* æ­¥éª¤å¡ç‰‡ */
        .step-card {
            background: var(--tag-bg);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 16px;
            display: flex;
            gap: 14px;
            transition: transform 0.2s;
        }
        .step-card:active { transform: scale(0.98); }
        .step-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }
        .step-text {
            flex: 1;
            line-height: 1.5;
            padding-top: 4px;
        }
        
        /* è¥å…»æˆåˆ†æ ‡ç­¾ */
        .nutrition-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0 25px;
        }
        .nutrition-tag {
            background: var(--primary);
            opacity: 0.9;
            color: white;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="page">
    <header class="app-header">
        <div class="app-title">AI çµæ„Ÿå¨æˆ¿</div>
        <div id="settingsBtn" style="font-size: 28px; color: var(--primary); cursor: pointer; padding: 4px;">
            <ion-icon name="settings-outline"></ion-icon>
        </div>
    </header>

    <div class="search-container">
        <div class="search-box">
            <ion-icon name="search-outline"></ion-icon>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢èœè°±æˆ–é£Ÿæ...">
        </div>
    </div>

    <div class="app-content" id="recipeContainer">
        <!-- èœè°±åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="tabExplore" onclick="app.switchTab('explore')">
            <ion-icon name="compass"></ion-icon>
            <span>å‘ç°</span>
        </div>
        <div class="gen-trigger" onclick="app.openGenDialog()">
            <ion-icon name="sparkles"></ion-icon>
        </div>
        <div class="tab-item" id="tabFav" onclick="app.switchTab('fav')">
            <ion-icon name="heart-outline"></ion-icon>
            <span>æ”¶è—</span>
        </div>
    </div>
</div>

<div class="dialog-overlay" id="overlay"></div>

<div class="custom-dialog" id="keyDialog">
    <h3 style="text-align:center; margin:0 0 16px;">è®¾ç½® API Key</h3>
    <div class="input-wrap">
        <ion-icon name="key-outline"></ion-icon>
        <input id="keyInput" type="password" placeholder="è¾“å…¥ DeepSeek API Key">
        <ion-icon name="eye-outline" onclick="app.togglePwd()" style="margin-right:0; margin-left:8px; cursor:pointer;"></ion-icon>
    </div>
    <div style="display:flex; gap:12px;">
        <button class="btn-block btn-secondary" onclick="app.closeDialogs()">å–æ¶ˆ</button>
        <button class="btn-block btn-primary" onclick="app.saveKey()">ä¿å­˜</button>
    </div>
</div>

<div class="half-sheet" id="genDialog">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; font-size:20px;">ä»Šå¤©åƒç‚¹ä»€ä¹ˆï¼Ÿ</h3>
        <ion-icon name="close-circle" style="font-size:28px; color:var(--text-sub);" onclick="app.closeDialogs()"></ion-icon>
    </div>
    <div class="input-wrap">
        <ion-icon name="basket-outline" style="color:var(--primary)"></ion-icon>
        <input id="ingredientsInput" placeholder="å†°ç®±é‡Œæœ‰å“ªäº›é£Ÿæï¼Ÿ">
    </div>
    <div class="input-wrap">
        <ion-icon name="restaurant-outline" style="color:var(--warn)"></ion-icon>
        <input id="styleInput" placeholder="æƒ³å°è¯•ä»€ä¹ˆå£å‘³ï¼Ÿ(ä¾‹ï¼šå·èœ/å‡è„‚)">
    </div>
    <button class="btn-block btn-primary" onclick="app.generateRecipe()">
        <ion-icon name="flash" style="margin-right:8px;"></ion-icon> å¼€å§‹ç”Ÿæˆ
    </button>
</div>

<!-- æ”¹è¿›çš„è¯¦æƒ…é¡µ -->
<div class="detail-modal" id="detailPage">
    <div class="nav-glass">
        <button class="glass-btn" onclick="app.closeDetail()"><ion-icon name="chevron-down"></ion-icon></button>
        <div style="display: flex; gap: 12px;">
            <button class="glass-btn" onclick="app.shareCurrent()" style="color: var(--share);">
                <ion-icon name="share-outline"></ion-icon>
            </button>
            <button class="glass-btn" id="detailFavBtn" onclick="app.toggleFavCurrent()">
                <ion-icon name="heart-outline"></ion-icon>
            </button>
            <button class="glass-btn" onclick="app.askDeleteCurrent()" style="color: var(--danger);">
                <ion-icon name="trash-outline"></ion-icon>
            </button>
        </div>
    </div>
    <div class="detail-scroll">
        <div class="detail-cover">
            <div class="detail-header">
                <h1 id="detailTitle" style="font-size: 28px; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.3); margin:0 0 12px 0;"></h1>
                <p id="detailDesc" style="font-size: 16px; opacity: 0.95; margin: 0;"></p>
                
                <!-- æ ‡ç­¾åŒºåŸŸ -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                    <span id="detailTime" class="tag time" style="display: none;">
                        <ion-icon name="time-outline" style="font-size: 14px;"></ion-icon>
                        <span id="timeValue"></span>
                    </span>
                    <span id="detailDifficulty" class="tag difficulty-easy" style="display: none;">
                        <ion-icon name="speedometer-outline" style="font-size: 14px;"></ion-icon>
                        <span id="difficultyValue"></span>
                    </span>
                </div>
            </div>
        </div>
        <div class="detail-content">
            <!-- è¥å…»æˆåˆ†æ ‡ç­¾ -->
            <div class="nutrition-tags" id="nutritionTags">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- å…ƒä¿¡æ¯å¡ç‰‡ -->
            <div class="meta-grid">
                <div class="meta-card">
                    <ion-icon name="time-outline" class="meta-icon" style="color: var(--time-color);"></ion-icon>
                    <div class="meta-label">å‡†å¤‡æ—¶é—´</div>
                    <div class="meta-value" id="prepTime">20åˆ†é’Ÿ</div>
                </div>
                <div class="meta-card">
                    <ion-icon name="flame-outline" class="meta-icon" style="color: var(--fav);"></ion-icon>
                    <div class="meta-label">çƒ¹é¥ªæ—¶é—´</div>
                    <div class="meta-value" id="cookTime">30åˆ†é’Ÿ</div>
                </div>
                <div class="meta-card">
                    <ion-icon name="people-outline" class="meta-icon" style="color: var(--primary);"></ion-icon>
                    <div class="meta-label">ä»½é‡</div>
                    <div class="meta-value" id="servings">2-3äºº</div>
                </div>
            </div>

            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center;">
                <ion-icon name="receipt-outline" style="color: var(--primary); margin-right: 8px;"></ion-icon> é£Ÿææ¸…å•
            </h3>
            <div id="detailIngredients" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 30px;"></div>

            <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center;">
                <ion-icon name="flame-outline" style="color: var(--fav); margin-right: 8px;"></ion-icon> çƒ¹é¥ªæ­¥éª¤
            </h3>
            <div id="detailSteps" style="display: flex; flex-direction: column; gap: 12px;"></div>
            
            <!-- å°è´´å£« -->
            <div id="detailTips" style="margin-top: 40px; display: none;">
                <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center;">
                    <ion-icon name="bulb-outline" style="color: var(--warn); margin-right: 8px;"></ion-icon> å°è´´å£«
                </h3>
                <div id="tipsContent" style="background: var(--tag-bg); border-radius: 16px; padding: 18px; line-height: 1.6;"></div>
            </div>
        </div>
    </div>
</div>

<div class="custom-dialog" id="deleteDialog">
    <div style="text-align:center; padding: 10px 0 20px;">
        <ion-icon name="alert-circle" style="font-size:48px; color:var(--danger);"></ion-icon>
        <h3 style="margin:10px 0 8px;">ç¡®è®¤åˆ é™¤ï¼Ÿ</h3>
        <p style="color:var(--text-sub); font-size:14px; margin:0;">åˆ é™¤åæ— æ³•æ¢å¤è¯¥çµæ„Ÿèœè°±</p>
    </div>
    <div style="display:flex; gap:12px;">
        <button class="btn-block btn-secondary" onclick="app.closeDialogs()">å†æƒ³æƒ³</button>
        <button class="btn-block btn-danger" onclick="app.confirmDelete()">åˆ é™¤</button>
    </div>
</div>

<div class="loading-mask" id="loadingMask">
    <div class="loading-box">
        <div class="weui-loading" style="width: 40px; height: 40px; display: inline-block;"></div>
        <p style="margin: 15px 0 0; font-weight: 600; color: var(--text-main);">AI å¤§å¨æ€è€ƒä¸­...</p>
    </div>
</div>

<div id="toast">æç¤ºä¿¡æ¯</div>

<script>
    const app = {
        data: {
            recipes: JSON.parse(localStorage.getItem('ai_recipes_v4')) || [],
            favorites: JSON.parse(localStorage.getItem('ai_favs_v4')) || [],
            apiKey: localStorage.getItem('deepseek_key') || '',
            currentTab: 'explore',
            currentDetailId: null,
            pendingDeleteId: null,
            searchVal: '',
            swipeState: {}
        },

        init() {
            this.renderList();
            this.bindEvents();
            if (!this.data.apiKey) {
                setTimeout(() => this.toggleKeyDialog(true), 600);
            }
        },

        // --- UI æ“ä½œ ---
        
        toast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        },

        loading(show) {
            document.getElementById('loadingMask').style.display = show ? 'flex' : 'none';
        },

        toggleKeyDialog(show) {
            const el = document.getElementById('keyDialog');
            const overlay = document.getElementById('overlay');
            if(show) {
                document.getElementById('keyInput').value = this.data.apiKey;
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('active'), 10);
                el.style.display = 'block';
                setTimeout(() => el.classList.add('active'), 10);
            } else {
                this.closeDialogs();
            }
        },

        openGenDialog() {
            if(!this.data.apiKey) return this.toast('è¯·å…ˆé…ç½® API Key');
            document.getElementById('ingredientsInput').value = '';
            document.getElementById('styleInput').value = '';
            
            const el = document.getElementById('genDialog');
            const overlay = document.getElementById('overlay');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.classList.add('active');
                el.classList.add('active');
            }, 10);
        },

        closeDialogs() {
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('active');
            setTimeout(() => overlay.style.display = 'none', 300);

            const keyDialog = document.getElementById('keyDialog');
            keyDialog.classList.remove('active');
            setTimeout(() => keyDialog.style.display = 'none', 300);

            document.getElementById('genDialog').classList.remove('active');

            const delDialog = document.getElementById('deleteDialog');
            delDialog.classList.remove('active');
            setTimeout(() => delDialog.style.display = 'none', 300);
        },

        togglePwd() {
            const input = document.getElementById('keyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        },

        saveKey() {
            const val = document.getElementById('keyInput').value.trim();
            if(!val) return this.toast('Key ä¸èƒ½ä¸ºç©º');
            this.data.apiKey = val;
            localStorage.setItem('deepseek_key', val);
            this.closeDialogs();
            this.toast('é…ç½®å·²ä¿å­˜');
        },

        switchTab(tab) {
            this.data.currentTab = tab;
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tab === 'explore' ? 'tabExplore' : 'tabFav').classList.add('active');
            
            const favIcon = document.querySelector('#tabFav ion-icon');
            favIcon.name = tab === 'fav' ? 'heart' : 'heart-outline';
            
            this.data.searchVal = '';
            document.getElementById('searchInput').value = '';
            this.renderList();
        },

        // --- æ ¸å¿ƒé€»è¾‘ ---

        async generateRecipe() {
            const ingredients = document.getElementById('ingredientsInput').value.trim();
            const style = document.getElementById('styleInput').value.trim() || 'å®¶å¸¸èœ';
            
            if (!ingredients) return this.toast('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªé£Ÿæ');
            
            this.closeDialogs();
            this.loading(true);

            try {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šå¤§å¨ã€‚è¯·æ ¹æ®é£Ÿæ[${ingredients}]å’Œé£æ ¼[${style}]åˆ›ä½œä¸€é“èœã€‚
                è¯·è¿”å›ä¸€ä¸ªä¸¥æ ¼çš„JSONå¯¹è±¡ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
                {
                    "title":"èœå",
                    "desc":"ä¸€å¥è¯è¯±äººæè¿°",
                    "ingredients":["é£Ÿæ1","é£Ÿæ2"],
                    "steps":["æ­¥éª¤1","æ­¥éª¤2"],
                    "prepTime":"å‡†å¤‡æ—¶é—´ï¼ˆå¦‚ï¼š15åˆ†é’Ÿï¼‰",
                    "cookTime":"çƒ¹é¥ªæ—¶é—´ï¼ˆå¦‚ï¼š20åˆ†é’Ÿï¼‰",
                    "servings":"ä»½é‡ï¼ˆå¦‚ï¼š2-3äººï¼‰",
                    "difficulty":"éš¾åº¦ï¼ˆeasy/medium/hardï¼‰",
                    "nutrition":["è¥å…»æ ‡ç­¾1","è¥å…»æ ‡ç­¾2"],
                    "tips":"çƒ¹é¥ªå°è´´å£«"
                }
                åªè¿”å›JSONï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ã€‚`;

                const res = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.data.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªè¾…åŠ©ç”ŸæˆJSONæ ¼å¼èœè°±çš„åŠ©æ‰‹ï¼Œè¯·åªè¾“å‡ºJSONã€‚" },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.8
                    })
                });

                if (res.status === 401) throw new Error('API Key æ— æ•ˆï¼Œè¯·æ£€æŸ¥è®¾ç½®');
                if (!res.ok) throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${res.status}`);

                const data = await res.json();
                let content = data.choices[0].message.content;
                
                content = content.replace(/```json\n?|```/g, '').trim();

                const recipe = JSON.parse(content);
                
                // å¢å¼ºæ ¡éªŒ
                if(!recipe.title || !recipe.steps) throw new Error('ç”Ÿæˆæ ¼å¼å¼‚å¸¸');

                const newRecipe = {
                    id: Date.now(),
                    title: recipe.title,
                    desc: recipe.desc || 'ç¾å‘³ä½³è‚´',
                    ingredients: recipe.ingredients || [],
                    steps: recipe.steps || [],
                    prepTime: recipe.prepTime || '15åˆ†é’Ÿ',
                    cookTime: recipe.cookTime || '20åˆ†é’Ÿ',
                    servings: recipe.servings || '2-3äºº',
                    difficulty: recipe.difficulty || 'medium',
                    nutrition: recipe.nutrition || ['å‡è¡¡è¥å…»'],
                    tips: recipe.tips || 'æ ¹æ®ä¸ªäººå£å‘³è°ƒæ•´è°ƒæ–™ç”¨é‡',
                    createdAt: new Date().toISOString()
                };

                this.data.recipes.unshift(newRecipe);
                this.saveData();
                this.switchTab('explore');
                this.toast('æ–°èœè°±å·²é€è¾¾ï¼');

            } catch (e) {
                console.error(e);
                this.toast(e.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                if(e.message.includes('Key')) setTimeout(() => this.toggleKeyDialog(true), 1500);
            } finally {
                this.loading(false);
            }
        },

        renderList() {
            const container = document.getElementById('recipeContainer');
            let list = this.data.currentTab === 'explore' ? this.data.recipes : this.data.recipes.filter(r => this.data.favorites.includes(r.id));
            
            if (this.data.searchVal) {
                const key = this.data.searchVal.toLowerCase();
                list = list.filter(r => r.title.toLowerCase().includes(key) || r.desc.toLowerCase().includes(key));
            }

            if (list.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding-top:80px; color:var(--text-sub);">
                        <ion-icon name="${this.data.currentTab==='explore'?'restaurant-outline':'heart-dislike-outline'}" style="font-size:64px; opacity:0.2;"></ion-icon>
                        <p style="margin-top:16px;">${this.data.searchVal ? 'æœªæ‰¾åˆ°ç›¸å…³èœè°±' : (this.data.currentTab==='explore'?'è¿˜æ²¡æœ‰çµæ„Ÿï¼Œç‚¹åº•éƒ¨ + å·ç”Ÿæˆå§':'è¿˜æ²¡æœ‰æ”¶è—')}</p>
                    </div>`;
                return;
            }

            container.innerHTML = list.map(item => {
                const isFav = this.data.favorites.includes(item.id);
                return `
                <div class="recipe-card-wrapper" data-id="${item.id}">
                    <div class="swipe-actions">
                        <div class="swipe-btn share" onclick="event.stopPropagation(); app.shareItem(${item.id})"><ion-icon name="share-outline"></ion-icon></div>
                        <div class="swipe-btn fav ${isFav?'':'fav-inactive'}" onclick="event.stopPropagation(); app.toggleFav(${item.id})">
                            <ion-icon name="${isFav?'heart':'heart-outline'}"></ion-icon>
                        </div>
                        <div class="swipe-btn delete" onclick="event.stopPropagation(); app.askDelete(${item.id})"><ion-icon name="trash-outline"></ion-icon></div>
                    </div>
                    <div class="recipe-card" onclick="app.openDetail(${item.id})">
                        <div class="recipe-info">
                            <div class="recipe-title">${this.escape(item.title)}</div>
                            <div class="recipe-desc">${this.escape(item.desc)}</div>
                        </div>
                        <ion-icon name="chevron-forward" style="color:var(--text-sub); opacity:0.3;"></ion-icon>
                    </div>
                </div>`;
            }).join('');

            document.querySelectorAll('.recipe-card').forEach(card => this.bindSwipe(card));
        },

        // --- æ‰‹åŠ¿ç³»ç»Ÿ ---
        bindSwipe(el) {
            const wrapper = el.closest('.recipe-card-wrapper');
            const id = wrapper.getAttribute('data-id');
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;
            let startTime = 0;

            el.addEventListener('touchstart', e => {
                document.querySelectorAll('.recipe-card').forEach(card => {
                    const cardWrapper = card.closest('.recipe-card-wrapper');
                    if (cardWrapper && cardWrapper !== wrapper && this.data.swipeState[cardWrapper.getAttribute('data-id')]) {
                        card.style.transform = 'translateX(0)';
                        this.data.swipeState[cardWrapper.getAttribute('data-id')] = false;
                    }
                });

                startX = e.touches[0].clientX;
                startTime = Date.now();
                el.style.transition = 'none';
                isSwiping = false;
            }, { passive: true });

            el.addEventListener('touchmove', e => {
                if (!el) return;
                
                const x = e.touches[0].clientX;
                const dx = x - startX;
                
                if (!isSwiping && Math.abs(dx) > 10) {
                    isSwiping = true;
                }
                
                if (isSwiping) {
                    if (dx < 0 && dx > -200) {
                        currentX = dx;
                        el.style.transform = `translateX(${dx}px)`;
                    }
                    e.preventDefault();
                }
            }, { passive: false });

            el.addEventListener('touchend', () => {
                if (!el) return;
                
                const elapsed = Date.now() - startTime;
                el.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                
                if (isSwiping) {
                    if (currentX < -60 || (elapsed < 300 && currentX < -30)) {
                        el.style.transform = 'translateX(-180px)';
                        this.data.swipeState[id] = true;
                    } else {
                        el.style.transform = 'translateX(0)';
                        this.data.swipeState[id] = false;
                    }
                } else {
                    el.style.transform = 'translateX(0)';
                    this.data.swipeState[id] = false;
                }
                
                currentX = 0;
                isSwiping = false;
            });
        },

        // --- è¯¦æƒ…é¡µ ---
        openDetail(id) {
            if (this.data.swipeState[id]) {
                const card = document.querySelector(`.recipe-card-wrapper[data-id="${id}"] .recipe-card`);
                card.style.transform = 'translateX(0)';
                this.data.swipeState[id] = false;
                return;
            }

            const item = this.data.recipes.find(r => r.id === id);
            if(!item) return;

            this.data.currentDetailId = id;
            
            // è®¾ç½®åŸºæœ¬ä¿¡æ¯
            document.getElementById('detailTitle').textContent = item.title;
            document.getElementById('detailDesc').textContent = item.desc;
            
            // è®¾ç½®æ—¶é—´æ ‡ç­¾
            if(item.prepTime || item.cookTime) {
                const totalTime = this.calculateTotalTime(item.prepTime, item.cookTime);
                document.getElementById('detailTime').style.display = 'inline-flex';
                document.getElementById('timeValue').textContent = totalTime;
            }
            
            // è®¾ç½®éš¾åº¦æ ‡ç­¾
            if(item.difficulty) {
                document.getElementById('detailDifficulty').style.display = 'inline-flex';
                document.getElementById('difficultyValue').textContent = 
                    item.difficulty === 'easy' ? 'ç®€å•' : 
                    item.difficulty === 'medium' ? 'ä¸­ç­‰' : 'å›°éš¾';
                    
                // æ›´æ–°éš¾åº¦é¢œè‰²
                const diffTag = document.getElementById('detailDifficulty');
                diffTag.className = `tag difficulty-${item.difficulty}`;
            }
            
            // è®¾ç½®å…ƒä¿¡æ¯
            document.getElementById('prepTime').textContent = item.prepTime || '15åˆ†é’Ÿ';
            document.getElementById('cookTime').textContent = item.cookTime || '20åˆ†é’Ÿ';
            document.getElementById('servings').textContent = item.servings || '2-3äºº';
            
            // è®¾ç½®è¥å…»æˆåˆ†æ ‡ç­¾
            const nutritionTags = document.getElementById('nutritionTags');
            if(item.nutrition && item.nutrition.length > 0) {
                nutritionTags.innerHTML = item.nutrition.map(n => 
                    `<span class="nutrition-tag">${this.escape(n)}</span>`
                ).join('');
                nutritionTags.style.display = 'flex';
            } else {
                nutritionTags.style.display = 'none';
            }
            
            // è®¾ç½®é£Ÿæ
            const ingHTML = item.ingredients.map(i => 
                `<span style="background:var(--tag-bg); padding:8px 14px; border-radius:12px; font-size:14px; display:inline-flex; align-items:center;">
                    <ion-icon name="checkmark-circle-outline" style="color:var(--primary); margin-right:6px; font-size:16px;"></ion-icon>
                    ${this.escape(i)}
                </span>`
            ).join('');
            document.getElementById('detailIngredients').innerHTML = ingHTML;

            // è®¾ç½®æ­¥éª¤
            const stepHTML = item.steps.map((s, i) => 
                `<div class="step-card">
                    <div class="step-number">${i+1}</div>
                    <div class="step-text">${this.escape(s)}</div>
                </div>`
            ).join('');
            document.getElementById('detailSteps').innerHTML = stepHTML;
            
            // è®¾ç½®å°è´´å£«
            if(item.tips) {
                document.getElementById('detailTips').style.display = 'block';
                document.getElementById('tipsContent').textContent = item.tips;
            } else {
                document.getElementById('detailTips').style.display = 'none';
            }

            // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
            const isFav = this.data.favorites.includes(id);
            const favIcon = document.querySelector('#detailFavBtn ion-icon');
            favIcon.name = isFav ? 'heart' : 'heart-outline';
            document.getElementById('detailFavBtn').style.color = isFav ? 'var(--fav)' : '';

            document.getElementById('detailPage').classList.add('active');
        },

        calculateTotalTime(prepTime, cookTime) {
            // ç®€å•çš„æ—¶é—´è®¡ç®—
            const prep = parseInt(prepTime) || 0;
            const cook = parseInt(cookTime) || 0;
            const total = prep + cook;
            return total > 0 ? `${total}åˆ†é’Ÿ` : '30åˆ†é’Ÿ';
        },

        closeDetail() {
            document.getElementById('detailPage').classList.remove('active');
            this.data.currentDetailId = null;
        },

        toggleFav(id) {
            const idx = this.data.favorites.indexOf(id);
            if(idx > -1) {
                this.data.favorites.splice(idx, 1);
                this.toast('å·²å–æ¶ˆæ”¶è—');
            } else {
                this.data.favorites.push(id);
                this.toast('å·²æ”¶è—');
            }
            this.saveData();
            this.renderList();
        },

        toggleFavCurrent() {
            if(this.data.currentDetailId) {
                this.toggleFav(this.data.currentDetailId);
                const isFav = this.data.favorites.includes(this.data.currentDetailId);
                const favIcon = document.querySelector('#detailFavBtn ion-icon');
                favIcon.name = isFav ? 'heart' : 'heart-outline';
                document.getElementById('detailFavBtn').style.color = isFav ? 'var(--fav)' : '';
            }
        },

        // è¯¦æƒ…é¡µåˆ é™¤åŠŸèƒ½
        askDeleteCurrent() {
            if(this.data.currentDetailId) {
                this.data.pendingDeleteId = this.data.currentDetailId;
                this.showDeleteDialog();
            }
        },

        askDelete(id) {
            this.data.pendingDeleteId = id;
            this.showDeleteDialog();
        },

        showDeleteDialog() {
            const el = document.getElementById('deleteDialog');
            const overlay = document.getElementById('overlay');
            overlay.style.display = 'block';
            setTimeout(() => {
                overlay.classList.add('active');
                el.style.display = 'block';
                setTimeout(() => el.classList.add('active'), 10);
            }, 10);
        },

        confirmDelete() {
            const id = this.data.pendingDeleteId;
            if(!id) return;

            this.data.recipes = this.data.recipes.filter(r => r.id !== id);
            this.data.favorites = this.data.favorites.filter(fid => fid !== id);
            this.saveData();
            this.renderList();
            
            // å¦‚æœæ­£åœ¨æŸ¥çœ‹è¿™ä¸ªèœè°±ï¼Œå…³é—­è¯¦æƒ…é¡µ
            if(this.data.currentDetailId === id) {
                this.closeDetail();
            }
            
            this.closeDialogs();
            this.toast('å·²åˆ é™¤');
        },

        shareItem(id) {
            const item = this.data.recipes.find(r => r.id === id);
            if(!item) return;
            this.doShare(item);
        },

        shareCurrent() {
            if(!this.data.currentDetailId) return;
            const item = this.data.recipes.find(r => r.id === this.data.currentDetailId);
            this.doShare(item);
        },

        doShare(item) {
            const text = `${item.title}\n\n${item.desc}\n\nâ° æ—¶é—´ï¼š${item.prepTime || '15åˆ†é’Ÿ'}å‡†å¤‡ï¼Œ${item.cookTime || '20åˆ†é’Ÿ'}çƒ¹é¥ª\nğŸ‘¥ ä»½é‡ï¼š${item.servings || '2-3äºº'}\n\nğŸ… é£Ÿæï¼š\n${item.ingredients.map(i=>`â€¢ ${i}`).join('\n')}\n\nğŸ‘¨â€ğŸ³ åšæ³•ï¼š\n${item.steps.map((s,i)=>`${i+1}. ${s}`).join('\n')}\n\nğŸ’¡ å°è´´å£«ï¼š${item.tips || 'æ ¹æ®ä¸ªäººå£å‘³è°ƒæ•´'}`;
            if (navigator.share) {
                navigator.share({ title: item.title, text: text }).catch(()=>{});
            } else {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                this.toast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
        },

        saveData() {
            localStorage.setItem('ai_recipes_v4', JSON.stringify(this.data.recipes));
            localStorage.setItem('ai_favs_v4', JSON.stringify(this.data.favorites));
        },

        escape(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        },

        bindEvents() {
            // è®¾ç½®æŒ‰é’®
            document.getElementById('settingsBtn').onclick = () => this.toggleKeyDialog(true);
            
            // æœç´¢
            document.getElementById('searchInput').addEventListener('input', (e) => {
                this.data.searchVal = e.target.value.trim();
                this.renderList();
            });

            // ç‚¹å‡»é®ç½©å…³é—­
            document.getElementById('overlay').onclick = () => this.closeDialogs();
            
            // æœç´¢æ¡†å›è½¦é”®
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.data.searchVal = e.target.value.trim();
                    this.renderList();
                }
            });
            
            // ç”Ÿæˆå¯¹è¯æ¡†ä¸­çš„å›è½¦é”®
            document.getElementById('ingredientsInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.generateRecipe();
                }
            });
        }
    };

    // å¯åŠ¨
    document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>

