<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 灵感厨房</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0..1,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* 重置和基础样式 */
        :root {
            --md-sys-color-primary: #006A60;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #74F8E5;
            --md-sys-color-on-primary-container: #00201C;
            --md-sys-color-secondary: #4A635F;
            --md-sys-color-surface: #F4FBF9;
            --md-sys-color-surface-container: #FFFFFF;
            --md-sys-color-on-surface: #191C1C;
            --md-sys-color-outline: #6F7977;
            --md-sys-color-error: #BA1A1A;
            --md-sys-color-success: #2E7D32;
            --md-sys-color-warning: #F57C00;
            
            --elevation-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15);
            
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 8px;
            --radius-pill: 999px;
            
            /* 暗黑模式变量 */
            --md-sys-color-primary-dark: #5DDBCC;
            --md-sys-color-on-primary-dark: #003731;
            --md-sys-color-primary-container-dark: #005048;
            --md-sys-color-on-primary-container-dark: #74F8E5;
            --md-sys-color-secondary-dark: #B1CCC6;
            --md-sys-color-surface-dark: #0F1413;
            --md-sys-color-surface-container-dark: #1D2423;
            --md-sys-color-on-surface-dark: #E0E3E1;
            --md-sys-color-outline-dark: #899391;
            --md-sys-color-error-dark: #FFB4AB;
            --md-sys-color-success-dark: #A5D6A7;
            --md-sys-color-warning-dark: #FFCC80;
            
            --elevation-1-dark: 0px 1px 3px 1px rgba(0, 0, 0, 0.3);
            --elevation-2-dark: 0px 2px 6px 2px rgba(0, 0, 0, 0.3);
            --elevation-3-dark: 0px 4px 8px 3px rgba(0, 0, 0, 0.3);
            
            /* 间距变量 */
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            
            /* 字体大小变量 */
            --font-size-xs: 12px;
            --font-size-s: 14px;
            --font-size-m: 16px;
            --font-size-l: 18px;
            --font-size-xl: 22px;
            --font-size-xxl: 28px;
        }

        * { 
            margin: 0;
            padding: 0;
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: 'Roboto', "PingFang SC", "Microsoft YaHei", sans-serif;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 暗黑模式下的body样式 */
        body.dark-mode {
            --md-sys-color-primary: var(--md-sys-color-primary-dark);
            --md-sys-color-on-primary: var(--md-sys-color-on-primary-dark);
            --md-sys-color-primary-container: var(--md-sys-color-primary-container-dark);
            --md-sys-color-on-primary-container: var(--md-sys-color-on-primary-container-dark);
            --md-sys-color-secondary: var(--md-sys-color-secondary-dark);
            --md-sys-color-surface: var(--md-sys-color-surface-dark);
            --md-sys-color-surface-container: var(--md-sys-color-surface-container-dark);
            --md-sys-color-on-surface: var(--md-sys-color-on-surface-dark);
            --md-sys-color-outline: var(--md-sys-color-outline-dark);
            --md-sys-color-error: var(--md-sys-color-error-dark);
            --md-sys-color-success: var(--md-sys-color-success-dark);
            --md-sys-color-warning: var(--md-sys-color-warning-dark);
            
            --elevation-1: var(--elevation-1-dark);
            --elevation-2: var(--elevation-2-dark);
            --elevation-3: var(--elevation-3-dark);
        }

        /* 应用容器 */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
        }

        /* 顶部应用栏 */
        .top-app-bar {
            background: var(--md-sys-color-surface);
            padding: var(--spacing-m) var(--spacing-l);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            flex-shrink: 0;
            border-bottom: 1px solid #E0EBE9;
            height: 64px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        body.dark-mode .top-app-bar {
            border-bottom: 1px solid #2A3533;
        }
        
        .app-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }
        
        .top-buttons {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .icon-btn {
            background: transparent;
            border: none;
            color: var(--md-sys-color-on-surface);
            padding: var(--spacing-s);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            transition: background-color 0.2s;
        }
        
        .icon-btn:hover { 
            background-color: rgba(0,0,0,0.05); 
        }
        
        .icon-btn:active { 
            background-color: rgba(0,0,0,0.1); 
        }
        
        body.dark-mode .icon-btn:hover { 
            background-color: rgba(255,255,255,0.1); 
        }
        
        body.dark-mode .icon-btn:active { 
            background-color: rgba(255,255,255,0.2); 
        }

        /* 标签栏 */
        .top-tabs {
            display: flex;
            background: var(--md-sys-color-surface);
            border-bottom: 1px solid #E0EBE9;
            flex-shrink: 0;
            height: 48px;
            transition: border-color 0.3s;
        }
        
        body.dark-mode .top-tabs {
            border-bottom: 1px solid #2A3533;
        }
        
        .tab-item {
            flex: 1;
            text-align: center;
            padding: var(--spacing-m) 0;
            font-size: var(--font-size-s);
            font-weight: 500;
            color: var(--md-sys-color-secondary);
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        
        .tab-item:hover {
            color: var(--md-sys-color-primary);
        }
        
        .tab-item.active {
            color: var(--md-sys-color-primary);
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 25%;
            width: 50%;
            height: 3px;
            background-color: var(--md-sys-color-primary);
            border-radius: 3px 3px 0 0;
            transition: background-color 0.3s;
        }

        /* 搜索区域 */
        .search-wrapper {
            padding: var(--spacing-m);
            background: var(--md-sys-color-surface);
            flex-shrink: 0;
            transition: background-color 0.3s;
        }
        
        .search-container {
            background-color: #E0EBE9;
            height: 48px;
            border-radius: var(--radius-pill);
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-m);
            transition: background-color 0.3s ease, box-shadow 0.2s;
            box-shadow: var(--elevation-1);
            border: 1px solid transparent;
            gap: var(--spacing-s);
        }
        
        body.dark-mode .search-container {
            background-color: #2A3533;
        }
        
        .search-container:focus-within {
            box-shadow: var(--elevation-2);
            border-color: var(--md-sys-color-primary);
        }
        
        .search-container input {
            border: none;
            background: transparent;
            flex: 1;
            height: 100%;
            font-size: var(--font-size-m);
            color: var(--md-sys-color-on-surface);
            font-family: inherit;
        }
        
        .search-container input::placeholder {
            color: var(--md-sys-color-outline);
        }
        
        /* 清空按钮样式修复 */
        .search-clear {
            background: transparent;
            border: none;
            color: var(--md-sys-color-outline);
            cursor: pointer;
            padding: var(--spacing-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s, color 0.2s, background-color 0.2s;
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .search-clear.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .search-clear:hover {
            background-color: rgba(0, 0, 0, 0.08);
            color: var(--md-sys-color-on-surface);
        }
        
        .search-clear:active {
            background-color: rgba(0, 0, 0, 0.12);
        }
        
        body.dark-mode .search-clear:hover {
            background-color: rgba(255, 255, 255, 0.12);
            color: var(--md-sys-color-on-surface-dark);
        }
        
        body.dark-mode .search-clear:active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .search-clear .material-symbols-rounded {
            font-size: 18px;
            font-variation-settings: 'FILL' 0;
        }

        /* 分类筛选器 - 只在探索页面显示 */
        .category-filters {
            display: flex;
            gap: var(--spacing-s);
            padding: 0 var(--spacing-m) var(--spacing-m);
            overflow-x: auto;
            background: var(--md-sys-color-surface);
            flex-shrink: 0;
            white-space: nowrap;
            transition: background-color 0.3s;
        }
        
        .category-filters.hidden {
            display: none;
        }
        
        body.dark-mode .category-filters {
            background-color: var(--md-sys-color-surface);
        }
        
        .category-filter {
            padding: 6px 12px;
            background: var(--md-sys-color-surface-container);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--radius-pill);
            font-size: var(--font-size-s);
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .category-filter:hover {
            border-color: var(--md-sys-color-primary);
        }
        
        .category-filter.active {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-color: var(--md-sys-color-primary);
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
            padding: var(--spacing-m);
            padding-bottom: 100px;
        }
        
        /* 修复收藏界面布局 */
        body.collection-view .main-content {
            padding-top: var(--spacing-m);
        }

        /* 空状态显示 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            text-align: center;
            color: var(--md-sys-color-secondary);
            min-height: 300px;
            height: 100%;
            width: 100%;
        }
        
        .empty-state span { 
            font-size: 64px; 
            display: block; 
            margin-bottom: var(--spacing-m); 
            color: var(--md-sys-color-outline);
            opacity: 0.7;
        }
        
        .empty-state h3 {
            font-size: var(--font-size-l);
            margin-bottom: var(--spacing-s);
            color: var(--md-sys-color-on-surface);
            font-weight: 500;
        }
        
        .empty-state p {
            font-size: var(--font-size-s);
            color: var(--md-sys-color-secondary);
            margin-bottom: var(--spacing-l);
            max-width: 300px;
            line-height: 1.5;
        }
        
        .empty-state .btn-primary {
            margin-top: var(--spacing-m);
            width: auto;
            min-width: 160px;
        }

        /* 菜谱列表容器 */
        .recipe-list-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-m);
            width: 100%;
            min-height: 100%;
        }

        /* 菜谱卡片 */
        .card {
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-m);
            padding: var(--spacing-m);
            box-shadow: var(--elevation-1);
            position: relative;
            transition: transform 0.1s, box-shadow 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            width: 100%;
            animation: fadeIn 0.3s ease-out;
        }
        
        .card:hover {
            box-shadow: var(--elevation-2);
            border-color: var(--md-sys-color-outline);
        }
        
        .card:active { 
            transform: scale(0.99); 
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-s);
        }
        
        .card-title {
            font-size: var(--font-size-l);
            font-weight: 700;
            margin: 0 0 var(--spacing-xs) 0;
            color: var(--md-sys-color-on-surface);
            line-height: 1.3;
        }
        
        .card-subtitle {
            font-size: var(--font-size-xs);
            color: var(--md-sys-color-secondary);
            margin-bottom: var(--spacing-s);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-s);
        }
        
        .tag {
            background: #E0EBE9;
            color: #004E45;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: var(--font-size-xs);
            font-weight: 500;
            white-space: nowrap;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode .tag {
            background: #2A3533;
            color: #5DDBCC;
        }
        
        .tag.ai-generated {
            background: rgba(0, 106, 96, 0.1);
            color: var(--md-sys-color-primary);
        }
        
        body.dark-mode .tag.ai-generated {
            background: rgba(93, 219, 204, 0.2);
        }
        
        /* 卡片操作按钮 */
        .card-actions {
            display: flex;
            gap: var(--spacing-xs);
            align-items: center;
        }
        
        .card-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--spacing-xs);
            color: var(--md-sys-color-outline);
            transition: all 0.2s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .card-action-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        body.dark-mode .card-action-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        /* 收藏按钮 - 修改为实心爱心 */
        .fav-btn {
            color: var(--md-sys-color-outline);
        }
        
        .fav-btn.active {
            color: #FF5252;
        }
        
        .fav-btn.active .material-symbols-rounded {
            font-variation-settings: 'FILL' 1;
        }
        
        body.dark-mode .fav-btn.active {
            color: #FF8A80;
        }
        
        /* 分享按钮 */
        .share-btn {
            color: var(--md-sys-color-outline);
        }
        
        .share-btn:hover {
            color: var(--md-sys-color-primary);
            background-color: rgba(0, 106, 96, 0.1);
        }
        
        body.dark-mode .share-btn:hover {
            background-color: rgba(93, 219, 204, 0.1);
        }
        
        /* 删除按钮 */
        .delete-btn {
            color: var(--md-sys-color-outline);
        }
        
        .delete-btn:hover {
            color: var(--md-sys-color-error);
            background-color: rgba(186, 26, 26, 0.1);
        }
        
        body.dark-mode .delete-btn:hover {
            background-color: rgba(255, 180, 171, 0.1);
        }
        
        .card-desc {
            font-size: var(--font-size-s);
            color: #404947;
            line-height: 1.5;
            margin-bottom: var(--spacing-s);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            transition: color 0.3s;
        }
        
        body.dark-mode .card-desc {
            color: #B8C5C2;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-s);
            padding-top: var(--spacing-s);
            border-top: 1px solid rgba(0,0,0,0.05);
            transition: border-color 0.3s;
        }
        
        body.dark-mode .card-footer {
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        .card-date {
            font-size: var(--font-size-xs);
            color: var(--md-sys-color-secondary);
        }

        /* 浮动按钮 */
        .fab {
            position: fixed;
            bottom: var(--spacing-l);
            right: var(--spacing-l);
            width: 56px;
            height: 56px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, background-color 0.3s ease, opacity 0.3s;
            outline: none;
            border: none;
            box-shadow: var(--elevation-3);
        }
        
        .fab:focus {
            outline: none;
            border: none;
        }
        
        .fab:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--elevation-3);
        }
        
        .fab:active {
            transform: scale(0.95);
        }

        /* 对话框 */
        .dialog-overlay {
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-m);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
        }
        
        .dialog-overlay.open { 
            display: flex; 
        }
        
        .dialog {
            background: var(--md-sys-color-surface-container);
            width: 100%;
            max-width: 400px;
            border-radius: var(--radius-l);
            padding: var(--spacing-l);
            box-shadow: var(--elevation-3);
            max-height: 90vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
            transform-origin: center;
        }
        
        .dialog h2 { 
            margin: 0 0 var(--spacing-m) 0; 
            font-size: var(--font-size-xl); 
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }
        
        .dialog p {
            color: var(--md-sys-color-secondary);
            font-size: var(--font-size-s);
            line-height: 1.5;
            margin-bottom: var(--spacing-l);
        }
        
        .input-group { 
            margin-bottom: var(--spacing-l); 
        }
        
        .input-group label { 
            display: block; 
            font-size: var(--font-size-xs); 
            color: var(--md-sys-color-secondary); 
            margin-bottom: var(--spacing-s);
            font-weight: 500;
        }
        
        .input-group input, 
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: var(--spacing-m);
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--radius-s);
            font-family: inherit;
            font-size: var(--font-size-m);
            background-color: var(--md-sys-color-surface-container);
            color: var(--md-sys-color-on-surface);
            transition: border-color 0.2s;
        }
        
        .input-group input:focus, 
        .input-group textarea:focus,
        .input-group select:focus { 
            border-color: var(--md-sys-color-primary); 
            outline: none;
        }
        
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
            margin-bottom: var(--spacing-m);
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--md-sys-color-primary);
        }
        
        .checkbox-group label {
            font-size: var(--font-size-s);
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
        }

        .btn-primary {
            background: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border: none;
            padding: var(--spacing-m) var(--spacing-l);
            border-radius: var(--radius-pill);
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.2s;
            font-size: var(--font-size-m);
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline);
            padding: var(--spacing-m) var(--spacing-l);
            border-radius: var(--radius-pill);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            font-size: var(--font-size-m);
            flex: 1;
        }
        
        .btn-secondary:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        body.dark-mode .btn-secondary:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .btn-danger {
            background: var(--md-sys-color-error);
            color: white;
            border: none;
            padding: var(--spacing-m) var(--spacing-l);
            border-radius: var(--radius-pill);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: var(--font-size-m);
            flex: 1;
        }
        
        .btn-danger:hover {
            opacity: 0.9;
        }
        
        .confirm-dialog {
            max-width: 320px;
        }
        
        .confirm-actions {
            display: flex;
            gap: var(--spacing-m);
            margin-top: var(--spacing-l);
        }

        /* 详情页 */
        .detail-view {
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: var(--md-sys-color-surface);
            z-index: 1500;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .detail-view.active { 
            display: flex; 
            animation: fadeIn 0.3s ease-out;
        }
        
        .detail-header {
            background: var(--md-sys-color-surface);
            padding: var(--spacing-m) var(--spacing-l);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #E0EBE9;
            flex-shrink: 0;
            height: 64px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        body.dark-mode .detail-header {
            border-bottom: 1px solid #2A3533;
        }
        
        .detail-actions {
            display: flex;
            gap: var(--spacing-s);
        }
        
        /* 详情页收藏按钮 - 修改为实心爱心 */
        .detail-view .fav-btn {
            color: var(--md-sys-color-outline);
        }
        
        .detail-view .fav-btn.active {
            color: #FF5252;
        }
        
        .detail-view .fav-btn.active .material-symbols-rounded {
            font-variation-settings: 'FILL' 1;
        }
        
        body.dark-mode .detail-view .fav-btn.active {
            color: #FF8A80;
        }
        
        .detail-content {
            padding: var(--spacing-l);
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .detail-title {
            font-size: var(--font-size-xxl);
            font-weight: 700;
            margin: 0 0 var(--spacing-m) 0;
            color: var(--md-sys-color-on-surface);
            line-height: 1.3;
        }
        
        .detail-meta {
            display: flex;
            align-items: center;
            gap: var(--spacing-l);
            margin-bottom: var(--spacing-l);
            flex-wrap: wrap;
        }
        
        .detail-meta-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-size-s);
            color: var(--md-sys-color-secondary);
        }
        
        .detail-desc {
            font-size: var(--font-size-m);
            line-height: 1.6;
            color: var(--md-sys-color-on-surface);
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-m);
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-m);
            border-left: 4px solid var(--md-sys-color-primary);
        }
        
        .detail-section {
            margin-bottom: var(--spacing-xl);
        }
        
        .detail-section h3 {
            font-size: var(--font-size-l);
            margin-bottom: var(--spacing-m);
            color: var(--md-sys-color-on-surface);
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
        }
        
        .detail-section h3::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--md-sys-color-outline);
            margin-left: var(--spacing-s);
        }
        
        .ingredients-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-s);
        }
        
        .ingredient-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-m);
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-s);
            border-left: 4px solid var(--md-sys-color-primary);
        }
        
        .ingredient-quantity {
            font-weight: 600;
            color: var(--md-sys-color-primary);
            margin-right: var(--spacing-s);
            min-width: 60px;
        }
        
        .ingredient-name {
            color: var(--md-sys-color-on-surface);
            flex: 1;
        }
        
        .steps-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-l);
        }
        
        .step-item {
            display: flex;
            gap: var(--spacing-m);
            padding: var(--spacing-m);
            background: var(--md-sys-color-surface-container);
            border-radius: var(--radius-m);
        }
        
        .step-number {
            font-weight: bold;
            color: var(--md-sys-color-primary);
            background: rgba(0, 106, 96, 0.1);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: var(--font-size-s);
        }
        
        body.dark-mode .step-number {
            background: rgba(93, 219, 204, 0.2);
        }
        
        .step-text {
            color: var(--md-sys-color-on-surface);
            line-height: 1.6;
            flex: 1;
        }
        
        .step-tip {
            font-size: var(--font-size-s);
            color: var(--md-sys-color-secondary);
            font-style: italic;
            margin-top: var(--spacing-s);
            padding-left: var(--spacing-m);
            border-left: 2px solid var(--md-sys-color-warning);
        }

        /* 主题切换按钮 */
        .theme-toggle {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: transparent;
            border: none;
        }
        
        .theme-icon {
            position: absolute;
            font-size: 22px;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s;
        }
        
        .light-icon {
            opacity: 1;
            transform: rotate(0deg);
        }
        
        .dark-icon {
            opacity: 0;
            transform: rotate(-90deg);
        }
        
        body.dark-mode .light-icon {
            opacity: 0;
            transform: rotate(90deg);
        }
        
        body.dark-mode .dark-icon {
            opacity: 1;
            transform: rotate(0deg);
        }

        /* 通知 */
        .toast {
            position: fixed;
            bottom: var(--spacing-l);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: var(--spacing-m) var(--spacing-l);
            border-radius: var(--radius-pill);
            z-index: 3000;
            transition: transform 0.3s;
            font-size: var(--font-size-s);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-s);
            box-shadow: var(--elevation-3);
            backdrop-filter: blur(10px);
            max-width: 90%;
            text-align: center;
        }
        
        body.dark-mode .toast {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success {
            background: var(--md-sys-color-success);
        }
        
        .toast.error {
            background: var(--md-sys-color-error);
        }
        
        .toast.warning {
            background: var(--md-sys-color-warning);
        }

        /* 动画 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 滚动条样式 */
        .main-content::-webkit-scrollbar,
        .detail-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .main-content::-webkit-scrollbar-track,
        .detail-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .main-content::-webkit-scrollbar-thumb,
        .detail-content::-webkit-scrollbar-thumb {
            background: var(--md-sys-color-outline);
            border-radius: 3px;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover,
        .detail-content::-webkit-scrollbar-thumb:hover {
            background: var(--md-sys-color-primary);
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .top-app-bar {
                padding: var(--spacing-m);
                height: 56px;
            }
            
            .app-title {
                font-size: var(--font-size-l);
            }
            
            .detail-header {
                padding: var(--spacing-m);
                height: 56px;
            }
            
            .detail-content {
                padding: var(--spacing-m);
            }
            
            .detail-title {
                font-size: var(--font-size-xl);
            }
            
            .detail-meta {
                gap: var(--spacing-m);
            }
            
            .fab {
                bottom: var(--spacing-m);
                right: var(--spacing-m);
                width: 52px;
                height: 52px;
            }
            
            .main-content {
                padding: var(--spacing-s);
                padding-bottom: 80px;
            }
            
            .dialog {
                padding: var(--spacing-m);
            }
        }
        
        @media (max-width: 480px) {
            :root {
                --spacing-l: 20px;
                --font-size-xl: 20px;
                --font-size-xxl: 24px;
            }
            
            .detail-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-s);
            }
            
            .step-item {
                padding: var(--spacing-s);
                gap: var(--spacing-s);
            }
            
            .confirm-actions {
                flex-direction: column;
            }
            
            .confirm-actions button {
                width: 100%;
            }
            
            .category-filters {
                padding: 0 var(--spacing-s) var(--spacing-s);
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="top-app-bar">
            <div class="app-title">
                <span class="material-symbols-rounded" style="color:var(--md-sys-color-primary)">chef_hat</span>
                AI 灵感厨房
            </div>
            <div class="top-buttons">
                <button class="icon-btn theme-toggle" id="themeToggle" title="切换主题">
                    <span class="material-symbols-rounded theme-icon light-icon">light_mode</span>
                    <span class="material-symbols-rounded theme-icon dark-icon">dark_mode</span>
                </button>
                <button class="icon-btn" id="settingsBtn" title="设置">
                    <span class="material-symbols-rounded">settings</span>
                </button>
            </div>
        </header>

        <!-- 只保留两个标签页 -->
        <nav class="top-tabs">
            <div class="tab-item active" id="tab-explore">
                探索生成
            </div>
            <div class="tab-item" id="tab-fav">
                我的收藏
            </div>
        </nav>

        <!-- 搜索区域 -->
        <div class="search-wrapper" id="searchWrapper">
            <div class="search-container">
                <span class="material-symbols-rounded" style="color:var(--md-sys-color-outline)">search</span>
                <input type="text" id="searchInput" placeholder="搜索菜谱...">
                <button class="search-clear" id="searchClear">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
        </div>

        <!-- 分类筛选器 - 只在探索页面显示 -->
        <div class="category-filters" id="categoryFilters">
            <button class="category-filter active" data-category="all">全部</button>
            <button class="category-filter" data-category="quick">快手菜</button>
            <button class="category-filter" data-category="chinese">中式</button>
            <button class="category-filter" data-category="western">西式</button>
            <button class="category-filter" data-category="vegetarian">素食</button>
            <button class="category-filter" data-category="dessert">甜点</button>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content" id="recipeContainer">
            <!-- 内容将由JS动态生成 -->
        </div>

        <!-- 浮动按钮 -->
        <button class="fab" id="fabBtn" title="生成菜谱">
            <span class="material-symbols-rounded">auto_awesome</span>
        </button>
    </div>

    <!-- 生成菜谱对话框 -->
    <div class="dialog-overlay" id="generateModal">
        <div class="dialog">
            <h2><span class="material-symbols-rounded" style="vertical-align:middle; color:var(--md-sys-color-primary)">psychology</span> AI 创作</h2>
            <p>根据您现有的食材，AI会为您生成独特的菜谱。</p>
            <div class="input-group">
                <label>现有食材（用逗号分隔）</label>
                <input type="text" id="ingredientsInput" placeholder="例如：鸡蛋，西红柿，米饭">
            </div>
            <div class="input-group">
                <label>口味/要求</label>
                <textarea id="styleInput" rows="3" placeholder="例如：辣一点，10分钟快手菜，适合夏天"></textarea>
            </div>
            <div class="input-group">
                <label>菜谱类型</label>
                <select id="categoryInput">
                    <option value="">自动选择</option>
                    <option value="quick">快手菜</option>
                    <option value="chinese">中式</option>
                    <option value="western">西式</option>
                    <option value="vegetarian">素食</option>
                    <option value="dessert">甜点</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="addToFavorites" checked>
                <label for="addToFavorites">生成后自动收藏</label>
            </div>
            <button class="btn-primary" id="startGenBtn">开始生成</button>
            <div id="loader" style="display:none; text-align:center; padding:10px;">
                <span class="material-symbols-rounded" style="animation: spin 1s infinite linear; font-size:24px; color:var(--md-sys-color-primary)">sync</span>
                <div style="font-size:12px; margin-top:5px; color:var(--md-sys-color-secondary)">AI 正在思考美味搭配...</div>
                <div style="font-size:11px; margin-top:5px; color:var(--md-sys-color-outline)">这可能需要几秒钟时间</div>
            </div>
        </div>
    </div>

    <!-- 设置对话框 -->
    <div class="dialog-overlay" id="settingsModal">
        <div class="dialog">
            <h2><span class="material-symbols-rounded" style="vertical-align:middle; color:var(--md-sys-color-primary)">settings</span> 设置</h2>
            <p style="font-size:13px; color:var(--md-sys-color-secondary); margin-bottom:15px">
                请配置您的 DeepSeek API Key 以启用生成功能。
            </p>
            <div class="input-group">
                <label>API Key</label>
                <input type="password" id="apiKeyInput" placeholder="sk-...">
            </div>
            <div class="input-group">
                <label>每次生成数量</label>
                <select id="generateCount">
                    <option value="1">1个菜谱</option>
                    <option value="2">2个菜谱</option>
                    <option value="3" selected>3个菜谱</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="autoSave" checked>
                <label for="autoSave">自动保存生成记录</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableAnimations" checked>
                <label for="enableAnimations">启用动画效果</label>
            </div>
            <div class="input-group" style="margin-top: 24px;">
                <label>数据管理</label>
                <div style="display: flex; gap: 10px; margin-top: 8px;">
                    <button class="btn-secondary" style="flex: 1;" id="exportBtn">导出数据</button>
                    <button class="btn-secondary" style="flex: 1;" id="importBtn">导入数据</button>
                </div>
            </div>
            <button class="btn-primary" id="saveSettingsBtn">保存配置</button>
        </div>
    </div>

    <!-- 确认删除对话框 -->
    <div class="dialog-overlay" id="confirmDeleteModal">
        <div class="dialog confirm-dialog">
            <h2>确认删除</h2>
            <p id="deleteConfirmText">确定要删除这个菜谱吗？此操作不可撤销。</p>
            <div class="confirm-actions">
                <button class="btn-secondary" id="cancelDeleteBtn">取消</button>
                <button class="btn-danger" id="confirmDeleteBtn">删除</button>
            </div>
        </div>
    </div>

    <!-- 详情页 -->
    <div class="detail-view" id="detailView">
        <div class="detail-header">
            <button class="icon-btn" id="closeDetailBtn">
                <span class="material-symbols-rounded">arrow_back</span>
            </button>
            <span style="font-weight:700; color:var(--md-sys-color-on-surface); display:block; text-align:center;">菜谱详情</span>
            <div class="detail-actions">
                <button class="icon-btn fav-btn" id="detailFavBtn" title="收藏">
                    <span class="material-symbols-rounded">favorite</span>
                </button>
                <button class="icon-btn share-btn" id="detailShareBtn" title="分享">
                    <span class="material-symbols-rounded">share</span>
                </button>
            </div>
        </div>
        <div class="detail-content" id="detailContent"></div>
    </div>

    <!-- 通知 -->
    <div id="toast" class="toast"></div>

    <script>
        // --- 全局状态 ---
        let recipes = [];
        let favorites = JSON.parse(localStorage.getItem('ai_favs')) || [];
        let currentTab = 'explore';
        let currentDetailId = null;
        let apiKey = localStorage.getItem('ai_api_key') || '';
        const apiEndpoint = 'https://api.deepseek.com/v1/chat/completions';
        let searchTimeout = null;
        let isGenerating = false;
        let recipeToDelete = null;
        let isDarkMode = localStorage.getItem('ai_dark_mode') === 'true';
        let currentCategory = 'all';
        
        // 应用配置
        const appConfig = {
            autoSave: localStorage.getItem('ai_auto_save') !== 'false',
            generateCount: parseInt(localStorage.getItem('ai_generate_count') || '3'),
            enableAnimations: localStorage.getItem('ai_enable_animations') !== 'false',
            lastBackup: localStorage.getItem('ai_last_backup') || null
        };

        // 模拟初始数据
        const initialData = [
            {
                id: 101,
                title: "黄金蛋炒饭",
                tags: ["快手", "主食", "中式"],
                category: "quick",
                desc: "粒粒分明的黄金米饭，只需最简单的食材。",
                ingredients: ["隔夜饭 1碗", "鸡蛋 2个", "葱花 少许", "盐 适量", "食用油 1汤匙"],
                steps: [
                    "将蛋黄拌入米饭中抓匀，让每粒米饭都裹上蛋液。",
                    "热锅冷油，倒入蛋白快速炒熟盛出备用。",
                    "同一锅中加少许油，倒入米饭大火快速翻炒至跳动。",
                    "加入炒好的蛋白、葱花和适量盐，翻炒均匀即可出锅。"
                ],
                tips: "使用隔夜饭效果更佳，炒饭时火要大，动作要快。",
                prepTime: 5,
                cookTime: 10,
                difficulty: "简单",
                createdAt: new Date('2024-01-15').getTime(),
                isAIGenerated: false
            },
            {
                id: 102,
                title: "蒜香黄油大虾",
                tags: ["西式", "海鲜", "宴客"],
                category: "western",
                desc: "浓郁的黄油蒜香包裹鲜嫩大虾，十分钟搞定的大餐。",
                ingredients: ["大虾 8只", "黄油 20g", "蒜末 1大勺", "黑胡椒 少许", "欧芹碎 适量", "白葡萄酒 1勺"],
                steps: [
                    "大虾洗净开背去虾线，用厨房纸吸干水分。",
                    "平底锅加热，融化黄油后爆香蒜末至金黄色。",
                    "放入大虾两面煎至变红，约2-3分钟。",
                    "淋入白葡萄酒，撒入黑胡椒和欧芹碎，翻炒均匀即可。"
                ],
                tips: "虾不要煎太久，否则会变老。",
                prepTime: 10,
                cookTime: 10,
                difficulty: "中等",
                createdAt: new Date('2024-01-20').getTime(),
                isAIGenerated: false
            },
            {
                id: 103,
                title: "AI特制：番茄鸡蛋面",
                tags: ["AI生成", "中式", "快手"],
                category: "quick",
                desc: "AI根据经典番茄鸡蛋面优化的家常版本，更加鲜美。",
                ingredients: ["鸡蛋 2个", "番茄 2个", "挂面 150g", "葱花 适量", "生抽 1勺", "糖 半勺", "盐 适量"],
                steps: [
                    "鸡蛋打散，番茄切小块备用。",
                    "锅中烧水煮面，同时另起锅炒鸡蛋盛出。",
                    "用余油炒番茄至出汁，加入生抽、糖和盐调味。",
                    "加入炒好的鸡蛋，与番茄汁混合均匀。",
                    "将煮好的面条放入番茄鸡蛋卤中拌匀，撒上葱花即可。"
                ],
                tips: "番茄炒出汁后再加调味料，味道更浓郁。",
                prepTime: 5,
                cookTime: 15,
                difficulty: "简单",
                createdAt: Date.now(),
                isAIGenerated: true
            }
        ];

        // --- 工具函数 ---
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            toast.classList.add(type);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 86400000) { // 24小时内
                return '今天';
            } else if (diff < 172800000) { // 48小时内
                return '昨天';
            } else if (diff < 604800000) { // 7天内
                const days = Math.floor(diff / 86400000);
                return `${days}天前`;
            } else {
                return date.toLocaleDateString('zh-CN', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        function getCategoryName(category) {
            const names = {
                'all': '全部',
                'quick': '快手菜',
                'chinese': '中式',
                'western': '西式',
                'vegetarian': '素食',
                'dessert': '甜点'
            };
            return names[category] || category;
        }

        function saveData() {
            try {
                localStorage.setItem('ai_recipes_data', JSON.stringify(recipes));
            } catch (error) {
                console.error('保存数据失败:', error);
                showToast('保存失败，请检查存储空间', 'error');
            }
        }

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 加载数据
                const savedData = localStorage.getItem('ai_recipes_data');
                recipes = savedData ? JSON.parse(savedData) : initialData;
                if (!savedData) saveData();
                
                // 初始化暗黑模式
                if (isDarkMode) {
                    document.body.classList.add('dark-mode');
                }
                
                // 加载配置
                loadSettings();
                
                // 初始化UI
                renderList();
                setupEventListeners();
                
                // 检查搜索框初始状态
                const searchInput = document.getElementById('searchInput');
                const searchClear = document.getElementById('searchClear');
                searchClear.classList.toggle('visible', searchInput.value.length > 0);
                
                // 检查是否需要显示备份提示
                if (!appConfig.lastBackup || (Date.now() - parseInt(appConfig.lastBackup)) > 604800000) { // 7天
                    setTimeout(() => {
                        showToast('建议定期备份您的菜谱数据', 'warning', 5000);
                    }, 2000);
                }
                
            } catch (error) {
                console.error('初始化失败:', error);
                recipes = initialData;
                saveData();
                renderList();
                showToast('初始化失败，已使用默认数据', 'error');
            }
        });

        function loadSettings() {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('generateCount').value = appConfig.generateCount;
            document.getElementById('autoSave').checked = appConfig.autoSave;
            document.getElementById('enableAnimations').checked = appConfig.enableAnimations;
        }

        function setupEventListeners() {
            // 主题切换
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
            
            // 设置按钮
            document.getElementById('settingsBtn').addEventListener('click', openSettings);
            
            // 标签切换
            document.getElementById('tab-explore').addEventListener('click', () => switchTab('explore'));
            document.getElementById('tab-fav').addEventListener('click', () => switchTab('fav'));
            
            // 分类筛选器
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.addEventListener('click', function() {
                    filterByCategory(this.dataset.category);
                });
            });
            
            // 搜索功能 - 已修复清空按钮样式
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            searchInput.addEventListener('input', function() {
                searchClear.classList.toggle('visible', this.value.length > 0);
                handleSearchInput();
            });
            
            searchClear.addEventListener('click', function() {
                searchInput.value = '';
                searchClear.classList.remove('visible');
                searchInput.focus();
                renderList();
            });
            
            // FAB按钮
            document.getElementById('fabBtn').addEventListener('click', tryOpenGenerate);
            
            // 生成对话框
            document.getElementById('startGenBtn').addEventListener('click', generateRecipe);
            document.getElementById('generateModal').addEventListener('click', function(e) {
                if (e.target.id === 'generateModal' && !isGenerating) {
                    closeModal('generateModal');
                }
            });
            
            // 设置对话框
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target.id === 'settingsModal') {
                    closeModal('settingsModal');
                }
            });
            
            // 数据管理
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', importData);
            
            // 删除对话框
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal('confirmDeleteModal'));
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteRecipe);
            document.getElementById('confirmDeleteModal').addEventListener('click', function(e) {
                if (e.target.id === 'confirmDeleteModal') {
                    closeModal('confirmDeleteModal');
                }
            });
            
            // 详情页
            document.getElementById('closeDetailBtn').addEventListener('click', closeDetail);
            document.getElementById('detailFavBtn').addEventListener('click', toggleDetailFav);
            document.getElementById('detailShareBtn').addEventListener('click', () => shareRecipe(currentDetailId));
            
            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (currentDetailId) {
                        closeDetail();
                    }
                    document.querySelectorAll('.dialog-overlay.open').forEach(modal => {
                        modal.classList.remove('open');
                    });
                }
                
                // Ctrl/Cmd + F 聚焦搜索框
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                
                // Ctrl/Cmd + N 新建菜谱
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    tryOpenGenerate();
                }
            });
            
            // 阻止弹窗内点击事件冒泡
            document.querySelectorAll('.dialog').forEach(dialog => {
                dialog.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }

        // --- 核心逻辑 ---

        function switchTab(tab) {
            if (tab === currentTab) return;
            
            currentTab = tab;
            
            // 更新标签状态
            document.getElementById('tab-explore').classList.toggle('active', tab === 'explore');
            document.getElementById('tab-fav').classList.toggle('active', tab === 'fav');
            
            // 更新UI元素显示
            const searchWrap = document.getElementById('searchWrapper');
            const categoryFilters = document.getElementById('categoryFilters');
            const fabBtn = document.getElementById('fabBtn');
            
            if (tab === 'fav') {
                searchWrap.style.display = 'block';
                categoryFilters.classList.add('hidden');
                fabBtn.style.display = 'none';
                document.body.classList.add('collection-view');
            } else {
                searchWrap.style.display = 'block';
                categoryFilters.classList.remove('hidden');
                fabBtn.style.display = 'flex';
                document.body.classList.remove('collection-view');
            }

            // 重置搜索和筛选
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClear').classList.remove('visible');
            currentCategory = 'all';
            
            // 更新分类筛选器
            updateCategoryFilters();
            
            // 滚动到顶部
            document.querySelector('.main-content').scrollTop = 0;
            
            renderList();
        }

        function filterByCategory(category) {
            currentCategory = category;
            updateCategoryFilters();
            renderList();
        }

        function updateCategoryFilters() {
            const filters = document.querySelectorAll('.category-filter');
            filters.forEach(filter => {
                const category = filter.dataset.category;
                filter.classList.toggle('active', category === currentCategory);
            });
        }

        function handleSearchInput() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(renderList, 300);
        }

        function renderList() {
            const container = document.getElementById('recipeContainer');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            
            container.innerHTML = '';
            
            let sourceList;
            if (currentTab === 'explore') {
                sourceList = recipes;
            } else if (currentTab === 'fav') {
                sourceList = recipes.filter(r => favorites.includes(r.id));
            }
            
            // 应用分类筛选 - 只在探索页面应用
            if (currentTab === 'explore' && currentCategory !== 'all') {
                sourceList = sourceList.filter(r => 
                    r.category === currentCategory || 
                    (r.tags && r.tags.some(tag => tag.toLowerCase().includes(currentCategory)))
                );
            }
            
            // 应用搜索筛选
            const filtered = sourceList.filter(r => {
                if (!r) return false;
                return (
                    (r.title && r.title.toLowerCase().includes(searchVal)) || 
                    (r.desc && r.desc.toLowerCase().includes(searchVal)) ||
                    (r.tags && r.tags.some(t => t.toLowerCase().includes(searchVal))) ||
                    (r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(searchVal)))
                );
            });

            if (filtered.length === 0) {
                showEmptyState(searchVal);
                return;
            }

            // 按创建时间排序
            filtered.sort((a, b) => b.createdAt - a.createdAt);
            
            const recipeListContainer = document.createElement('div');
            recipeListContainer.className = 'recipe-list-container';
            
            filtered.forEach(recipe => {
                if (!recipe) return;
                
                const isFav = favorites.includes(recipe.id);
                const tagsHtml = (recipe.tags || []).map(t => {
                    let tagClass = 'tag';
                    if (t.includes('AI')) tagClass += ' ai-generated';
                    return `<span class="${tagClass}">${t}</span>`;
                }).join('');
                
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.id = recipe.id;
                
                card.innerHTML = `
                    <div class="card-header">
                        <div style="flex: 1;">
                            <h3 class="card-title">${recipe.title || '未命名菜谱'}</h3>
                            <div class="card-subtitle">
                                <span class="material-symbols-rounded" style="font-size:14px">schedule</span>
                                <span>${(recipe.prepTime || 0) + (recipe.cookTime || 0)}分钟 · ${recipe.difficulty || '简单'}</span>
                                ${recipe.isAIGenerated ? '<span class="tag ai-generated" style="margin-left:8px">AI生成</span>' : ''}
                            </div>
                            ${tagsHtml ? `<div class="card-tags">${tagsHtml}</div>` : ''}
                        </div>
                        <div class="card-actions">
                            <!-- 分享按钮 -->
                            <button class="card-action-btn share-btn" title="分享">
                                <span class="material-symbols-rounded">share</span>
                            </button>
                            <!-- 收藏按钮 -->
                            <button class="card-action-btn fav-btn ${isFav ? 'active' : ''}" title="${isFav ? '取消收藏' : '收藏'}">
                                <span class="material-symbols-rounded">favorite</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-desc">${recipe.desc || ''}</div>
                    <div class="card-footer">
                        <div class="card-date">${formatDate(recipe.createdAt || Date.now())}</div>
                        <button class="card-action-btn delete-btn" title="删除">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                `;
                
                // 添加事件监听器
                const favBtn = card.querySelector('.fav-btn');
                const shareBtn = card.querySelector('.share-btn');
                const deleteBtn = card.querySelector('.delete-btn');
                
                favBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleFav(recipe.id, favBtn);
                });
                
                shareBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    shareRecipe(recipe.id);
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    tryDeleteRecipe(recipe.id);
                });
                
                card.addEventListener('click', () => {
                    openDetail(recipe.id);
                });
                
                recipeListContainer.appendChild(card);
            });
            
            container.appendChild(recipeListContainer);
        }

        function showEmptyState(searchVal) {
            const container = document.getElementById('recipeContainer');
            
            let title, icon, message, button;
            
            if (currentTab === 'fav') {
                title = "暂无收藏菜谱";
                icon = "favorite_border";
                message = "您还没有收藏任何菜谱";
                button = `<button class="btn-primary" id="goToExploreBtn">去探索菜谱</button>`;
            } else if (currentCategory !== 'all') {
                title = "暂无此类菜谱";
                icon = "category";
                message = `没有找到${getCategoryName(currentCategory)}类菜谱`;
                button = `<button class="btn-primary" id="showAllBtn">查看全部菜谱</button>`;
            } else if (searchVal) {
                title = "没有找到相关菜谱";
                icon = "search_off";
                message = `未找到包含"${searchVal}"的菜谱，请尝试其他关键词或点击搜索框旁边的"×"清空搜索`;
                button = ''; // 删除clearSearchBtn
            } else {
                title = "暂无菜谱";
                icon = "menu_book";
                message = "点击右下角按钮开始生成您的第一个菜谱";
                button = `<button class="btn-primary" id="startGenerateBtn">开始生成</button>`;
            }
            
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-symbols-rounded">${icon}</span>
                    <h3>${title}</h3>
                    <p>${message}</p>
                    ${button}
                </div>
            `;
            
            // 添加空状态按钮事件
            if (currentTab === 'fav') {
                document.getElementById('goToExploreBtn').addEventListener('click', () => switchTab('explore'));
            } else if (currentCategory !== 'all') {
                document.getElementById('showAllBtn').addEventListener('click', () => filterByCategory('all'));
            } else if (!searchVal) {
                document.getElementById('startGenerateBtn').addEventListener('click', tryOpenGenerate);
            }
            // 注意：删除了searchVal情况下的clearSearchBtn事件监听
        }

        function toggleFav(id, btnElement) {
            const index = favorites.indexOf(id);
            if (index > -1) {
                favorites.splice(index, 1);
                if(btnElement) {
                    btnElement.classList.remove('active');
                    btnElement.title = '收藏';
                }
                showToast('已取消收藏', 'info');
            } else {
                favorites.push(id);
                if(btnElement) {
                    btnElement.classList.add('active');
                    btnElement.title = '取消收藏';
                }
                showToast('已添加到收藏', 'success');
            }
            
            localStorage.setItem('ai_favs', JSON.stringify(favorites));
            
            if (currentTab === 'fav') {
                renderList();
            }

            if(currentDetailId === id) {
                updateDetailFavBtn();
            }
        }
        
        function tryDeleteRecipe(id) {
            recipeToDelete = id;
            const recipe = recipes.find(r => r.id === id);
            const message = recipe ? `确定要删除"${recipe.title}"吗？此操作不可撤销。` : '确定要删除这个菜谱吗？';
            document.getElementById('deleteConfirmText').textContent = message;
            openModal('confirmDeleteModal');
        }
        
        function confirmDeleteRecipe() {
            if (!recipeToDelete) return;
            
            const recipeIndex = recipes.findIndex(r => r.id === recipeToDelete);
            if (recipeIndex > -1) {
                const recipeTitle = recipes[recipeIndex].title;
                recipes.splice(recipeIndex, 1);
                saveData();
                
                const favIndex = favorites.indexOf(recipeToDelete);
                if (favIndex > -1) {
                    favorites.splice(favIndex, 1);
                    localStorage.setItem('ai_favs', JSON.stringify(favorites));
                }
                
                if (currentDetailId === recipeToDelete) {
                    closeDetail();
                }
                
                renderList();
                showToast(`"${recipeTitle}"已删除`, 'success');
            }
            
            recipeToDelete = null;
            closeModal('confirmDeleteModal');
        }

        // --- 暗黑模式功能 ---
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('ai_dark_mode', isDarkMode);
            
            showToast(isDarkMode ? '已切换为暗黑模式' : '已切换为明亮模式', 'success');
        }

        // --- 弹窗与设置逻辑 ---

        function openSettings() {
            loadSettings();
            openModal('settingsModal');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const count = parseInt(document.getElementById('generateCount').value);
            const autoSave = document.getElementById('autoSave').checked;
            const enableAnimations = document.getElementById('enableAnimations').checked;
            
            apiKey = key;
            appConfig.generateCount = count;
            appConfig.autoSave = autoSave;
            appConfig.enableAnimations = enableAnimations;
            
            localStorage.setItem('ai_api_key', key);
            localStorage.setItem('ai_generate_count', count);
            localStorage.setItem('ai_auto_save', autoSave);
            localStorage.setItem('ai_enable_animations', enableAnimations);
            
            closeModal('settingsModal');
            showToast('配置已保存', 'success');
        }

        function tryOpenGenerate() {
            if (!apiKey) {
                if(confirm("您尚未配置 API Key，无法生成菜谱。\n要去设置配置吗？")) {
                    openSettings();
                }
                return;
            }
            openModal('generateModal');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }

        // --- 数据管理功能 ---
        function exportData() {
            const data = {
                recipes: recipes,
                favorites: favorites,
                config: appConfig,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `ai-kitchen-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            appConfig.lastBackup = Date.now();
            localStorage.setItem('ai_last_backup', appConfig.lastBackup);
            
            showToast('数据导出成功', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (!importedData.recipes || !Array.isArray(importedData.recipes)) {
                            throw new Error('无效的数据格式');
                        }
                        
                        if (confirm(`即将导入 ${importedData.recipes.length} 个菜谱，是否继续？`)) {
                            recipes = importedData.recipes;
                            favorites = importedData.favorites || [];
                            if (importedData.config) {
                                Object.assign(appConfig, importedData.config);
                            }
                            
                            saveData();
                            localStorage.setItem('ai_favs', JSON.stringify(favorites));
                            renderList();
                            
                            showToast(`成功导入 ${recipes.length} 个菜谱`, 'success');
                        }
                    } catch (error) {
                        console.error('导入失败:', error);
                        showToast('导入失败：数据格式错误', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // --- API生成逻辑 ---
        async function generateRecipe() {
            const ing = document.getElementById('ingredientsInput').value.trim();
            const style = document.getElementById('styleInput').value.trim();
            const category = document.getElementById('categoryInput').value;
            const addToFavorites = document.getElementById('addToFavorites').checked;
            const count = appConfig.generateCount;

            if(!ing) {
                showToast('请至少输入食材', 'warning');
                return;
            }

            if (isGenerating) return;
            
            isGenerating = true;
            
            const btn = document.getElementById('startGenBtn');
            const loader = document.getElementById('loader');
            btn.style.display = 'none';
            loader.style.display = 'block';

            try {
                const prompt = `请根据以下食材和要求生成${count}个不同的菜谱：
食材：${ing}
要求：${style || "无特殊要求"}
菜谱类型：${category || "自动选择"}

请返回一个结构化的菜谱列表，每个菜谱包含以下信息：
1. 菜谱标题
2. 标签（2-3个，如：快手、中式、素食等）
3. 简短描述
4. 食材清单（数组格式）
5. 烹饪步骤（数组格式）
6. 烹饪技巧（可选）
7. 准备时间（分钟）
8. 烹饪时间（分钟）
9. 难度（简单/中等/困难）

请以JSON格式返回，结构如下：
{
  "recipes": [
    {
      "title": "菜谱标题",
      "tags": ["标签1", "标签2"],
      "category": "类别",
      "desc": "菜谱描述",
      "ingredients": ["食材1 用量", "食材2 用量"],
      "steps": ["步骤1", "步骤2", "步骤3"],
      "tips": "烹饪技巧",
      "prepTime": 5,
      "cookTime": 10,
      "difficulty": "简单"
    }
  ]
}`;

                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                "role": "system", 
                                "content": "你是一个专业的厨师助手，擅长根据现有食材创作美味菜谱。请始终返回有效的JSON格式，确保标签包含相关分类信息。"
                            },
                            {
                                "role": "user", 
                                "content": prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                let recipeData;
                try {
                    // 尝试提取JSON部分
                    const jsonStart = aiResponse.indexOf('{');
                    const jsonEnd = aiResponse.lastIndexOf('}') + 1;
                    if (jsonStart !== -1 && jsonEnd !== -1) {
                        const jsonStr = aiResponse.substring(jsonStart, jsonEnd);
                        recipeData = JSON.parse(jsonStr);
                    } else {
                        throw new Error('未找到JSON数据');
                    }
                } catch (parseError) {
                    console.error('解析AI响应失败:', parseError, '原始响应:', aiResponse);
                    throw new Error('AI返回格式不正确，请重试');
                }

                const newRecipes = (recipeData.recipes || [recipeData]).slice(0, count).map((r, index) => {
                    const newId = Date.now() + index;
                    return {
                        id: newId,
                        title: r.title || `AI特制：${ing.split(/[,， ]+/)[0] || '创意'}料理`,
                        tags: r.tags || ["AI生成", "独家"],
                        category: category || r.category || "quick",
                        desc: r.desc || `根据您的食材 (${ing}) 和偏好 (${style || "默认"}) 生成的美味方案。`,
                        ingredients: r.ingredients || [...ing.split(/[,， ]+/).filter(i => i.trim()), "盐 少许", "生抽 1勺"],
                        steps: r.steps || [
                            "食材洗净处理备用。",
                            "热锅冷油，下入主料煸炒。",
                            "加入调味料和少许水焖煮。",
                            "大火收汁，装盘撒上葱花。"
                        ],
                        tips: r.tips || "根据个人口味调整调味料用量。",
                        prepTime: r.prepTime || 5,
                        cookTime: r.cookTime || 10,
                        difficulty: r.difficulty || "简单",
                        createdAt: newId,
                        isAIGenerated: true
                    };
                });

                // 添加到菜谱列表
                newRecipes.forEach(recipe => {
                    recipes.unshift(recipe);
                    if (addToFavorites && !favorites.includes(recipe.id)) {
                        favorites.push(recipe.id);
                    }
                });

                saveData();
                localStorage.setItem('ai_favs', JSON.stringify(favorites));
                
                // 清空表单
                document.getElementById('ingredientsInput').value = '';
                document.getElementById('styleInput').value = '';
                document.getElementById('categoryInput').value = '';
                
                closeModal('generateModal');
                
                // 渲染列表
                renderList();
                
                // 显示成功消息
                showToast(`成功生成 ${newRecipes.length} 个菜谱`, 'success');
                
                // 自动打开第一个菜谱详情
                if (newRecipes.length > 0) {
                    setTimeout(() => {
                        openDetail(newRecipes[0].id);
                    }, 500);
                }

            } catch (error) {
                console.error('生成菜谱失败:', error);
                showToast(`生成失败: ${error.message}`, 'error');
                
                // 失败时使用模拟数据
                const newId = Date.now();
                const ingredients = ing.split(/[,， ]+/).filter(item => item.trim());
                
                const newRecipe = {
                    id: newId,
                    title: "AI特制：" + (ingredients[0] || "创意") + "料理",
                    tags: ["AI生成", "独家"],
                    category: category || "quick",
                    desc: `根据您的食材 (${ing}) 和偏好 (${style || "默认"}) 生成的美味方案。`,
                    ingredients: [...ingredients, "盐 少许", "生抽 1勺", "食用油 适量"],
                    steps: [
                        "食材洗净处理备用。",
                        "热锅冷油，下入主料煸炒至变色。",
                        "加入调味料和少许水焖煮5分钟。",
                        "大火收汁，装盘撒上葱花即可。"
                    ],
                    tips: "可根据个人口味调整调味料用量。",
                    prepTime: 5,
                    cookTime: 10,
                    difficulty: "简单",
                    createdAt: newId,
                    isAIGenerated: true
                };

                recipes.unshift(newRecipe);
                if (addToFavorites) {
                    favorites.push(newId);
                }
                
                saveData();
                localStorage.setItem('ai_favs', JSON.stringify(favorites));
                
                document.getElementById('ingredientsInput').value = '';
                document.getElementById('styleInput').value = '';
                document.getElementById('categoryInput').value = '';
                closeModal('generateModal');
                
                renderList();
                
                setTimeout(() => {
                    openDetail(newId);
                }, 100);
                
                showToast('使用模拟数据生成成功', 'warning');
            } finally {
                loader.style.display = 'none';
                btn.style.display = 'block';
                isGenerating = false;
            }
        }

        // --- 详情页逻辑 ---

        function openDetail(id) {
            currentDetailId = id;
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) {
                showToast('菜谱不存在', 'error');
                return;
            }

            const view = document.getElementById('detailView');
            const content = document.getElementById('detailContent');
            
            const stepList = (recipe.steps || []).map((s, i) => 
                `<div class="step-item">
                    <div class="step-number">${i+1}</div>
                    <div class="step-text">${s}</div>
                </div>`
            ).join('');

            const ingList = (recipe.ingredients || []).map(ing => {
                const parts = ing.split(' ');
                const quantity = parts.length > 1 ? parts[0] : '适量';
                const name = parts.length > 1 ? parts.slice(1).join(' ') : parts[0];
                return `
                    <div class="ingredient-item">
                        <div class="ingredient-quantity">${quantity}</div>
                        <div class="ingredient-name">${name}</div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <h1 class="detail-title">${recipe.title || '未命名菜谱'}</h1>
                
                <div class="detail-meta">
                    <div class="detail-meta-item">
                        <span class="material-symbols-rounded">schedule</span>
                        <span>准备: ${recipe.prepTime || 0}分钟 · 烹饪: ${recipe.cookTime || 0}分钟</span>
                    </div>
                    <div class="detail-meta-item">
                        <span class="material-symbols-rounded">signal_cellular_alt</span>
                        <span>难度: ${recipe.difficulty || '简单'}</span>
                    </div>
                    <div class="detail-meta-item">
                        <span class="material-symbols-rounded">calendar_today</span>
                        <span>${new Date(recipe.createdAt || Date.now()).toLocaleDateString('zh-CN')}</span>
                    </div>
                    ${recipe.isAIGenerated ? `
                        <div class="detail-meta-item">
                            <span class="material-symbols-rounded">psychology</span>
                            <span>AI生成</span>
                        </div>
                    ` : ''}
                </div>
                
                ${recipe.desc ? `<div class="detail-desc">${recipe.desc}</div>` : ''}
                
                <div class="detail-section">
                    <h3><span class="material-symbols-rounded">nutrition</span> 准备食材</h3>
                    <div class="ingredients-list">${ingList || '<p style="color:var(--md-sys-color-secondary); padding:var(--spacing-m);">暂无食材信息</p>'}</div>
                </div>
                
                <div class="detail-section">
                    <h3><span class="material-symbols-rounded">list_alt</span> 烹饪步骤</h3>
                    <div class="steps-list">${stepList || '<p style="color:var(--md-sys-color-secondary); padding:var(--spacing-m);">暂无步骤信息</p>'}</div>
                </div>
                
                ${recipe.tips ? `
                    <div class="step-tip">
                        <strong>小贴士：</strong> ${recipe.tips}
                    </div>
                ` : ''}
                
                <div style="height: 100px;"></div>
            `;

            updateDetailFavBtn();
            view.classList.add('active');
        }

        function closeDetail() {
            document.getElementById('detailView').classList.remove('active');
            currentDetailId = null;
        }

        function updateDetailFavBtn() {
            const btn = document.getElementById('detailFavBtn');
            if (!btn) return;
            
            const isFav = favorites.includes(currentDetailId);
            btn.classList.toggle('active', isFav);
            btn.title = isFav ? '取消收藏' : '收藏';
        }

        function toggleDetailFav() {
            if(currentDetailId) {
                const btn = document.getElementById('detailFavBtn');
                toggleFav(currentDetailId, btn);
            }
        }

        // --- 分享功能 ---
        function shareRecipe(recipeId) {
            const id = recipeId || currentDetailId;
            if (!id) return;
            
            const recipe = recipes.find(r => r.id === id);
            if (!recipe) return;
            
            // 分享菜谱的具体操作步骤
            let shareText = `${recipe.title}\n\n`;
            shareText += `描述: ${recipe.desc}\n\n`;
            shareText += `准备时间: ${recipe.prepTime}分钟\n`;
            shareText += `烹饪时间: ${recipe.cookTime}分钟\n`;
            shareText += `难度: ${recipe.difficulty}\n\n`;
            shareText += `食材清单:\n`;
            (recipe.ingredients || []).forEach((ing, index) => {
                shareText += `${index + 1}. ${ing}\n`;
            });
            shareText += `\n烹饪步骤:\n`;
            (recipe.steps || []).forEach((step, index) => {
                shareText += `${index + 1}. ${step}\n`;
            });
            if (recipe.tips) {
                shareText += `\n小贴士: ${recipe.tips}\n`;
            }
            shareText += `\n来自AI灵感厨房`;
            
            if (navigator.share) {
                navigator.share({
                    title: recipe.title,
                    text: shareText,
                    url: window.location.href
                }).catch(err => {
                    console.error('分享失败:', err);
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('菜谱步骤已复制到剪贴板', 'success');
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败，请手动复制', 'error');
            });
        }

    </script>
</body>
</html>
