<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>树洞天气助手</title>
    <link rel="stylesheet" href="https://res.wx.qq.com/t/wx_fed/weui-source/res/2.6.25/weui.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    :root {
        --bg-color: #f7f7f7;
        --card-bg: #ffffff;
        --text-main: rgba(0, 0, 0, 0.9);
        --text-desc: rgba(0, 0, 0, 0.5);
        /* 核心蓝色变量，用于统一图标颜色 */
        --primary-blue: #2c80ff; 
        --hero-gradient: linear-gradient(160deg, #2c80ff 0%, #5a9dff 100%);
        --shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        --border-color: rgba(0, 0, 0, 0.05); /* 边框更淡，更沉浸 */
        --weui-BG: #f7f7f7;
        --weui-BG-0: #ffffff;
        --weui-BG-1: #f7f7f7;
        --weui-FG-0: rgba(0, 0, 0, 0.9);
        --weui-FG-1: rgba(0, 0, 0, 0.5);
    }

    body[data-weui-theme='dark'] {
        --bg-color: #111111;
        --card-bg: #1f1f1f;
        --text-main: rgba(255, 255, 255, 0.9);
        --text-desc: rgba(255, 255, 255, 0.5);
        --primary-blue: #5a9dff; /* 深色模式下的蓝色稍微亮一点 */
        --hero-gradient: linear-gradient(160deg, #1a5fcc 0%, #2c80ff 100%);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        --border-color: rgba(255, 255, 255, 0.08);
        --weui-BG: #000000;
        --weui-BG-0: #191919;
        --weui-BG-1: #111111;
        --weui-FG-0: rgba(255, 255, 255, 0.9);
        --weui-FG-1: rgba(255, 255, 255, 0.5);
    }

    body {
        background-color: var(--weui-BG);
        color: var(--weui-FG-0);
        font-family: -apple-system-font, Helvetica Neue, sans-serif;
        margin: 0;
        transition: background-color 0.3s ease;
        padding-bottom: env(safe-area-inset-bottom);
        -webkit-tap-highlight-color: transparent;
    }

    /* --- 顶部提示 --- */
    .weui-toptips {
        border-radius: 8px;
        margin: 8px;
        width: auto;
        display: none;
    }

    /* --- 搜索栏适配 --- */
    .search-container {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: var(--weui-BG);
        /* 去掉底部边框，让视觉更干净 */
        /* border-bottom: 1px solid var(--border-color); */
        padding-top: env(safe-area-inset-top, 0);
        backdrop-filter: blur(10px);
        background-color: rgba(var(--weui-BG), 0.8);
    }
    
    .weui-search-bar { background-color: transparent !important; }
    .weui-search-bar:before, .weui-search-bar:after { display: none; }
    .weui-search-bar__form { background-color: var(--weui-BG-0); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .weui-search-bar__box .weui-search-bar__input { color: var(--weui-FG-0); }
    .weui-search-bar__label { background-color: var(--weui-BG-0); border-radius: 12px; }

    .location-cell {
        display: none;
        background-color: var(--weui-BG-0);
        margin: 0 12px 12px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow);
    }
    .location-cell.active { display: block; animation: fadeInDown 0.3s ease; }

    /* --- 天气主卡片 --- */
    .weather-hero {
        margin: 10px 16px 20px;
        padding: 40px 20px;
        background: var(--hero-gradient);
        border-radius: 24px;
        color: #fff;
        text-align: center;
        position: relative;
        box-shadow: 0 10px 30px rgba(44, 128, 255, 0.25);
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .hero-city { font-size: 28px; font-weight: 700; letter-spacing: 1px; }
    .hero-date { font-size: 14px; opacity: 0.85; margin-bottom: 25px; font-weight: 500; }
    .hero-main { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; }
    .hero-temp { font-size: 76px; font-weight: 200; line-height: 1; letter-spacing: -2px; }
    /* 主卡片图标保持白色，为了对比度 */
    .hero-icon { font-size: 52px; color: #fff; } 
    .update-badge { position: absolute; top: 15px; right: 15px; font-size: 11px; background: rgba(255,255,255,0.25); padding: 3px 10px; border-radius: 12px; backdrop-filter: blur(5px); font-weight: 600; }

    /* --- 修复后的详情六宫格 --- */
    .custom-grids {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        /* 移除原来的 gap 和 背景色，解决色块问题 */
        background-color: var(--weui-BG-0); 
        margin: 0 16px 20px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden; /* 保证圆角 */
    }

    .grid-item { 
        background-color: transparent; 
        padding: 24px 0; 
        text-align: center; 
        position: relative;
    }

    /* 使用伪元素制作细边框，实现沉浸感 */
    .grid-item::after {
        content: "";
        position: absolute;
        right: 0;
        top: 20%;
        height: 60%;
        width: 1px;
        background-color: var(--border-color);
    }
    .grid-item:nth-child(3n)::after { display: none; /* 每行最后一个去掉右边框 */ }
    
    .grid-item::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 10%;
        width: 80%;
        height: 1px;
        background-color: var(--border-color);
    }
    .grid-item:nth-last-child(-n+3)::before { display: none; /* 最后一行去掉底边框 */ }

    /* 统一蓝色图标 */
    .grid-icon i { 
        font-size: 22px; 
        color: var(--primary-blue); /* 统一蓝色 */
        margin-bottom: 10px;
        filter: drop-shadow(0 4px 6px rgba(44, 128, 255, 0.2)); /* 轻微光晕 */
    }
    .grid-label { font-size: 12px; color: var(--weui-FG-1); margin-bottom: 2px;}
    .grid-value { font-size: 16px; font-weight: 600; color: var(--weui-FG-0); font-family: 'DIN', -apple-system-font, sans-serif; }

    /* --- 未来预报滚动 --- */
    .section-title { padding: 10px 20px 15px; font-size: 16px; color: var(--weui-FG-0); font-weight: 700; }
    
    .forecast-scroll-container { display: flex; overflow-x: auto; padding: 0 16px 20px; gap: 12px; scrollbar-width: none; }
    .forecast-scroll-container::-webkit-scrollbar { display: none; }
    
    .forecast-item { 
        flex: 0 0 95px; 
        background: var(--weui-BG-0); 
        padding: 20px 10px; 
        border-radius: 16px; 
        text-align: center; 
        box-shadow: var(--shadow);
        /* 去掉边框，改用投影让视觉更沉浸 */
        border: none; 
    }
    
    .f-day { color: var(--weui-FG-0); font-size: 14px; font-weight: 600; }
    .f-date { font-size: 11px; color: var(--weui-FG-1); margin-top: 4px; }
    
    /* 预报图标也使用蓝色 */
    .f-icon { 
        font-size: 26px; 
        margin: 15px 0; 
        color: var(--primary-blue); 
    }
    
    .f-temp { font-weight: 600; font-size: 16px; color: var(--weui-FG-0); }
    .f-low { font-size: 12px; color: var(--weui-FG-1); margin-top: 4px; }

    /* --- 昨天卡片 --- */
    .yesterday-card { 
        margin: 0 16px 40px; 
        background: var(--weui-BG-0); 
        border-radius: 16px; 
        overflow: hidden; 
        box-shadow: var(--shadow); 
        border: none;
    }
    .weui-form-preview__hd:after { display: none; }
    .weui-form-preview__value { color: var(--weui-FG-0); font-weight: 500;}

    /* --- 加载动画补丁 --- */
    .weui-loading { vertical-align: middle; }
    #initialLoading { height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--weui-FG-1); }

    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* 修复WeUI深色模式边框 */
    body[data-weui-theme='dark'] .weui-cells:before, 
    body[data-weui-theme='dark'] .weui-cells:after,
    body[data-weui-theme='dark'] .weui-cell:before {
        border-color: rgba(255,255,255,0.05) !important;
    }
    </style>
</head>

<body>
    <div class="weui-toptips weui-toptips_warn" id="topTips">错误提示</div>

    <div class="search-container">
        <div class="weui-search-bar" id="searchBar">
            <form class="weui-search-bar__form">
                <div class="weui-search-bar__box">
                    <i class="weui-icon-search"></i>
                    <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索城市名称" required/>
                    <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                </div>
                <label class="weui-search-bar__label" id="searchText">
                    <i class="weui-icon-search"></i>
                    <span>搜索城市</span>
                </label>
            </form>
            <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
        </div>

        <div class="weui-cells location-cell" id="locationCell">
            <div class="weui-cell weui-cell_active weui-cell_access" id="locationBtn">
                <div class="weui-cell__hd" style="margin-right: 12px; color: var(--primary-blue);">
                    <i class="fas fa-location-arrow"></i>
                </div>
                <div class="weui-cell__bd"><p style="font-size: 15px;">获取当前位置天气</p></div>
                <div class="weui-cell__ft" id="gpsStatus" style="font-size: 13px;">自动定位</div>
            </div>
        </div>
    </div>

    <div id="initialLoading">
        <i class="weui-loading" style="width: 32px; height: 32px; color: var(--primary-blue);"></i>
        <p style="margin-top: 15px; font-size: 14px;">正在连接树洞天气...</p>
    </div>

    <div id="mainContent" style="display:none; opacity: 0; transition: opacity 0.6s ease-out;">
        
        <div class="weather-hero">
            <div class="update-badge">更新于 <span id="updateTime">--:--</span></div>
            <div class="hero-city" id="uiCity">--</div>
            <div class="hero-date" id="uiDate">--</div>
            
            <div class="hero-main">
                <div class="hero-icon" id="weatherIcon"><i class="fas fa-sun"></i></div>
                <div class="hero-temp" id="uiTemp">--°</div>
            </div>
            
            <div class="hero-status" id="uiWea" style="font-size: 20px; font-weight: 500;">--</div>
            <div class="hero-range" style="margin-top: 5px; opacity: 0.9;">
                <span id="uiLowTemp">--</span> ~ <span id="uiHighTemp">--</span>
            </div>
            <div style="margin-top: 20px; font-size: 13px; background: rgba(0,0,0,0.1); padding: 8px 15px; border-radius: 10px; display: inline-block;" id="weatherNotice">--</div>
        </div>

        <div class="custom-grids" id="currentDetails"></div>

        <div class="section-title">未来天气预报</div>
        <div class="forecast-scroll-container" id="forecastContainer"></div>

        <div class="section-title">昨日回顾</div>
        <div class="yesterday-card">
            <div class="weui-form-preview">
                <div class="weui-form-preview__hd">
                    <div class="weui-form-preview__item">
                        <label class="weui-form-preview__label">昨日日期</label>
                        <em class="weui-form-preview__value" id="yesterdayDate" style="font-size: 16px;">--</em>
                    </div>
                </div>
                <div class="weui-form-preview__bd" id="yesterdayBody"></div>
            </div>
        </div>

        <div class="weui-footer" style="padding-bottom: 30px;">
            <p class="weui-footer__links"><a href="javascript:;" class="weui-footer__link">树洞天气助手</a></p>
            <p class="weui-footer__text">天气数据由第三方提供·定位信息来自你的网络IP</p>
        </div>
    </div>

    <div id="loadingToast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-loading weui-icon_toast"></i>
            <p class="weui-toast__content">查询中</p>
        </div>
    </div>

    <script>
        // --- 核心配置 ---
        const API_KEY = "Nub0tYQ9brRDfSOfUXvA6xgoxb";
        const WEATHER_URL = "https://api.hewoyi.com/api/weather/v1";
        const IP_URL = "https://api.hewoyi.com/api/ipjwd/get";

        let currentCity = "";

        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initSearchUI();
            getWeatherByIP();
        });

        // --- 主题适配 ---
        function initTheme() {
            const themeMedia = window.matchMedia("(prefers-color-scheme: dark)");
            const apply = (e) => {
                const theme = e.matches ? 'dark' : 'light';
                document.body.setAttribute('data-weui-theme', theme);
                document.querySelector("meta[name=theme-color]")?.setAttribute("content", theme === 'dark' ? '#000000' : '#f7f7f7');
            };
            apply(themeMedia);
            themeMedia.addEventListener('change', apply);
        }

        // --- 搜索UI逻辑 ---
        function initSearchUI() {
            const $searchBar = document.getElementById('searchBar');
            const $searchText = document.getElementById('searchText');
            const $searchInput = document.getElementById('searchInput');
            const $searchClear = document.getElementById('searchClear');
            const $searchCancel = document.getElementById('searchCancel');
            const $locationCell = document.getElementById('locationCell');

            $searchText.addEventListener('click', () => {
                $searchBar.classList.add('weui-search-bar_focusing');
                $searchInput.focus();
                $locationCell.classList.add('active');
            });

            $searchCancel.addEventListener('click', () => {
                $searchBar.classList.remove('weui-search-bar_focusing');
                $locationCell.classList.remove('active');
            });

            $searchClear.addEventListener('click', () => {
                $searchInput.value = '';
                $searchInput.focus();
            });

            document.querySelector('.weui-search-bar__form').addEventListener('submit', (e) => {
                e.preventDefault();
                const city = $searchInput.value.trim();
                if(city) {
                    $searchInput.blur();
                    $searchBar.classList.remove('weui-search-bar_focusing');
                    $locationCell.classList.remove('active');
                    getWeatherByCity(city);
                }
            });

            document.getElementById('locationBtn').addEventListener('click', getWeatherByIP);
        }

        // --- 数据请求 ---
        async function getWeatherByIP() {
            toggleToast(true);
            const $status = document.getElementById('gpsStatus');
            $status.innerText = "正在定位...";
            
            try {
                const res = await fetch(`${IP_URL}?key=${API_KEY}`);
                const data = await res.json();
                if (data.code === 200 && data.data?.info?.city) {
                    const city = data.data.info.city.replace(/市$/, '');
                    $status.innerText = "当前: " + city;
                    getWeatherByCity(city);
                } else {
                    throw new Error("定位失败");
                }
            } catch (err) {
                $status.innerText = "定位失败";
                getWeatherByCity(currentCity || "北京");
                showTips("定位失败，已切换至默认城市");
            }
        }

        async function getWeatherByCity(city) {
            toggleToast(true);
            try {
                const res = await fetch(`${WEATHER_URL}?key=${API_KEY}&city=${encodeURIComponent(city)}`);
                const data = await res.json();
                toggleToast(false);
                
                if (data.code === 200) {
                    currentCity = city;
                    renderUI(data.data, city);
                } else {
                    showTips(data.msg || "未找到该城市");
                }
            } catch (err) {
                toggleToast(false);
                showTips("网络异常，请稍后重试");
            }
        }

        // --- UI 渲染 ---
        function renderUI(data, city) {
            // 基础信息
            document.getElementById('uiCity').textContent = city;
            document.getElementById('uiTemp').textContent = (data.wendu || "0") + "°";
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
            
            const today = new Date();
            const weekNames = ['周日','周一','周二','周三','周四','周五','周六'];
            document.getElementById('uiDate').textContent = `${today.getMonth()+1}月${today.getDate()}日 ${weekNames[today.getDay()]}`;

            if(data.forecast?.[0]) {
                const f0 = data.forecast[0];
                document.getElementById('uiWea').textContent = f0.type;
                document.getElementById('uiHighTemp').textContent = f0.high.replace('高温 ','');
                document.getElementById('uiLowTemp').textContent = f0.low.replace('低温 ','');
                document.getElementById('weatherNotice').textContent = f0.notice || "今日天气晴好，祝心情愉快";
                // 主图标保持白色
                document.getElementById('weatherIcon').innerHTML = getIcon(f0.type);
            }

            // 网格详情
            const grids = [
                { l: '湿度', v: data.shidu, i: 'fa-droplet' },
                { l: '空气质素', v: data.quality, i: 'fa-leaf' },
                { l: 'PM2.5', v: data.pm25, i: 'fa-mask' },
                { l: '风向', v: data.forecast[0]?.fx, i: 'fa-compass' },
                { l: '风力', v: data.forecast[0]?.fl, i: 'fa-wind' },
                { l: 'PM10', v: data.pm10, i: 'fa-smog' }
            ];
            document.getElementById('currentDetails').innerHTML = grids.map(g => `
                <div class="grid-item">
                    <div class="grid-icon"><i class="fas ${g.i}"></i></div>
                    <div class="grid-label">${g.l}</div>
                    <div class="grid-value">${g.v || '--'}</div>
                </div>
            `).join('');

            // 未来预报
            document.getElementById('forecastContainer').innerHTML = data.forecast.map(f => `
                <div class="forecast-item">
                    <div class="f-day">${f.week.replace('星期','周')}</div>
                    <div class="f-date">${f.date.split('日')[0]}日</div>
                    <div class="f-icon">${getIcon(f.type)}</div>
                    <div class="f-temp">${f.high.replace('高温 ','')}</div>
                    <div class="f-low">${f.low.replace('低温 ','')}</div>
                </div>
            `).join('');

            // 昨日回顾
            if(data.yesterday) {
                const y = data.yesterday;
                document.getElementById('yesterdayDate').innerText = `${y.ymd} ${y.week}`;
                document.getElementById('yesterdayBody').innerHTML = `
                    <div class="weui-form-preview__item"><label class="weui-form-preview__label">天气状况</label><span class="weui-form-preview__value">${y.type}</span></div>
                    <div class="weui-form-preview__item"><label class="weui-form-preview__label">气温跨度</label><span class="weui-form-preview__value">${y.low.replace('低温 ','')} / ${y.high.replace('高温 ','')}</span></div>
                    <div class="weui-form-preview__item"><label class="weui-form-preview__label">风力指数</label><span class="weui-form-preview__value">${y.fx} ${y.fl}</span></div>
                `;
            }

            // 显示切换
            document.getElementById('initialLoading').style.display = 'none';
            const $main = document.getElementById('mainContent');
            $main.style.display = 'block';
            setTimeout(() => $main.style.opacity = "1", 50);
        }

        // --- 工具函数 ---
        function getIcon(type) {
            let icon = 'fa-cloud';
            if (type.includes('晴')) icon = 'fa-sun';
            else if (type.includes('云')) icon = 'fa-cloud-sun';
            else if (type.includes('阴')) icon = 'fa-cloud';
            else if (type.includes('雨')) icon = type.includes('雷') ? 'fa-cloud-bolt' : 'fa-cloud-showers-heavy';
            else if (type.includes('雪')) icon = 'fa-snowflake';
            else if (type.includes('雾') || type.includes('霾')) icon = 'fa-smog';
            return `<i class="fas ${icon}"></i>`;
        }

        function toggleToast(show) {
            document.getElementById('loadingToast').style.display = show ? 'block' : 'none';
        }

        function showTips(msg) {
            const $tips = document.getElementById('topTips');
            $tips.innerText = msg;
            $tips.style.display = 'block';
            setTimeout(() => $tips.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
